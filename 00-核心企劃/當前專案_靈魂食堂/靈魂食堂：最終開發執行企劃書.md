

> **專案代號**: CONFITEOR  
> **版本**: V4.5 (劇本昇華版)  
> **最後更新**: 2026-01-26  
> **狀態**: ✅ Day 1-3 動態系統完成，五味數值系統實作完成，劇本昇華三痛點完成（V4.5）

---

## 📋 文件導航

本文件是**靈魂食堂專案的唯一真理來源 (Single Source of Truth)**。  
所有開發、設計、測試決策均應參考此文件。

### 快速導航

**🎯 核心機制**：
- [五味考古系統](#⚙️-核心機制：五味考古系統) - 五味映射、數值系統、延伸話題
- [三日儀式流程](#六三日儀式流程) - Day 1-3 完整流程

**🎨 設計與實作**：
- [靈魂設計](#🎨-靈魂設計-guest-1---失憶老裁縫田中太郎) - Guest 1 完整設計
- [技術架構](#🔧-技術架構-gas--line-oa) - 數據結構、跨日鎖定
- [UX 設計原則](#🎨-ux-設計原則新增-2026-01-20) - LINE 載體原生體驗

**📊 進度與決策**：
- [開發里程碑](#📋-開發里程碑) - 已完成與進行中
- [最新進展](#📝-最新進展) - V4.4 更新內容

### 核心文件連結

1. [[靈魂食堂企劃重構|完整世界觀與機制]] - 來自研究分析的完整企劃
2. [[專案實作對照表|技術實作映射]] - 企劃與代碼的橋樑
3. [[主 Backlog_2026-01-15|當前任務清單]] - P0/P1/P2 優先級
4. [[開發決策鏈|決策考古學]] - 為何從雲寶演變至此

---

## 🎯 專案核心定位

### 從「雲寶」到「靈魂食堂」的進化

| 維度       | 雲寶 (V1.0-V1.4) | 靈魂食堂 (V4.0)        |
| -------- | -------------- | ------------------ |
| **角色**   | 電子寵物           | 罪名吞噬者 (Sin-Eater)  |
| **玩家目標** | 養成陪伴           | 救贖超渡               |
| **核心玩法** | 餵食 + 聊天        | 五味診斷 + 標籤考古 + 料理治癒 |
| **時間結構** | 7 日循環          | 3 日儀式 + 跨日鎖定       |
| **情感主題** | 孤獨陪伴           | 見證告別               |
| **重玩性**  | 低 (單一角色)       | 高 (多位靈魂、不同結局)      |

---

## 🌍 世界觀：CONFITEOR 邊境食堂

### 核心設定

**地點**: 生與死交界的虛空邊境  
**建築**: 西多會修道院風格的食堂,永恆雨幕籠罩  
**玩家身份**: 罪名吞噬者 (CONFITEOR,拉丁語「我告解」)  
**職責**: 通過料理喚醒靈魂記憶,助其解開執念並前往來世

### 核心哲學：食物作為自白劑（2026-01-24 整合）

> **「每個人都有說不出口的話。食物是最後的翻譯。」**  
> **「進食是靈魂防禦最薄弱的時刻。料理是撬開心防的武器。」**

**設計靈感**：來自「偵訊室豬排飯」的典故——食物不僅是果腹之物，更是卸下心防的工具。

**機制體現**：
- **表層防禦**：靈魂初來時沉默、失憶、迷茫（如田中的「我不記得了」）
- **食物介入**：當靈魂進食時，生理上的脆弱打開了心理的缺口
- **記憶自白**：熱茶觸發「小時候的茶」→ 想起「美雪的小手」→ 說出「對不起」

**與「食罪者」的連結**：
- 玩家不是「審判者」，而是「見證者」與「食罪者」
- 「罪」不是懲罰，而是「未完成的愛」（如田中對美雪的遺憾）
- 透過料理「吃下」靈魂的遺憾，讓他們得以告解並超渡

參考：[[../../02-研究分析/靈魂告解食堂 遊戲概念延伸#3.3 偵訊機制：告解的饗宴|早期設計 P.109-125]]

### 視覺風格

- **外觀**: 哥德式深色調 (黑、深褐、鐵灰)
- **食物**: 吉卜力風格高飽和度、高光澤
- **對比**: 窗外虛空寒冷 vs. 室內爐火溫暖
- **核心元素**: 
  - 格柵 (告解室結構,隔開廚房與用餐區)
  - 藍色爐火 (煉獄之火,提煉情感)
  - 彩色玻璃窗 (繪製食材圖騰而非聖人)

參考: [[../../02-研究分析/靈魂食堂企劃重構#第二部分：邊境食堂世界觀|企劃重構 P.55-112]]

---

## ⚙️ 核心機制：五味考古系統

### 一、五味映射表 (中醫五行 × 神經美食學)

| 風味    | 五行  | 對應臟器 | 治療的負面情緒 | 敘事功能                  | 適用情境     |
| ----- | --- | ---- | ------- | --------------------- | -------- |
| **甜** | 土   | 脾/胃  | 焦慮、匱乏感  | 撫慰與接地 (Grounding)     | 驚魂未定的靈魂  |
| **酸** | 木   | 肝    | 悔恨、憤怒   | 聚焦與收斂 (Focus)         | 衝動決策導致後悔 |
| **苦** | 火   | 心    | 執著、幻想   | 清醒與瀉火 (Clarification) | 無法接受現實   |
| **辛** | 金   | 肺    | 悲傷、麻木   | 宣洩與流動 (Catharsis)     | 情感淤塞、憂鬱  |
| **鹹** | 水   | 腎    | 軟弱、失憶   | 意志與記憶 (Willpower)     | 失智、忘記姓名  |

**診斷邏輯**: 靈魂的「點餐需求」往往是表層防衛,玩家需透過觀察與對話,找出深層缺失。

範例:
- **表層**: 過勞死上班族點「高級和牛」(甜/土,追求成就)
- **深層**: 實際缺乏「梅子茶泡飯」(酸/木收斂焦慮 + 鹹/水喚醒根源記憶)

參考: [[../../02-研究分析/靈魂食堂企劃重構#第三部分：五味診斷與標籤考古系統|企劃重構 P.113-158]]

---

### 二、五味數值系統與食材解鎖敘事（V4.4 完整實作版）

#### 核心設計哲學：側寫角度，而非結局分歧

> **「不是結局的分歧，而是側寫的角度不同。」**

傳統多結局設計會讓玩家產生「沒玩到真結局」的挫敗感。我們採用**「食材解鎖敘事（Ingredient-Driven Narrative）」**：

- ❌ 不同選擇 → 不同結局（玩家焦慮「選錯了」）
- ✅ 不同食材 → 不同角度理解角色（每次都是完整體驗）

這更符合「見證者」定位——你不是在「選結局」，而是在「選擇如何理解這個人」。

---

#### 五味數值系統實作（V4.4 完成）✅

**核心機制**：
- ✅ 建立 `MEMORY_FLAVOR_MAP` 對照表（記憶標籤 → 五味數值）
- ✅ 實作 `calculateFlavorBalance()` 函數（累加所有收集記憶的五味數值）
- ✅ 實作 `determineEnding()` 函數（依據五味比例判定結局類型）
- ✅ 調整「裁縫手藝」味覺數值（甜 1→3、鹹 3→2），優化甜味路線達成條件

**五味映射邏輯**：
- **甜**（土）：撫慰與接地 → 適用驚魂未定的靈魂
- **酸**（木）：聚焦與收斂 → 適用衝動決策導致後悔
- **苦**（火）：清醒與瀉火 → 適用無法接受現實
- **辛**（金）：宣洩與流動 → 適用情感淤塞、憂鬱
- **鹹**（水）：意志與記憶 → 適用失智、忘記姓名

**數值定義**（每個標籤 0-6 分，高價值記憶可達 6 分）:

| 風味 | 代表情緒 | 累積過多的效果 | 累積不足的效果 |
|------|----------|----------------|----------------|
| 甜 | 溫暖、愛、滿足 | 過度美化，逃避現實 | 缺乏慰藉，空虛 |
| 酸 | 悔恨、反省 | 陷入自責漩渦 | 無法面對錯誤 |
| 苦 | 清醒、接受 | 過度悲觀 | 活在幻想中 |
| 辛 | 宣洩、流動 | 情緒失控 | 情感麻木 |
| 鹹 | 記憶、根源 | 困在過去 | 忘記自我 |

**計算邏輯**:
```javascript
// Day 3 結局前，計算五味總和
function calculateFlavorBalance(collectedMemories) {
  let flavors = { sweet: 0, sour: 0, bitter: 0, spicy: 0, salty: 0 };
  
  collectedMemories.forEach(memory => {
    const values = MEMORY_FLAVOR_MAP[memory];
    if (values) {
      flavors.sweet += values.sweet || 0;
      flavors.sour += values.sour || 0;
      flavors.bitter += values.bitter || 0;
      flavors.spicy += values.spicy || 0;
      flavors.salty += values.salty || 0;
    }
  });
  
  return flavors;
}
```

---

#### 田中太郎記憶標籤五味對照表（完整版）

> 每個標籤分數 0-3，總分會影響結局語氣

##### Day 1 可收集（基礎層）

| 話題 | 記憶標籤 | 甜 | 酸 | 苦 | 辛 | 鹹 | 敘事功能 |
|------|----------|----|----|----|----|----|---------| 
| 你的手 | 🪡 針 | 0 | 1 | 2 | 0 | 1 | 執念的象徵 |
| 你的手 | 🧵 縫線 | 1 | 0 | 1 | 0 | 2 | 連結的隱喻 |
| 你的手 | ❄️ 寒冷 | 0 | 2 | 2 | 1 | 0 | 死亡的觸感 |
| 你的手 | 🧤 裁縫手藝 | 1 | 0 | 1 | 0 | 3 | 一生的驕傲 |
| 你從哪裡來 | 🌫️ 失憶 | 0 | 2 | 2 | 0 | 0 | 喪失自我 |
| 你從哪裡來 | 😶 迷茫 | 0 | 1 | 2 | 1 | 0 | 困惑無助 |
| 窗外的雨 | 🌧️ 雨聲 | 0 | 0 | 1 | 1 | 1 | 氛圍鋪陳 |
| 窗外的雨 | 💧 潮濕 | 0 | 1 | 1 | 1 | 0 | 陰鬱壓抑 |
| 沉默陪伴 | 🤫 寧靜 | 1 | 0 | 1 | 0 | 1 | 平和接受 |
| 沉默陪伴 | 🤝 陪伴 | 2 | 0 | 0 | 0 | 1 | 溫暖信任 |

##### Day 2 可收集（深入層）

| 話題 | 記憶標籤 | 甜 | 酸 | 苦 | 辛 | 鹹 | 敘事功能 |
|------|----------|----|----|----|----|----|---------| 
| 那個夢 | 🍯 蜜糖笑容 | 3 | 0 | 0 | 0 | 1 | 女兒的愛（核心甜） |
| 那個夢 | 👧 女兒-美雪 | 2 | 1 | 0 | 1 | 2 | 核心牽掛（平衡） |
| 那個夢 | 💍 婚紗 | 2 | 2 | 1 | 0 | 1 | 未竟之願（苦甜交織） |
| 那個夢 | 😢 眼淚 | 0 | 1 | 1 | 3 | 0 | 情感宣洩（高辛） |
| 你在找什麼 | 🎯 執念 | 0 | 1 | 3 | 0 | 1 | 無法放下（高苦） |
| 你怎麼來的 | ❄️ 雪 | 0 | 1 | 2 | 1 | 1 | 死亡場景 |
| 你怎麼來的 | 💀 死亡 | 0 | 2 | 3 | 0 | 0 | 終結之痛（高苦+酸） |

##### 延伸話題新增記憶（V4.5 更新）⭐

| 延伸話題 | 記憶標籤 | 甜 | 酸 | 苦 | 辛 | 鹹 | 敘事功能 |
|---------|----------|----|----|----|----|----|---------| 
| 你的手延伸 | 🏆 銀座的驕傲 | 6 | 0 | 0 | 0 | 0 | 職業巔峰（高甜值） |
| 那個夢延伸 | 😊 美雪的笑容 | 6 | 0 | 0 | 0 | 0 | 父女純甜記憶（高甜值） |
| 那個夢延伸 | 👨‍👧 第一次叫爸爸 | 5 | 0 | 0 | 0 | 0 | 父女關係核心（高甜值） |
| 你怎麼來的延伸 | 🪡 最後一針 | 0 | 0 | 高 | 0 | 0 | 死亡前執念（高苦值） |
| 你怎麼來的延伸 | 🏠 閣樓 | 0 | 0 | 高 | 0 | 0 | 未完成遺憾（高苦值） |
| **V4.5 新增** | 📉 空蕩的店 | 0 | 2 | 1 | 0 | 3 | 時代孤獨（高鹹值） |
| **V4.5 新增** | 👔 缺席的典禮 | 0 | 1 | 3 | 3 | 0 | 裂痕事件（高苦辛值） |
| **V4.5 新增** | 🗣️ 失語 | 0 | 3 | 1 | 0 | 2 | 翻譯者概念（高酸鹹值） |

##### 五味總分設計邏輯

| 收集路線 | 預期五味傾向 | 可能結局 |
|----------|--------------|----------|
| 只做 Day 1 + 少量 Day 2 | 苦鹹偏高 | 普通結局（帶遺憾離去） |
| Day 1 全收 + Day 2「那個夢」完整 | 甜鹹平衡 | 真結局（釋懷離去） |
| 只收「蜜糖笑容」不收「執念」「死亡」 | 甜味過重 | 特殊結局（沉浸美好） |
| 大量收集「執念」「死亡」「寒冷」 | 苦酸爆表 | 普通結局（悲傷離去） |

---

#### 結局語氣分歧（基於五味平衡）

##### 判定邏輯（實作參考）

```javascript
// 五味數值對照表
const MEMORY_FLAVOR_MAP = {
  // Day 1
  "針":       { sweet: 0, sour: 1, bitter: 2, spicy: 0, salty: 1 },
  "縫線":     { sweet: 1, sour: 0, bitter: 1, spicy: 0, salty: 2 },
  "寒冷":     { sweet: 0, sour: 2, bitter: 2, spicy: 1, salty: 0 },
  "裁縫手藝": { sweet: 3, sour: 0, bitter: 1, spicy: 0, salty: 2 }, // V4.4 調整：甜 1→3、鹹 3→2
  "失憶":     { sweet: 0, sour: 2, bitter: 2, spicy: 0, salty: 0 },
  "迷茫":     { sweet: 0, sour: 1, bitter: 2, spicy: 1, salty: 0 },
  "雨聲":     { sweet: 0, sour: 0, bitter: 1, spicy: 1, salty: 1 },
  "潮濕":     { sweet: 0, sour: 1, bitter: 1, spicy: 1, salty: 0 },
  "寧靜":     { sweet: 1, sour: 0, bitter: 1, spicy: 0, salty: 1 },
  "陪伴":     { sweet: 2, sour: 0, bitter: 0, spicy: 0, salty: 1 },
  // Day 2
  "蜜糖笑容": { sweet: 3, sour: 0, bitter: 0, spicy: 0, salty: 1 },
  "女兒-美雪": { sweet: 2, sour: 1, bitter: 0, spicy: 1, salty: 2 },
  "婚紗":     { sweet: 2, sour: 2, bitter: 1, spicy: 0, salty: 1 },
  "眼淚":     { sweet: 0, sour: 1, bitter: 1, spicy: 3, salty: 0 },
  "執念":     { sweet: 0, sour: 1, bitter: 3, spicy: 0, salty: 1 },
  "雪":       { sweet: 0, sour: 1, bitter: 2, spicy: 1, salty: 1 },
  "死亡":     { sweet: 0, sour: 2, bitter: 3, spicy: 0, salty: 0 }
};

// 結局判定
function determineEnding(flavors) {
  const { sweet, sour, bitter, spicy, salty } = flavors;
  const total = sweet + sour + bitter + spicy + salty;
  
  // 情境 C：甜味過重（沉浸美好）
  if (sweet > (sour + bitter + spicy + salty)) {
    return "ENDING_SWEET"; // 特殊結局
  }
  
  // 情境 A：苦味過重（帶遺憾）
  if (bitter > (sweet + salty)) {
    return "ENDING_BITTER"; // 普通結局
  }
  
  // 情境 B：回甘平衡（釋懷）
  if ((sweet + salty) >= (bitter + sour)) {
    return "ENDING_BALANCED"; // 真結局
  }
  
  // 預設：普通結局
  return "ENDING_BITTER";
}
```

##### 結局演出文本

**情境 A：苦味過重 → 帶遺憾離去（普通結局）**
> 【老人低下頭】
> 「我...終究是個失敗的父親吧。」
> 「那件婚紗...她大概永遠也找不到了...」
> 
> 【他的身影開始變得透明】
> 「...美雪，對不起。」
> 
> *遺物：一根彎曲的縫紉針*

**情境 B：回甘平衡 → 釋懷離去（真結局）**
> 【老人突然睜大眼睛】
> 「我想起來了...」
> 「最後一針...我縫好了。」
> 
> 【他微笑著】
> 「美雪...婚紗在閣樓。爸爸做好了。」
> 「穿上去一定很美。」
> 
> *遺物：銀頂針（刻字：For my dearest Miyuki）*

**情境 C：甜味過重 → 沉浸美好（特殊結局）**
> 【老人的眼神變得柔和】
> 「美雪小時候笑起來好可愛...」
> 「她喜歡穿我做的洋裝，在院子裡轉圈圈...」
> 
> 【他閉上眼睛，嘴角上揚】
> 「...等等，我好像忘了什麼...」
> 「算了...現在這樣就很好...」
> 
> *遺物：一張泛黃的照片（父女合照）*

---

### 三、縱向延伸話題系統（V4.5 更新）⭐

#### 設計理念

**核心概念**：深挖角色深度，而非橫向擴展
- 玩家視角：不知道角色背景，只能透過追問逐步挖掘
- 避免上帝視角：不直接告訴玩家「這是田中太郎，他是裁縫師」
- 層層剝開：從表層對話 → 延伸追問 → 深層記憶

#### Day 1 延伸話題

**「你的手」→「那…這雙手做過最驕傲的事是什麼？」**（`hands_pride`）
- 解鎖條件：完成 `hands_part2` 後出現
- 獲得記憶：`銀座的驕傲`（甜 6）
- 劇情意義：從「手的功能」深挖到「手的意義」，揭示田中職業生涯的巔峰
- 五味傾向：強烈甜味（撫慰與接地）

**V4.5 新增：「你的手」→「後來呢？」**（`twilight_artisan`）
- 解鎖條件：完成 `hands_part2` 後出現
- 獲得記憶：`空蕩的店`（鹹 3, 酸 2, 苦 1）
- 劇情意義：從「職業榮耀」深挖到「時代淘汰」，解釋他為何退縮到閣樓
- 五味傾向：高鹹值（時代孤獨感）
- 核心台詞：「這雙手以前被很多人需要。但現在...連穿針都會抖，也沒人願意等了。」

#### Day 2 延伸話題

**「那個夢」→「夢裡那個小女孩…她小時候是什麼樣子？」**（`miyuki_childhood`）
- 解鎖條件：完成 `dream_part3` 後出現
- 獲得記憶：`美雪的笑容`（甜 6）、`第一次叫爸爸`（甜 5）
- 劇情意義：從「夢境」深挖到「美雪的童年」，強化父女關係的情感連結
- 五味傾向：強烈甜味（父女純甜記憶）

**V4.5 新增：「那個夢」→「為什麼她會哭？」**（`ceremony_rift`）
- 解鎖條件：完成 `dream_part3` 後出現
- 獲得記憶：`缺席的典禮`（苦 3, 辛 3, 酸 1）
- 劇情意義：揭示父女決裂的「原爆點」——入學典禮缺席事件
- 五味傾向：高苦辛值（罪惡感與悔恨）
- 核心台詞：「那件西裝很完美。但我永遠失去了我最重要的觀眾。」

**「你怎麼來的」→「你說有很多雪…那時候你原本在做什麼？」**（`snow_then`）
- 解鎖條件：完成 `death` 話題後出現
- 獲得記憶：`最後一針`、`閣樓`（高苦值）
- 劇情意義：從「死亡場景」深挖到「死亡前的最後時刻」，揭示田中的執念
- 五味傾向：高苦值（聚焦死亡前的遺憾與未完成）

#### Day 2 料理增強（V4.5 新增）

**撫慰鹹粥 → 翻譯者概念**
- 觸發條件：做撫慰鹹粥時自動觸發
- 新增記憶：`失語`（酸 3, 鹹 2, 苦 1）
- 劇情意義：揭示妻子雪子是田中的「翻譯介面」，她走後他失去表達愛的能力
- 核心台詞：「別擔心，我會幫你翻譯的。你的針線話，我都聽得懂。」
- 結尾文本：「然而，翻譯的人走了。剩下一個啞巴父親，和一個聽不懂針線話的女兒。」

---

### 四、橫向劇情發展：甜/苦路線設計（V4.5 更新）

#### 甜味過重路線（重新定義）

**路線組成**：`沉默陪伴` + `那個夢` + `關於美雪小時候`（延伸話題）

**調整內容**：
- 避免「你的手」話題（五味混合，不易達成甜味過重）
- 聚焦「沉默陪伴」的寧靜感、「那個夢」的溫暖、「美雪小時候」的純甜記憶
- 配方調整：`熱茶` 配方擴展為接受 `寧靜` + `陪伴` 記憶，讓「沉默陪伴」路線可在 Day 1 完成料理

**設計目標**：讓玩家更容易達成甜味過重結局，體驗「沉浸美好」的特殊結局

#### 苦味過重路線（新設計）

**路線組成**：`你怎麼來的` + `雪中那時…`（延伸話題）

**記憶標籤**：`最後一針`、`閣樓`（高苦值）

**劇情意義**：聚焦死亡前的遺憾與未完成

**設計目標**：讓玩家體驗「帶遺憾離去」的普通結局，感受田中的執念與未完成

#### 結局判定邏輯

**保持 `determineEnding()` 原始邏輯**：
- `sweet > others` 判定甜味結局
- `bitter > (sweet + salty)` 判定苦味結局
- `(sweet + salty) >= (bitter + sour)` 判定平衡結局

**設計理念**：內容引導 > 邏輯限制
- 不改變判定條件，而是透過調整話題內容與記憶數值
- 讓玩家更容易達成特定路線
- 透過內容設計引導玩家自然走向特定結局

---

#### 層次化記憶揭露（目前實作狀態）

設計讓玩家有「逐漸理解」的感覺，而非一次性倒出所有資訊：

##### Day 1 話題（基礎層）- ✅ 已實作

| 話題 | 觸發文字 | 獲得食材 | 五味傾向 |
|------|----------|----------|----------|
| 你的手 | 「你的手...是做什麼工作的？」 | 針、縫線、寒冷、裁縫手藝 | 苦鹹為主 |
| 你從哪裡來 | 「你是從哪裡來的？」 | 失憶、迷茫 | 苦酸為主 |
| 窗外的雨 | 「外面的雨...很大呢」 | 雨聲、潮濕 | 苦辛平衡 |
| 沉默陪伴 | 「...（不說話，靜靜陪伴他）」 | 寧靜、陪伴 | 甜鹹為主 |

##### Day 2 話題（深入層）- ✅ 已實作

| 話題 | 觸發文字 | 獲得食材 | 五味傾向 | 備註 |
|------|----------|----------|----------|------|
| 那個夢 | 「你夢到了什麼？」 | 蜜糖笑容、女兒-美雪、婚紗、眼淚 | 甜辛平衡 | 分 3 段推進 |
| 你在找什麼 | 「你在找什麼？」 | 執念、婚紗 | 苦為主 | - |
| 你怎麼來的 | 「你是怎麼來到這裡的？」 | 雪、死亡、寒冷 | 苦酸為主 | - |

##### 未來規劃：話題前置條件（V5.0）

目前所有話題都是開放的，未來可加入前置條件增加深度：

```
Day 2 隱藏話題（未實作）:
- 【隱藏】那個人 → 需前置：Day 1 選擇「沉默陪伴」
- 【隱藏】最後一天 → 需前置：收集「針」+「縫線」+「婚紗」
```

這讓田中太郎像個「活人」——他會因為你的聆聽態度，決定要吐露多少真相。

---

### 五、食材收集機制（MVP vs 未來版對照）

#### MVP 實作方式（目前 V4.x）

> **設計原則**：簡化互動，聚焦敘事體驗

| 階段 | 機制 | 說明 |
|------|------|------|
| **對話期** | 話題選擇 → 自動獲得食材 | 完成話題後系統自動收集記憶標籤 |
| **料理期** | 預設配方 | 根據收集的食材，系統自動建議料理 |
| **結局** | 五味數值計算 | 根據標籤的五味總和，決定結局語氣 |

**MVP 優點**：
- 開發快速，體驗順暢
- 核心「側寫角度」效果已可實現
- 適合 LINE OA 純對話介面

---

#### 未來擴展：LIFF 標籤考古系統（V5.0+ 規劃）

> ⚠️ **此章節為未來擴展規劃，非目前實作範圍**

如果想要更豐富的「標籤考古」體驗，可透過 LIFF（LINE Front-end Framework）實現：

##### 採集機制（需 LIFF）
1. **對話高亮**: 靈魂台詞中的關鍵字以特殊顏色標示
2. **點擊採集**: 玩家在 LIFF 頁面中點擊關鍵字，拖拉至背包
3. **雜訊過濾**: 部分高亮是「防衛性謊言」，採集會導致料理失敗

範例對話:
```
靈魂: "那年冬天的【雪】下得很大,但我心裡卻有一團【火】。"
可採集標籤: ["cold", "anger/heat"]
```

##### 合成機制（需 LIFF）
進入 LIFF 廚房頁面後，玩家將標籤放入三個插槽:
1. **基底 (Base)**: 料理型態 (米飯/麵條/湯)
2. **調味 (Flavor)**: 五味屬性 (對應診斷結果)
3. **火候 (Heat)**: 時間處理 (慢燉/快炒/冰鎮)

合成範例:
```
Tag: Childhood (Sweet/Base) 
  + Tag: Regret (Sour/Flavor) 
  + Tag: Long Wait (Simmer/Heat)
→ 【回憶苦甜燉肉】(Bittersweet Stew)
```

##### LIFF 頁面功能規劃
```
LIFF 標籤考古系統
├── 📖 對話閱讀頁
│   ├── 高亮關鍵字顯示
│   ├── 點擊採集動畫
│   └── 背包即時更新
├── 🎒 背包管理頁
│   ├── 已收集標籤列表
│   ├── 五味數值雷達圖
│   └── 標籤詳情與故事提示
├── 🍳 廚房合成頁
│   ├── 三插槽拖拉介面
│   ├── 配方預覽
│   └── 烹飪動畫
└── 📊 結局統計頁
    ├── 五味平衡分析
    └── 解鎖成就
```

##### 開發優先級
- **P3**（低優先）：待 MVP 驗證成功後再評估
- **預估工時**：2-3 週（前端 + 後端整合）
- **前置條件**：MVP 留存率 > 60%、用戶反饋希望更多互動

參考: [[../../01-開發實驗/專案實作對照表#三、recipeDatabase Sheet|實作對照表 - 料理合成規則]]

---

### 六、三日儀式流程

#### Day 1: 誘捕 (The Lure)
**目標**: 破冰,建立信任  
**玩法**: 
- 靈魂進場,狀態混亂/防衛/失憶
- 玩家選擇基礎食物 (熱茶/湯/麵包)
- 觀察靈魂反應,採集「感官標籤」(溫暖/柔軟/鹹味等)

**階段結束條件**: 收集 3+ 個感官標籤

---

#### Day 2: 偵訊 (The Feast)
**目標**: 解鎖核心記憶  
**玩法**:
- 系統根據 Day 1 標籤組合,解鎖「記憶劇場」(Flex Carousel)
- 靈魂開始回憶生前片段
- 玩家繼續採集「情感標籤」(悔恨/執念/愛/遺憾)
- 解鎖「目標料理」

**階段結束條件**: 
- 標籤組合觸發記憶 (例: `["warmth", "softness"]` → 奶奶的羊肉湯)
- `unlockedRecipe` 欄位寫入料理 ID

---

#### Day 3: 赦免 (The Absolution)
**目標**: 完成料理,送別靈魂  
**玩法**:
- 進入廚房,使用收集的標籤合成料理
- 烹飪成功 → 靈魂記憶完整重現,安詳離去
- 烹飪失敗 → 靈魂困惑,需重試或接受「普通結局」

**結局分支**:
- **完美結局**: 標籤 ≥ 5 個 + 料理成功 → 獲得特殊遺物
- **普通結局**: 標籤 3-4 個 + 料理成功 → 靈魂離去,無特殊獎勵
- **失敗結局**: 料理失敗 → 靈魂繼續困於食堂 (可重試 Day 3)

**超渡演出**:
- 靈魂化為光點飄向窗外
- 吧台留下「遺物」(Heirloom)
- 系統記錄至 `completedGuests` 與 `heirlooms`

參考: [[../../02-研究分析/靈魂食堂企劃重構#第四部分：三日敘事範例|企劃重構 P.163-212 - 失憶老裁縫案例]]

---

## 🔧 技術架構 (GAS + LINE OA)

### 核心資料結構: userState (6 欄位 - 簡化版)

**實作決策**: 基於畫鬼腳 MVP v1.0 架構擴展，採用簡化的 6 欄位系統以加速開發。

| 欄位  | 變數名                 | 資料型態        | 企劃概念         | 範例值                              |
| --- | ------------------- | ----------- | ------------ | -------------------------------- |
| A   | `userId`            | String      | LINE User ID | `U1234567890abcdef`              |
| B   | `currentDay`        | Integer     | 當前天數 (1-3) | `2`                              |
| C   | `phase`             | Enum        | 當前時段         | `night` / `day` / `cooking` / `after` |
| D   | `collectedMemories` | JSON Array  | 收集的記憶食材        | `["寒冷","針","縫線","蜜糖笑容"]`          |
| E   | `topicsDone`        | JSON Array  | 已完成的話題       | `["hands","dream"]`            |
| F   | `lastActive`        | Timestamp   | 最後活躍時間       | `2026-01-20T10:00:00`            |

**未來擴展** (10 欄位完整版，V5.0 規劃):
- G: `guestID` - 多靈魂切換
- H: `unlockedRecipe` - 複雜料理系統
- I: `completedGuests` - 遺物收藏系統
- J: `lifetimeHeirlooms` - 累計成就系統

### 跨日鎖定機制 (宿命感設計)

```javascript
function canProgressToNextDay(userId) {
  const userState = getUserState(userId);
  const lastActive = new Date(userState.lastActive);
  const now = new Date();
  const daysDiff = Math.floor((now - lastActive) / (1000 * 60 * 60 * 24));
  
  if (IS_DEBUG_MODE) return { canProgress: true };
  
  if (daysDiff < 1 && userState.currentDay > 1) {
    return {
      canProgress: false,
      reason: "今天的故事已經結束了。靈魂需要時間沉澱...明天再來吧。☁️"
    };
  }
  
  return { canProgress: true };
}
```

### 標籤驅動對話引擎

```javascript
function findMatchingDialogue(guestID, day, userTags) {
  const library = getDialogueLibrary();
  const prefix = `${guestID}_day${day}_`;
  
  // 遍歷所有對話,找出符合標籤條件的最佳匹配
  for (let key in library) {
    if (!key.startsWith(prefix)) continue;
    
    const entry = library[key];
    const requiredTags = JSON.parse(entry.required_tags || "[]");
    
    const hasAllTags = requiredTags.every(tag => userTags.includes(tag));
    if (hasAllTags) return entry;
  }
  
  return library[`${guestID}_day${day}_default`];
}
```

詳細映射: [[專案實作對照表|專案實作對照表]]

---

## 🎨 靈魂設計: Guest 1 - 失憶老裁縫（田中太郎）

### 角色檔案

- **真實姓名**: 田中太郎（Day 2 揭露）
- **生前職業**: 銀座一流西裝裁縫
- **死因**: 阿茲海默症引發的雪地失溫
- **核心創傷**: 完成女兒婚紗後失憶走失，誤以為一事無成
- **三層創傷結構**:
  - 表層：在雪山中凍死（寒冷、迷茫）
  - 中層：忘記重要的事（焦慮、懊悔）
  - 深層：未能完成對女兒的愛（自責、渴望救贖）
- **生命軌跡**: 30-60歲榮耀職人 → 60-70歲產業衰退決定贖罪 → 70-78歲失智中仍堅持完成

### 重構版劇本架構（V3.0）

#### 核心機制: 記憶即食材系統
```
對話關鍵詞 → 自動解鎖食材 → 用於料理 → 喚醒記憶

範例:
田中: "她笑起來...像蜜糖..."
系統: [記憶碎片：蜜糖般的笑容] 已收集
      → 廚房解鎖：🍯 蜂蜜（抽象食材）
```

#### 儀式化循環: 四時段結構
```
🌙 Night Shift (觀察期)
→ 客人進門，點擊互動點獲取線索

🌅 Day Shift (對話期)  
→ 話題選單（類紅弦俱樂部），套取情報

🍳 Cooking Time (料理期)
→ 用收集的記憶食材做料理

🌃 After Hours (揭露期)
→ 記憶劇場觸發，黑貓評論
```

#### 設計原則
- **去說教化**: 黑貓不解釋，玩家自己體會
- **去中二化**: 拿掉「罪惡吞食者」等詞，用主廚/食堂/客人
- **延遲揭露**: Day 1 玩家也困惑，Day 3 才揭曉真相
- **台詞生動化**: 正常對話完整流暢，記憶閃現保持碎片

#### 黑貓角色: 懶洋洋的老油條店長貓
```
定位: 聒噪但有用的引路者
台詞風格: 
- 「嘖。」「廢話，剛來的都這樣。」
- 「煮飯給他吃啊。不然你以為食堂是幹嘛的？擺好看的嗎？」
動作: 打哈欠、舔爪子、甩尾巴、伸懶腰
```

#### Day 1-3 完整流程

**Day 1: 迷途者與食堂**
- Night: 田中進門，觀察指尖針孔痕跡
- Day: 話題選擇「你的手」，解鎖「針」「縫線」標籤
- Cooking: 用「寒冷+熱水+茶葉」做熱茶
- After Hours: 記憶碎片「小小的手捧著茶杯」

**Day 2: 碎片拼圖**
- Day: 話題選擇「那個夢」，解鎖「女兒-美雪」「蜜糖笑容」
- Cooking: 「蜜糖笑容+遺憾眼淚+蜂蜜+鹹魚」做燉菜
- After Hours: 記憶劇場全面開啟，想起女兒婚禮

**Day 3: 真相與告別**
- Cooking: 所有食材合成「蜜汁炙燒鹹魚」
- 揭露: 田中想起「最後一針縫好了」，安詳離去
- 遺物: 銀頂針（*For my dearest Miyuki*）

### 完整劇本文件

**當前版本**: 
- 檔案: `../../02-劇本設計/Guest1_田中太郎_重構版_神秘感優先.md`
- 行數: 1712 行（完整可直接實裝）
- 狀態: ✅ 劇本完成，台詞已優化
- 更新日期: 2026-01-19

**實作狀態**:
- [x] 完整故事線設計
- [x] 記憶即食材系統設計
- [x] 儀式化循環設計
- [x] 台詞生動化調整
- [x] ✅ **轉換為代碼實作完成** (2026-01-20)
  - 代碼文件: `01-開發實驗/程式碼/靈魂食堂_田中太郎重構版.gs`
  - 代碼行數: ~1200 行
  - 部署指南: `01-開發實驗/程式碼/田中太郎版部署指南.md`

---

## 🚨 與舊版本的決裂宣言

### 為何必須放棄「雲寶」?

| 問題 | V1.4 的困境 | V4.0 的解決 |
|------|-----------|-----------|
| **產品裂縫** | 電子寵物+日記的雙重期待無法調和 | 明確定位為「敘事遊戲」 |
| **技術債務** | 3 欄數據無法支撐複雜機制 | 10 欄數據 + 輔助 Sheets |
| **重玩性低** | 單一角色、劇情重複 | 多位靈魂、不同結局 |
| **缺乏目標** | 養成無終點,玩家易流失 | 3 日完整弧線,清晰目標 |


---

## 📋 開發里程碑

### ✅ Week 3 (2026-01-15~19): 架構穩定化與劇本深化
- [x] 深度診斷與架構分析
- [x] 建立開發決策鏈文件
- [x] 建立專案實作對照表
- [x] 重構程式碼（6 欄數據結構）
- [x] 實作跨日檢查邏輯
- [x] 畫鬼腳 MVP 部署完成
- [x] **撰寫 Guest 1 完整劇本（重構版）**
- [x] **設計記憶即食材系統**
- [x] **設計儀式化循環結構**
- [x] **完成台詞生動化調整**

### ✅ Week 4 Day 1 (2026-01-20): 實裝與測試
- [x] **將田中太郎重構版實裝到代碼**（P0 優先）✅ 完成
  - [x] 記憶即食材系統實作（~2500 行代碼）
  - [x] 話題選單系統實作（Postback 機制）
  - [x] 時段系統實作（Night→Day→Cooking→After）
  - [x] Day 1-3 完整流程實作
  - [x] 黑貓角色互動實作
- [x] 撰寫部署指南文檔
- [x] **部署到 GAS 進行真實環境測試** ✅ 完成
- [x] 發現並修正階段推進 Bug
- [x] UX 問題診斷與改進方案設計

### ✅ Week 4 Day 2 (2026-01-21): UX 優化完成
- [x] **P0：互動方式優化 + Loading Animation**（實際 4hr）
  - [x] Loading Animation 全面覆蓋（35 處）
  - [x] Message Action 導入（話題選擇）
  - [x] 修正 4 個關鍵 Bug
- [x] **P1：玩家輸入系統**（實際 2hr）
  - [x] 話題選擇改為 Message Action
  - [x] 創造左右交錯視覺節奏
  - [x] 提升帶入感
- [x] **Day 1 動態話題系統**（實際 3hr）✨ **重大突破**
  - [x] 多次對話收集食材系統
  - [x] 動態按鈕顯示（完成話題自動隱藏）
  - [x] 完成話題後回到選擇畫面
  - [x] 動態顯示廚房食材
  - [x] 大幅提升重玩價值與開放度

### 🔄 Week 4 Day 3+ (2026-01-21~): 動態系統擴展
- [x] **P0：Day 2-3 動態話題系統擴展**（預估 4-6hr）
  - [x] Day 2 改造為動態系統（3 個話題）
  - [x] Day 3 動態食材顯示
  - [x] 全面測試與優化
- [x] **P2：劇情分段呈現優化**（預估 2-3hr）
  - [x] Day 2「那個夢」已分段 ✅
  - [x] Day 1 其他話題分段優化
  - [x] Day 3 真相揭露分段

### Week 5+: 擴充與優化
- [ ] 根據測試結果優化機制
- [ ] 建立 Guest 2-3 劇本（使用田中太郎模板）
- [ ] 實作 LIFF 烹飪小遊戲原型（可選）
- [ ] 進行封閉測試（5-10 名玩家）

詳細任務: [[../../00-工作區/主 Backlog_2026-01-15|主 Backlog]]

---

## 🎯 成功指標

### 定性指標 (情感深度)
- 測試者是否在告別時感到「不捨但釋然」?
- 是否有測試者主動分享遺物卡片?
- 是否有「我想再見一次那位靈魂」的反饋?

### 定量指標 (留存與完成度)
- **Day 1 → Day 2 留存率**: 目標 > 70%
- **Day 2 → Day 3 留存率**: 目標 > 60%
- **完整通關率**: 目標 > 50%
- **平均標籤採集數**: 目標 ≥ 4 個
- **料理成功率**: 目標 > 80%

---

## 📚 相關資源

### 企劃與研究
- [[../../02-研究分析/靈魂食堂企劃重構|完整企劃重構文件]]
- [[../../02-研究分析/企劃書與Bird Alone結合探討|Bird Alone 情感機制分析]]
- [[../../04-資源素材/技術成本_非即時制設計的優勢|非即時制設計哲學]]

### 技術實作
- [[專案實作對照表|敘事-代碼映射表]]
- [[程式碼.gs|當前代碼 (V1.4)]] - ⚠️ 需重構

### 決策追溯
- [[開發決策鏈|決策考古學]]

---

## 🔥 立即行動

**如果你是首次接觸本專案**, 請按此順序閱讀:
1. 本文件 (Overview)
2. [[../../02-研究分析/靈魂食堂企劃重構|企劃重構]] (世界觀與機制)
3. [[專案實作對照表|實作對照表]] (如何開發)

**如果你要繼續開發**, 請查看:
- [[主 Backlog_2026-01-15|主 Backlog]] (當前任務)
- [[架構診斷報告_2026-01-15|診斷報告]] (解決方案)

---

**專案信念**:

> 「在數據流中重構人性。」  
> 「見證,而非審判。」  
> 「溫暖,但具有重量。」

---

## 🎨 UX 設計原則（新增 2026-01-20）

### LINE 載體的原生體驗設計

**核心理念**：善用 LINE 聊天的獨特性，而非把它當成「網頁的替代品」

#### 原則 1：玩家輸入 = 玩家行動

**設計**：
- 凡是「我」（主廚）說的話，用「玩家訊息」（系統代發）
- 創造「玩家在說話」的錯覺

**好處**：
1. **帶入感**：綠色聊天框 = 我說的話，強化角色扮演
2. **視覺節奏**：左（系統敘事）右（玩家行動）交錯
3. **降低卡片長度**：對話可以拆出來

**範例**：
```
[玩家訊息] 你的手...是做什麼工作的？
[官方訊息] 【老人慢慢抬起手，盯著指尖】
[官方訊息] 「我的手...有很多小洞。」
```

#### 原則 2：立即反饋 > 精美卡片

**設計**：
- 卡片按鈕改為 Quick Reply 或 Message
- 點擊後立即顯示玩家訊息（0 延遲）
- 官方回應可以稍後生成

**好處**：
1. **消除等待感**：按了立即有反應
2. **更像真實對話**：訊息出現而非卡片出現
3. **降低焦慮感**：確認點擊成功

#### 原則 3：分段 = 呼吸感

**設計**：
- 長劇情用多條訊息分段呈現
- 創造「電影分鏡」感

**好處**：
1. **降低認知負荷**：一次只讀一小段
2. **創造節奏感**：訊息逐條出現
3. **情感醞釀**：停頓點讓情緒沉澱
4. **可以更細膩**：不怕內容長

**範例**：
```
[訊息 1] 【老人望向窗外，聲音很輕】
[訊息 2] 「我夢到...一個小女孩。」
[訊息 3] 「她笑起來...很甜。像蜜糖一樣甜。」
[Flex Card] 【記憶碎片閃現】
```

#### 原則 4：動態話題系統（2026-01-22 新增）✨

**設計**：
- 玩家可以多次選擇不同話題收集食材
- 完成的話題自動隱藏按鈕
- 完成任意話題後顯示「進入廚房」
- 廚房根據收集的食材動態顯示內容

**好處**：
1. **重玩價值提升**：可以嘗試不同話題組合
2. **開放度增加**：不再線性，更像開放世界
3. **收集樂趣**：多種食材組合可能性
4. **玩家主導**：自己決定何時進入廚房

**範例流程**：
```
Day Shift 10:00
    ├─ 你的手 → 獲得：針、縫線、寒冷
    ├─ 你從哪裡來 → 獲得：失憶、迷茫
    ├─ 窗外的雨 → 獲得：雨聲、潮濕
    └─ 沉默陪伴 → 獲得：寧靜、陪伴
         ↓
    完成話題後可隨時進入廚房
         ↓
Cooking Time（顯示所有收集的食材）
```

### UX 改進優先級

| 優先級 | 改進項目 | 預估工時 | 預期效果 | 狀態 |
|-------|---------|---------|---------|------|
| **P0** | Loading + Message Action | 2-3 小時 | 立即反饋，消除等待感 | ✅ 完成 |
| **P1** | 玩家輸入 = 玩家台詞 | 3-4 小時 | 帶入感提升 50% | ✅ 完成 |
| **P1+** | 動態話題系統（Day 1） | 3 小時 | 重玩價值質變 | ✅ 完成 |
| **P2** | 劇情分段呈現 | 4-6 小時 | 閱讀體驗質變 | 🔄 進行中 |
| **P3** | Day 2-3 動態系統 | 4-6 小時 | 全面開放化 | 📋 待開始 |

---

## 📝 最新進展

### 🎉 Week 4 Day 2 重大突破（2026-01-21）

**完成事項**:
1. ✅ **Loading Animation 全面覆蓋**
   - 修正 LINE API 格式（loadingSeconds 必須是 5 的倍數）
   - 所有 input 加入 Loading Animation（35 處）
   - 消除等待感，提升體驗

2. ✅ **關鍵 Bug 修正**
   - 觀察他沒有 Loading → 已修正
   - 話題選擇沒有對話形式 → 改用 Message Action
   - 進入廚房條件過嚴 → 已放寬
   - 做熱茶卡住 → 修正訊息數量限制

3. ✅ **Day 1 動態話題系統**（重大突破 ✨）
   - 多次對話收集食材機制
   - 動態按鈕顯示（完成話題自動隱藏）
   - 完成話題後回到選擇畫面
   - 動態顯示廚房食材
   - 4 個話題可選擇：你的手、你從哪裡來、窗外的雨、沉默陪伴
   - 大幅提升重玩價值與開放度

**技術架構更新**:
- 代碼行數：~3,488 行（+300 行）
- 新增動態函數：`getDay1DayShift(state)`, `getDay1CookingScene(state)`
- 新增 3 個話題支線（每個話題獲得不同食材）

**下一步**: 擴展到 Day 2-3，完成全面動態化

### 🎉 Week 4 Day 1 重大突破（2026-01-20）

**完成事項**:
1. ✅ **田中太郎重構版代碼實作完成**
   - 完整可部署代碼：~1200 行
   - Day 1-3 全流程實作完成
   - 時段系統：Night → Day → Cooking → After Hours
   - 記憶即食材系統完整實作
   - 話題選單系統（Postback 機制）
   - 黑貓角色全程互動

2. ✅ **部署指南文檔完成**
   - 詳細部署步驟
   - 測試流程說明
   - 與畫鬼腳 MVP 的差異對照
   - 常見問題 FAQ

3. ✅ **技術架構確定**
   - 選定方案 A：基於畫鬼腳 MVP v1.0 擴展
   - 6 欄位數據結構（簡化版）
   - Sheet 名稱：`userStateTanaka`

### Week 3 重大里程碑（2026-01-15~19）

1. ✅ 畫鬼腳 MVP 部署成功（1/18）
2. ✅ 田中太郎劇本深化完成（1/19）
   - 兩個完整版本（MVP擴充版、重構版）
   - 記憶即食材系統設計
   - 儀式化循環結構
   - 台詞生動化全面調整（1712行）
3. ✅ 所有核心設計決策完成

### 關鍵文件更新

| 文件 | 最新版本 | 更新內容 |
|------|---------|---------|
| 田中太郎代碼 | V4.4 五味料理版 | ~4,231行 + 五味系統 + 縱向延伸話題 |
| 部署指南 | V1.0 | 完整部署與測試文檔 |
| 田中太郎劇本 | MVP v3.0 重構版 | 1713行完整劇本 + 台詞優化 |
| 工作報告 | 2026-01-25 | 五味系統與劇情深化完成 |
| 本企劃書 | V4.4 | 五味數值系統 + 縱向延伸話題 |

### 專案檔案位置

- **代碼**: `01-開發實驗/程式碼/靈魂食堂_田中太郎_五味料理版.gs`
- **部署指南**: `01-開發實驗/程式碼/部署與開發指南.md`
- **劇本**: `02-劇本設計/Guest1_田中太郎_重構版_神秘感優先.md`
- **工作報告**: `00-工作區/工作報告_2026-01-25_五味系統與劇情深化完成.md`

---

**文件狀態**: 🟢 Active  
**最後更新**: 2026-01-25  
**維護者**: 專案負責人  
**下次回顧**: 全面測試完成後

