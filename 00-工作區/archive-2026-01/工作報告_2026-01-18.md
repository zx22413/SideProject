# 工作報告：2026-01-18（週日）

> **今日重點**：完成畫鬼腳 MVP 測試版部署，解決 LINE Bot + Google Sheets 整合問題  
> **工作時長**：約 4-5 小時  
> **下次接續**：討論完整文本設計、生成 9 個結局文案

---

## 📋 今日決策摘要

### 1. 確立測試方向：「畫鬼腳」簡化模型
- **為什麼**：原本 V4.0 系統太複雜，難以測試完整對話流程
- **決策**：先做一版「畫鬼腳」（Amidakuji）簡化版，3 天 × 3 選項 = 9 種結局
- **目的**：快速驗證對話體驗，再決定要加什麼功能

### 2. 定義文字遊戲類型差異
- **畫鬼腳式**（JRPG）：固定分支路徑，選擇直接決定結局
- **標籤累積式**（WRPG）：選擇累積影響力，綜合計算結局
- **本專案定位**：「畫鬼腳 + 裝飾性標籤」，MVP 先用固定路徑，未來可擴展

### 3. 選擇測試策略
- 不用 Postman / 自動化測試
- 直接用 LINE OA 實測，更貼近真實使用情境

---

## ✅ 今日完成事項

### 1. 生成畫鬼腳 MVP 完整代碼
- **檔案**：`01-開發實驗/程式碼/靈魂食堂_畫鬼腳MVP.gs`
- **功能**：
  - 3 天劇情（Day 1 → Day 2 → Day 3 結局）
  - 9 種路徑組合（A/B/C × X/Y/Z）
  - 裝飾性標籤系統（#溫暖、#針線、#女兒 等）
  - 5 種主要結局（2 個完美結局 + 7 個普通結局）
  - Flex Message 卡片 UI
  - Quick Reply 按鈕選項

### 2. 解決多個 GAS 部署問題
| 問題 | 原因 | 解決方案 |
|------|------|----------|
| 403 Forbidden | 部署權限設定錯誤 | 改為「任何人（包括匿名）」 |
| doGet 找不到 | 缺少 doGet 函數 | 新增 doGet 函數 |
| 302 Found | 程式碼執行錯誤導致重定向 | 加入 events 陣列檢查 |
| Sheets 連接失敗 | 使用 getActiveSpreadsheet | 改為 openById |
| SPREADSHEET_ID 未定義 | 遺漏變數宣告 | 新增 const 定義 |
| pathCode 無法更新 | 空字串判斷邏輯錯誤 | 修正 `!state.pathCode` → 只檢查 `!state` |
| Day 1 按鈕不顯示 | 無效輸入時只回純文字 | 改為重新顯示完整選項介面 |

### 3. 完成 Google Sheets 整合
- **新建 Sheets**：`靈魂食堂_測試`
- **Sheets ID**：`1204bJ1DWPWidrYCJlfXF9rnmyyS8vwqFWI9YZuItsoc`
- **欄位結構**：userId | pathCode | lastActiveDay
- **功能驗證**：用戶狀態可正確讀寫 ✅

### 4. 完成 LINE Bot 對話測試
- Day 1 → Day 2 → Day 3 結局：**全流程跑通** ✅
- Flex Message 卡片：**顯示正常** ✅
- Quick Reply 按鈕：**運作正常** ✅
- 「重新開始」指令：**可正確重置** ✅

---

## ⚠️ 未解決 / 待處理事項

### 1. LINE Webhook 驗證仍失敗（302 Found）
- **影響**：僅影響 LINE 後台的「Verify」按鈕，不影響實際使用
- **原因**：可能是 LINE 驗證請求格式與實際訊息不同
- **處理方式**：暫時忽略，功能正常即可

### 2. 完整文本尚未討論
根據截圖，待討論項目：
- [ ] 生成完整 GAS 代碼（可直接複製貼上）
- [ ] 生成 9 個結局的完整文案（Markdown 格式）
- [ ] 生成 Flex Message JSON（Day 1-3 的所有卡片）
- [ ] 建立測試檢查清單（Notion 或 Markdown）

### 3. 其他待完成功能
- [ ] 剩餘 4 個結局的 Flex Message（目前只有簡化版純文字）
- [ ] 完整的故事文案（Mr. Needle 的背景故事）
- [ ] 標籤顯示優化（目前只是裝飾，未來可串連料理系統）

---

## 📁 今日產出檔案

| 檔案 | 路徑 | 說明 |
|------|------|------|
| 畫鬼腳 MVP 代碼 | `01-開發實驗/程式碼/靈魂食堂_畫鬼腳MVP.gs` | 2239 行完整代碼 |
| 代碼版本說明 | `01-開發實驗/程式碼/README_代碼版本說明.md` | V4.0 vs MVP 對照 |
| 本工作報告 | `00-工作區/工作報告_2026-01-18.md` | 今日總結 |

---

## 🔗 專案狀態總覽

### Week 3 進度更新（2026-01-15 ~ 2026-01-22）

| 任務 | 狀態 | 備註 |
|------|------|------|
| 重構程式碼.gs | ✅ 完成 | 1/16 完成 |
| 跨日檢查邏輯 | ✅ 完成 | 1/16 完成 |
| 標籤持久化 | ✅ 完成 | 1/16 完成 |
| 動態台詞檢索 | ✅ 完成 | 1/16 完成 |
| **畫鬼腳 MVP 部署** | ✅ 完成 | **1/18 完成（新增）** |
| Guest 1 劇本 | 🔄 進行中 | 文本待討論 |
| 優化標籤驅動 | 📋 待開始 | MVP 完成後再處理 |

---

## 🎯 下一步行動（明天進公司）

### 優先順序

1. **討論完整文本設計**
   - 確認 Mr. Needle 的完整故事（為什麼來食堂？婚紗的故事？）
   - 確認 9 個結局的情感基調
   - 討論標籤如何影響對話內容

2. **生成內容資產**
   - 9 個結局的完整文案
   - 所有 Flex Message 的 JSON
   - 測試檢查清單

3. **（可選）優化現有功能**
   - 補齊剩餘 4 個結局的 Flex Message
   - 加入更多關鍵字觸發（如「喝茶」→ 路徑 A）

---

## 💡 今日學習 / 經驗

1. **GAS 部署版本機制**：每次改代碼都要「部署 → 新版本」，否則舊版本繼續運行
2. **JavaScript falsy 值**：空字串 `""` 是 falsy，`!"" === true`，要小心判斷條件
3. **LINE Webhook 驗證**：驗證請求可能沒有 events 陣列，需要額外處理
4. **Sheets 權限**：使用 `openById()` 比 `getActiveSpreadsheet()` 更可靠

---

**撰寫人**：Claude AI  
**審核人**：專案負責人  
**下次更新**：2026-01-19（明日進公司後）

