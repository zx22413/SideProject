# 📝 Cloudy V1.4 開發紀錄：2026-01-12

> [!abstract] 今日里程碑
> **日期**：2026-01-12  
> **版本**：V1.4 (Bird Alone 模式)  
> **階段**：技術底層打通 → 核心機制實作完成  
> **關聯專案**：[[MVP 企劃：3日陪伴實驗_Bird Alone模式]]

> [!success] 深度開發完成
> **2026-01-12 晚間更新**：核心機制 A & B 已實作完成，對話桶系統、快速回覆、標籤記憶系統、圖文選單與歡迎訊息全部上線。

---

## 🎯 今日完成項目

### ✅ 技術底層打通

#### 1. LINE Messaging API 串接成功
- ✅ 完成 `doPost()` 函數實作
- ✅ 成功接收 LINE Webhook 事件
- ✅ 正確解析 `userId` 和 `replyToken`
- ✅ 實作 `replyToLine()` 函數，可回覆訊息給用戶

#### 2. Google Apps Script (GAS) 權限授權解決
- ✅ 解決 `SpreadsheetApp` 權限授權問題
- ✅ 成功連接到 Google Sheets
- ✅ 實作 `setup()` 函數觸發權限審核流程

#### 3. Google Sheets 資料庫架構建立
- ✅ 試算表結構定義完成：
  - `userId` (Column A) - 用戶唯一識別碼
  - `day` (Column B) - 當前天數 (1-3)
  - `currentMood` (Column C) - 當前情緒狀態
  - `tags` (Column D) - 記憶標籤（逗號分隔）
  - `lastInteraction` (Column E) - 最後互動時間

#### 4. 用戶狀態初始化邏輯
- ✅ 實作用戶識別邏輯（根據 `userId` 查找現有記錄）
- ✅ 新用戶自動初始化為 Day 1
- ✅ 現有用戶正確讀取 `day` 計數器
- ✅ 成功更新 `lastInteraction` 時間戳記

---

### ✅ 核心機制實作完成（深度開發）

#### 機制 A：對話桶系統 (Dialogue Bucket System) ✅
- ✅ **從試算表動態讀取**：實作 `getDialogueLibrary()` 函數，從 `dialogueLibrary` 分頁讀取所有台詞
- ✅ **靈活管理**：台詞不再硬編碼在程式碼中，改為從 Google Sheets 管理
- ✅ **隨機選取邏輯**：從對應的對話桶中隨機選擇一條回應
- ✅ **防呆機制**：如果找不到對應對話桶，使用預設回應

**試算表結構**：
- 分頁名稱：`dialogueLibrary`
- Column A：對話鍵值（如：`day1_feed_happy`、`day1_chat_A_res`）
- Column B：對話內容

#### 機制 B：標籤記憶系統 (Tag Memory System) ✅
- ✅ **標籤寫入**：當用戶回答選擇題時，自動在 Sheets 的 `tags` 欄位（Column D）寫入對應標籤
- ✅ **標籤提取邏輯**：
  - 「全部拌在一起！」→ 標籤「拌拌派」
  - 「醬飯要分開。」→ 標籤「分開派」
- ✅ **狀態更新**：同時更新 `lastInteraction` 時間戳記

#### 快速回覆 (Quick Reply) 系統 ✅
- ✅ **餵食快速回覆**：實作 `sendFeedQuickReply()` 函數
  - 三個選項：開心 ☀️、難過 💧、生氣 🌶️
  - 使用 `[餵食-開心]` 格式標記用戶選擇
- ✅ **聊天快速回覆**：實作 `sendChatQuickReply()` 函數
  - 根據 `day` 動態讀取選擇題（`day${currentDay}_chat_q`）
  - 兩個選項：全部拌在一起！、醬飯要分開。
  - 使用 `[聊天-全部拌在一起！]` 格式標記用戶選擇

#### 情緒處理流程 ✅
- ✅ **情緒映射**：實作 `moodMap`（開心→happy、難過→sad、生氣→angry）
- ✅ **狀態更新**：更新 Sheets 的 `currentMood` 欄位（Column C）
- ✅ **對話匹配**：根據 `day${currentDay}_feed_${moodKey}` 匹配對應對話桶

#### 選擇題系統 ✅
- ✅ **動態問題**：根據 `day` 讀取對應選擇題（`day${currentDay}_chat_q`）
- ✅ **選擇處理**：解析 `[聊天-...]` 格式，提取用戶選擇
- ✅ **回應匹配**：根據選擇匹配對應回應（`day${currentDay}_chat_A_res` 或 `day${currentDay}_chat_B_res`）

---

### ✅ 視覺與介面設計完成

#### 圖文選單 (Rich Menu) ✅
- ✅ **1x3 圖文選單設計完成**：包含「餵食」、「聊天」、「狀態」三個按鈕
- ✅ **已上傳 LINE 後台**：圖文選單已設定並啟用
- ✅ **觸發邏輯**：用戶點擊按鈕會發送對應文字訊息（「餵食」、「聊天」）

#### 歡迎訊息 ✅
- ✅ **加入好友歡迎訊息設定完成**：符合「雲寶」幼兒語氣的歡迎訊息
- ✅ **功能導覽**：包含直覺的功能說明，引導用戶使用圖文選單

---

## 📊 目前數據狀態

### 測試結果
- ✅ **連線測試成功**：雲寶已能正確讀寫試算表
- ✅ **用戶識別成功**：系統能正確識別 `userId`
- ✅ **初始化成功**：新用戶自動建立記錄，`day` 設為 1
- ✅ **狀態讀取成功**：現有用戶能正確讀取 `day` 值

### 目前程式碼結構
```javascript
// 核心函數
- doPost(e)                    // LINE Webhook 處理（完整流程）
- getDialogueLibrary()         // 從試算表讀取對話庫 ⭐ 新增
- sendFeedQuickReply()         // 餵食快速回覆選單 ⭐ 新增
- sendChatQuickReply()         // 聊天快速回覆選單 ⭐ 新增
- postToLine()                 // LINE API 統一發送函數 ⭐ 新增
- replyToLine()                // LINE API 回覆（簡化版）
- doGet(e)                     // 測試用
- setup()                       // 權限觸發
```

### 對話庫試算表結構確認 ✅

**分頁名稱**：`dialogueLibrary`

| Column | 欄位名稱 | 資料型態 | 範例 | 說明 |
|:------|:--------|:--------|:-----|:-----|
| A | key | String | `day1_feed_happy` | 對話鍵值（唯一識別） |
| B | content | String | `耶——！是甜甜的！...` | 對話內容 |

**鍵值命名規則**（已實作）：
- **餵食回應**：`day{day}_feed_{mood}`
  - 範例：`day1_feed_happy`、`day1_feed_sad`、`day1_feed_angry`
  - 程式碼位置：`doPost()` 第 73 行 `const resKey = \`day${currentDay}_feed_${moodKey}\`;`
- **聊天問題**：`day{day}_chat_q`
  - 範例：`day1_chat_q`、`day2_chat_q`、`day3_chat_q`
  - 程式碼位置：`doPost()` 第 57 行 `const qKey = \`day${currentDay}_chat_q\`;`
- **聊天回應**：`day{day}_chat_{choice}_res`
  - 範例：`day1_chat_A_res`、`day1_chat_B_res`
  - 程式碼位置：`doPost()` 第 90 行 `const resKey = \`day${currentDay}_chat_${choiceKey}_res\`;`

**程式碼邏輯確認** ✅：
- ✅ `getDialogueLibrary()` 函數正確讀取試算表（第 7-22 行）
- ✅ 支援同一鍵值多個內容（陣列結構）
- ✅ 隨機選取邏輯正確：`bucket[Math.floor(Math.random() * bucket.length)]`
- ✅ 防呆機制：找不到對話桶時使用預設回應
- ✅ 鍵值匹配邏輯符合試算表結構

> [!info] 程式碼位置
> 程式碼已歸檔至：`01-開發實驗/程式碼/程式碼.gs`  
> 詳見 [[程式碼/README]] 了解安全注意事項

---

## 🚧 技術待辦清單 (Backlog)

### Phase 1: 核心互動機制

#### [x] 圖文選單實作 ✅ **2026-01-12 完成**
- ✅ 1x3 圖文選單設計完成並上傳 LINE 後台
- ✅ 三個按鈕：「餵食」、「聊天」、「狀態」
- ✅ 觸發邏輯：用戶點擊按鈕發送對應文字訊息
- ✅ 歡迎訊息設定完成（符合雲寶幼兒語氣）

#### [x] 對話桶系統 (Dialogue Bucket System) ✅ **2026-01-12 完成**
- ✅ 實作 `getDialogueLibrary()` 函數，從 `dialogueLibrary` 分頁讀取
- ✅ 台詞從硬編碼轉向試算表動態管理
- ✅ 實作隨機選取邏輯：`bucket[Math.floor(Math.random() * bucket.length)]`
- ✅ 防呆機制：找不到對應對話桶時使用預設回應

#### [x] 標籤系統 (Tag System) ✅ **2026-01-12 完成**
- ✅ 實作標籤寫入邏輯：`userSheet.getRange(userRow, 4).setValue(tag)`
- ✅ 處理選擇題結果：解析 `[聊天-...]` 格式，提取標籤
- ✅ 標籤映射：「全部拌在一起！」→「拌拌派」、「醬飯要分開。」→「分開派」
- [ ] 標籤讀取邏輯：`getUserTags(userId)` → 返回標籤陣列（待實作，用於記憶觸發）

#### [x] 情緒選擇流程 ✅ **2026-01-12 完成**
- ✅ 實作 `sendFeedQuickReply()` 函數
- ✅ 快速回覆選單：開心 ☀️、難過 💧、生氣 🌶️
- ✅ 處理用戶選擇：解析 `[餵食-開心]` 格式，更新 `currentMood` 欄位
- ✅ 對話匹配：根據 `day${currentDay}_feed_${moodKey}` 匹配對話桶

#### [x] 選擇題系統 ✅ **2026-01-12 完成**
- ✅ 實作 `sendChatQuickReply()` 函數
- ✅ 動態問題：根據 `day` 讀取 `day${currentDay}_chat_q`
- ✅ 兩個選項：全部拌在一起！、醬飯要分開。
- ✅ 處理用戶選擇：提取標籤並存入 `tags` 欄位
- ✅ 回應匹配：根據選擇匹配 `day${currentDay}_chat_A_res` 或 `day${currentDay}_chat_B_res`

### Phase 2: 記憶系統

#### [ ] 記憶觸發邏輯（標籤觸發對話）
- **任務描述**：
  - 實作 `checkMemoryTriggers(userId, day)` 函數
  - Day 2-3 時，根據 `tags` 匹配對應的記憶對話
  - 例如：如果 `tags` 包含「拌拌派」→ 匹配 `day2_memory_bunbun`
  - 在餵食/聊天回應中，隨機插入記憶對話
  - **目標**：讓雲寶在 Day 2 能說出「主人昨天說你是拌拌派對吧？」之類的感人台詞
- **對應程式碼位置**：新增 `checkMemoryTriggers()` 函數，整合到 `doPost()` 中
- **試算表鍵值**：`day2_memory_bunbun`、`day2_memory_separate` 等

#### [ ] Day 計數器自動更新
- **任務描述**：
  - 實作 `updateDay(userId)` 函數
  - 根據 `lastInteraction` 判斷是否跨天
  - 如果跨天且 `day < 3`，自動 `day++`
  - 如果 `day == 3`，觸發結局流程
- **對應程式碼位置**：新增 `updateDay()` 函數，在 `doPost()` 開頭呼叫

### Phase 3: 外部網頁

#### [ ] HTML Service 實作
- **任務描述**：
  - 使用 GAS 的 `HtmlService.createTemplateFromFile()` 建立外部網頁
  - 設計 HTML 結構（參考企劃書的 HTML 範例）
  - 實作 URL 參數解析：`?userId=xxx` 或 `?day=1&mood=happy&tags=拌拌派`
  - 從 Sheets 讀取用戶狀態，動態渲染雲寶樣貌
- **對應程式碼位置**：新增 `doGet()` 的 HTML 回傳邏輯，新增 `index.html` 檔案

#### [ ] 視覺動態效果
- **任務描述**：
  - 實作 CSS 動畫（根據 `mood` 變色、根據 `day` 變形）
  - 實作 JavaScript 狀態讀取（從 URL 參數或 Sheets API）
  - 顯示進度條（Day X/3）
  - 顯示記憶標籤
- **對應程式碼位置**：`index.html` 中的 CSS 和 JavaScript

#### [ ] 外部網頁連結生成
- **任務描述**：
  - 實作 `generateStatusUrl(userId)` 函數
  - 生成 GAS Web App 的公開 URL
  - 當用戶點擊「查看狀態」時，回傳此連結
- **對應程式碼位置**：新增 `generateStatusUrl()` 函數

### Phase 4: 推播系統

#### [ ] 定時推播設定
- **任務描述**：
  - 使用 GAS 的 `Time-driven triggers` 設定每天定時推播
  - 實作 `sendDailyPush()` 函數
  - 根據 `day` 決定推播文案（參考企劃書的推播文案）
  - 使用 LINE Messaging API 的 `pushMessage` 功能
- **對應程式碼位置**：新增 `sendDailyPush()` 函數，設定 GAS 觸發器

---

## 📝 技術筆記

### 目前程式碼架構
```
程式碼.gs
├── doPost(e)              // LINE Webhook 入口
│   ├── 解析事件
│   ├── 讀取/寫入 Sheets
│   └── 回覆訊息
├── replyToLine()          // LINE API 回覆
├── doGet(e)               // 測試/外部網頁入口
└── setup()                // 權限觸發
```

### 試算表結構 (userState Sheet)
| Column | 欄位名稱 | 資料型態 | 說明 |
|:------|:--------|:--------|:-----|
| A | userId | String | LINE 用戶 ID |
| B | day | Number | 當前天數 (1-3) |
| C | currentMood | String | 當前情緒 (happy/sad/angry) |
| D | tags | String | 記憶標籤（逗號分隔，如："拌拌派,放空派"） |
| E | lastInteraction | Date | 最後互動時間 |

### 下一步優先順序
1. **高優先級**：圖文選單實作、對話桶系統、情緒選擇流程
2. **中優先級**：選擇題系統、標籤系統、記憶觸發邏輯
3. **低優先級**：外部網頁、推播系統

---

## 🔗 相關連結

- [[MVP 企劃：3日陪伴實驗_Bird Alone模式]] - 核心企劃文件
- [[角色設定：雲寶]] - 角色設定與語氣參考
- [[企劃書與Bird Alone結合探討]] - 技術架構參考
- [[程式碼/README]] - 程式碼歸檔說明

---

## 📦 程式碼歸檔

**位置**：`01-開發實驗/程式碼/`

- `程式碼.gs` - Google Apps Script 程式碼備份（含安全警告）
- `userState_備份_2026-01-12.csv` - 測試數據備份
- `README.md` - 檔案說明與安全建議

> [!warning] 注意
> 程式碼包含敏感資訊（LINE Token、Google Sheets ID），已加入 `.gitignore` 保護

---

## 📋 明日預計任務 (2026-01-13)

### [ ] 劇情深度化
- **任務描述**：
  - 設計 Day 2 與 Day 3 的劇情轉折
  - 豐富對話庫變體：目標每種情緒 10-15 句
  - 確保對話符合「雲寶」幼兒語氣（參考 [[角色設定：雲寶]]）
- **試算表更新**：
  - 新增 `day2_feed_*`、`day2_chat_*` 對話桶
  - 新增 `day3_feed_*`、`day3_chat_*`、`day3_ending_*` 對話桶
  - 新增記憶對話：`day2_memory_bunbun`、`day2_memory_separate` 等

### [ ] 狀態機視覺設計
- **任務描述**：
  - 規劃雲寶的「成長形態」邏輯
  - 設計 Day 1 → Day 2 → Day 3 的視覺變化：
    - Day 1：小圓球（基礎形態）
    - Day 2：長出手手（成長形態）
    - Day 3：最終變形（根據選擇決定：星星 / 雨水 / 彩虹）
  - 根據 `mood` 變色：開心→金黃色，難過→深藍灰色，生氣→暗紅色
- **產出**：視覺設計規格文檔（用於外部網頁開發）

### [ ] 外部網頁 (index.html) 開發
- **任務描述**：
  - 開始實作 GAS HtmlService
  - 建立 `index.html` 檔案
  - 實作 URL 參數解析：`?userId=xxx` 或 `?day=1&mood=happy&tags=拌拌派`
  - 從 Sheets 讀取用戶狀態，動態渲染雲寶樣貌
  - 讓「查看狀態」按鈕能真正開啟網頁看到雲寶的顏色與形狀變化
- **對應程式碼位置**：新增 `doGet()` 的 HTML 回傳邏輯，新增 `index.html` 檔案

### [ ] 標籤觸發對話（記憶讀取）
- **任務描述**：
  - 實作 `checkMemoryTriggers(userId, day)` 函數
  - 讀取用戶的 `tags` 欄位
  - Day 2-3 時，根據標籤匹配對應的記憶對話
  - 在餵食/聊天回應中，隨機插入記憶對話
  - **目標範例**：雲寶在 Day 2 能說出「主人昨天說你是拌拌派對吧？」
- **對應程式碼位置**：新增 `checkMemoryTriggers()` 函數，整合到 `doPost()` 中
- **試算表鍵值**：`day2_memory_bunbun`、`day2_memory_separate` 等

---

**狀態**：🟢 執行中  
**最後更新**：2026-01-12（深度開發完成）

