# 靈魂食堂 - 結局變體系統完成報告

> **日期**：2026-01-27  
> **類型**：開發 + 計畫調整  
> **狀態**：✅ 已完成，已部署
> **版本**：V4.6（結局變體版）

---

## 📋 今日工作總結

### ✅ 已完成

#### 1. 結局變體系統完整實作

**核心設計理念**：採用「模組化堆疊（Modular Stacking）」而非「乘法爆炸」

- 3 個結局骨架（苦/甜/平）+ 4 個變體插件（銀座/缺席/失語/空蕩）+ 全收集專屬
- 程式碼會自動把變體「依序講出來」或「觸發全收集專屬對話」

---

#### 2. 結局名稱動態化（18 種）

| 變體 | 苦味結局 | 甜味結局 | 平衡結局 |
|------|----------|----------|----------|
| 預設（無變體）| 帶遺憾離去 | 溫柔的夢境 | 釋懷的旅程 |
| 銀座的驕傲 | 職人的輓歌 | 銀座的殘夢 | 傳承的針線 |
| 缺席的典禮 | 缺席的代價 | 扭曲的記憶 | 遲來的出席 |
| 失語 | 無聲的懺悔 | 翻譯者的幻影 | 針線的語言 |
| 空蕩的店 | 時代的棄子 | 凝固的時光 | 最後的訂單 |
| **全收集** | **職人的一生** | **永遠的閣樓** | **完整的告別** |

---

#### 3. 黑貓評論動態化（18 種）

黑貓作為「觀眾代言人」，給出有深度的總結評論。

**範例**：
- 苦味 + 缺席：「缺席了一次，就缺席了一輩子。有些錯，沒有重來的機會。」
- 甜味 + 缺席：「他把那天改寫了。也許是自我欺騙，也許是自我救贖。誰知道呢。」
- 平衡 + 全收集：「他把一生都攤開了。銀座、典禮、雪子、那間店...全都記起來了。能這樣離開，是福氣。」

---

#### 4. 遺物描述動態化（18 種）

| 變體 | 苦味結局 | 甜味結局 | 平衡結局 |
|------|----------|----------|----------|
| 缺席的典禮 | 那一年的缺席，成了永遠無法縫合的傷口。 | 入學典禮的合照。那天陽光很好，我們都很開心。 | 遲到了十五年的出席。這一次，爸爸沒有缺席。 |
| **全收集** | **一生的重量，都在這根針上。它撐不住了。** | **他帶走了所有美好的記憶。剩下的，就留在這裡吧。** | **職人、父親、丈夫。這根針，縫起了他的一生。** |

---

#### 5. 告別對話模組化堆疊

```
【開頭骨架】→ 【變體層/全收集專屬】→ 【結尾骨架】
```

- **一般情況**：變體對話會依序堆疊（如同時有銀座+缺席，兩段都會講出來）
- **全收集（>= 3 個變體記憶）**：觸發專屬對話，取代所有變體對話

---

#### 6. 最終章動態引言

`getDay3EndingFlexCard(state)` 支援根據變體記憶顯示不同引言：
- 銀座的驕傲：「這是我這輩子，最完美的作品。」
- 缺席的典禮：「這一次，爸爸沒有遲到。」
- 失語：「不用翻譯了。這就是我想說的話。」
- 空蕩的店：「這間店最後的作品，獻給最重要的人。」

---

## 📊 代碼變更統計

| 類別 | 數量 |
|------|------|
| 新增函數 | 4 個（getEndingName、getHeirloomDesc、getCatComment、buildFarewellBody） |
| 重構函數 | 2 個（getDay3Farewell、getDay3EndingFlexCard） |
| 結局名稱文案 | 18 種 |
| 黑貓評論文案 | 18 種 |
| 遺物描述文案 | 18 種 |
| 告別對話文案 | 15 種（4 變體 × 3 結局 + 全收集 × 3 結局） |
| 新增行數 | +300 行 |

**代碼總行數**：~4,350 行 → **~4,650 行**（結局變體版）

---

## 🧪 測試路線

### 必測組合（9 種）

| 測試路線 | 結局 | 變體 | 預期結局名稱 | 預期黑貓評論關鍵詞 |
|----------|------|------|--------------|-------------------|
| A | 苦 | 缺席的典禮 | 缺席的代價 | 「缺席了一次，就缺席了一輩子」 |
| B | 甜 | 缺席的典禮 | 扭曲的記憶 | 「他把那天改寫了」 |
| C | 平 | 缺席的典禮 | 遲來的出席 | 「遲到十五年，但到了」 |
| D | 苦 | 銀座的驕傲 | 職人的輓歌 | 「縫不住自己的家」 |
| E | 平 | 銀座的驕傲 | 傳承的針線 | 「這叫傳承吧」 |
| F | 苦 | 失語 | 無聲的懺悔 | 「連對不起都來不及」 |
| G | 平 | 全收集 | 完整的告別 | 「能這樣離開，是福氣」 |
| H | 苦 | 全收集 | 職人的一生 | 「每一個身份都有遺憾」 |
| I | 甜 | 無變體 | 溫柔的夢境 | 「他走的時候，是笑著的」 |

### 全收集判定條件

變體記憶數量 >= 3 時觸發全收集專屬內容：
- 專屬對話（取代所有變體對話）
- 專屬結局名稱
- 專屬黑貓評論
- 專屬遺物描述

---

## 🔗 受影響的核心文件

- [[../../00-核心企劃/當前專案_靈魂食堂/靈魂食堂：最終開發執行企劃書]] - 更新至 V4.6（結局變體版）
- [[../../01-開發實驗/專案實作對照表]] - 新增函數映射
- [[../../.cursor/PROJECT_ARCHITECTURE]] - 新增進度記錄
- [[../../README]] - 更新版本號與已完成項目

---

## 📚 相關文件

### 修改文件
- `01-開發實驗/程式碼/靈魂食堂_田中太郎_五味料理版.gs` - 主代碼（V4.6 更新）

### 新增函數
- `getEndingName(endingType, memories, isFullCollection)` - 結局名稱動態化
- `getHeirloomDesc(endingType, memories, isFullCollection)` - 遺物描述動態化
- `getCatComment(endingType, memories, isFullCollection)` - 黑貓評論動態化
- `buildFarewellBody(endingType, memories, isFullCollection)` - 告別對話模組化堆疊

### 前置報告
- [[工作報告_2026-01-26_劇本昇華三痛點完成]] - V4.5 劇本昇華

---

## 📋 Backlog 計畫調整

### 優先級重新定義

| 優先級 | 原本 | 調整後 |
|--------|------|--------|
| **P1** | 標籤組合邏輯、Guest 2 | V4.6 測試、Flex 優化、封閉測試 |
| **P2** | LIFF、Rich Menu | **Rich Menu（含圖鑑系統）** |
| **P3** | 遺物系統、隱藏解鎖 | **標籤組合邏輯**、Guest 2（App 階段）|

### MVP 範圍明確化

**包含**：
- Guest 1 完整體驗（田中太郎 V4.6）
- Rich Menu（人物紀傳/食材庫/遺物圖鑑/說明）
- 基本圖鑑系統

**不包含（移至 App 階段）**：
- Guest 2+ 劇本
- 隱藏靈魂解鎖機制
- 數據分析儀表板

### Rich Menu 規劃（4 功能）

```
┌───────────┬───────────┐
│   📖      │    🍳     │
│  人物紀傳  │   食材庫   │
├───────────┼───────────┤
│   🎁      │    ❓     │
│  遺物圖鑑  │   說明    │
└───────────┴───────────┘
```

---

## 🎯 下一步行動

### 立即行動
1. ~~**部署測試**：將更新後的程式碼部署到 Google Apps Script~~ ✅ 已完成
2. **全路線測試**：按照測試路線 A-I 驗證所有變體組合
3. **Bug 修正**：根據測試反饋修正問題

### 中期計劃（P2）
1. Rich Menu 設計與實作
2. 食材/遺物/人物說明系統
3. Flex Message 視覺優化

### 長期計劃（App 階段）
1. Guest 2 劇本撰寫
2. 隱藏靈魂解鎖機制
3. 數據分析儀表板

---

## 📚 新增文件

- `01-開發實驗/程式碼/測試路線表_V4.6結局變體系統.md` - 9 條測試路線詳細操作步驟

---

**報告人**：AI Assistant  
**報告時間**：2026-01-27  
**狀態**：✅ 結局變體系統全部完成，已部署  
**當前進度**：等待測試驗證

#tier2/追蹤
