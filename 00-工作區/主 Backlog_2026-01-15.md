# 主 Backlog：靈魂食堂專案任務清單

> **最後更新**：2026-01-30  
> **當前 Sprint**：MVP 收尾階段（Week 5, Jan-Feb 2026）  
> **專案狀態**：✅ V4.10 Day 1-3 料理演出動態化完成，待測試  
> **MVP 範圍**：Guest 1 完整體驗（田中太郎）+ Rich Menu + 圖鑑系統 + 動態料理  
> **參考文件**：[[架構診斷報告_2026-01-15]] | [[工作報告_2026-01-29_Day3動態料理系統完成]]

---

## 🔴 P0：本週必做（架構穩定化）

### ✅ 已完成
- [x] 深度診斷與架構分析
- [x] 建立開發決策鏈文件
- [x] 建立靈魂考古 3 日邏輯鏈
- [x] 建立專案實作對照表
- [x] 拆解 AI 對談紀錄為原子筆記
- [x] **重構程式碼.gs：實作 6 欄位數據結構**（✅ 2026-01-16 完成）
  - [x] 實作 `getUserState()` 與 `saveUserState()` 函數（支援 JSON 陣列）
  - [x] 6 欄位結構：userId, currentDay, currentMood, collectedTags (JSON), lastActive, phase
  - [x] 新玩家初始化時 `collectedTags` 為空陣列 `[]`
  - [x] `collectedTags` 持久化為 JSON 字串格式
- [x] **實作跨日鎖定機制**（✅ 2026-01-16 完成）
  - [x] 新增 `canProgress()` 函數（黃昏旅店機制）
  - [x] 在 `doPost()` 開頭強制檢查
  - [x] 實作 `IS_DEBUG_MODE` 開關（測試時可跳過檢查）
  - [x] 自動跨日推進邏輯（日期變更時自動 `currentDay += 1`）
- [x] **實作標籤持久化機制**（✅ 2026-01-16 完成）
  - [x] 聊天選擇累加存入 `collectedTags`，不覆蓋舊標籤
  - [x] 標籤格式：`{mood}_{choice}`（如 `Sweet_全部拌在一起！`）
  - [x] 去重機制（避免重複標籤）
- [x] **實作動態台詞檢索**（✅ 2026-01-16 完成）
  - [x] `findDialogue()` 函數根據 `(day, mood, phase)` 複合條件檢索
  - [x] 支援多層級 fallback 機制（完全匹配 → 部分匹配 → 預設）
- [x] **畫鬼腳 MVP 測試版部署**（✅ 2026-01-18 完成）
  - [x] 建立簡化版測試模型（3 天 × 3 選項 = 9 結局）
  - [x] LINE Bot + Google Sheets 整合
  - [x] Flex Message 卡片 UI
  - [x] Quick Reply 按鈕選項
  - [x] 用戶狀態讀寫（pathCode 追蹤）
  - [x] 完整流程測試通過（Day 1 → Day 2 → Day 3 結局）
  - **檔案**：`01-開發實驗/程式碼/靈魂食堂_畫鬼腳MVP.gs`

### ✅ 已完成（Week 3）
- [x] **完成田中太郎劇本深化**（✅ 2026-01-19 完成）
  - [x] 創建兩個完整劇本版本（MVP擴充版、重構版）
  - [x] 設計記憶即食材系統
  - [x] 設計儀式化循環（觀察→對話→料理→揭露）
  - [x] 黑貓角色定位優化（老油條店長貓）
  - [x] 全劇本台詞生動化調整（1712行）
  - [x] 開場方案最終決策（方案A神秘版）
  - **檔案**：`02-劇本設計/Guest1_田中太郎_重構版_神秘感優先.md`

### ✅ 已完成（Week 4 Day 1: 2026-01-20）
- [x] **實裝田中太郎重構版到代碼**（✅ 完成，實際 4-5hr）
  - [x] 將劇本轉換為 GAS 代碼結構（~2500 行）
  - [x] 實作記憶即食材系統（collectedMemories + topicsDone）
  - [x] 實作話題選單（Postback 機制）
  - [x] 實作時段系統（Night→Day→Cooking→After）
  - [x] 6 欄位數據結構（userId, currentDay, phase, collectedMemories, topicsDone, lastActive）
  - **檔案**：`01-開發實驗/程式碼/靈魂食堂_田中太郎重構版.gs`

- [x] **部署與測試**（✅ 完成，實際 2hr）
  - [x] 部署到 GAS 成功
  - [x] Day 1-3 完整流程測試通過
  - [x] 發現並修正階段推進 Bug（handleDay1Cooking, handleDay2Cooking）
  - [x] 撰寫部署指南
  - **檔案**：`01-開發實驗/程式碼/田中太郎版部署指南.md`

- [x] **UX 問題診斷與改進方案設計**（✅ 完成，實際 1-2hr）
  - [x] 診斷三大問題（資訊過載、節奏單調、互動延遲）
  - [x] 設計三大改進方案（玩家輸入、快速回覆、分段呈現）
  - [x] 優先級排序（P0-P3）
  - [x] 明日工作規劃
  - **檔案**：`00-工作區/工作報告_2026-01-20.md`

### ✅ 已完成（Week 4 Day 2: 2026-01-22）
- [x] **P0: 互動方式優化 + Loading Animation**（實際 4hr）
  - [x] Loading Animation 全面加入（35 處）
  - [x] Message Action 導入（話題選擇）
  - [x] 修正 4 個關鍵 Bug
  - **完成日**：2026-01-22

- [x] **P1: 玩家輸入系統導入**（實際 2hr）
  - [x] 話題選擇改為 Message Action
  - [x] 創造左右交錯視覺節奏
  - [x] 提升帶入感
  - **完成日**：2026-01-22

- [x] **Day 1 動態話題系統**（實際 3hr）✨ **重大突破**
  - [x] 多次對話收集食材系統
  - [x] 動態按鈕顯示（已完成話題自動隱藏）
  - [x] 完成話題後回到選擇畫面
  - [x] 動態顯示廚房食材
  - **完成日**：2026-01-22

### ✅ 已完成（Week 4 Day 3+: 2026-01-23）
- [x] **P0: Day 2-3 動態話題系統擴展**（實際 6hr）✅ **完成**
  - [x] Day 2 改造為動態系統（3 個話題）
  - [x] Day 3 動態食材顯示
  - [x] 8 個 Bug 修正（含競爭條件、LINE API 訊息限制）
  - [x] 安全機制強化（防連點、phase 檢查）
  - **完成日**：2026-01-23

- [x] **P2: 劇情分段呈現優化**（預估 2-3hr）
  - [x] Day 2「那個夢」場景已分段 ✅
  - [x] Day 1 其他話題分段優化
  - [x] Day 3 真相揭露場景分段
  - **負責人**：開發者
  - **截止日**：2026-01-23

### ✅ 已完成（Week 4 Day 5: 2026-01-25）
- [x] **五味數值系統完整實作**（實際 4hr）✅ **完成**
  - [x] `MEMORY_FLAVOR_MAP` 完整配置（20+ 記憶標籤）
  - [x] `calculateFlavorBalance()` 函數實作
  - [x] `determineEnding()` 結局判定邏輯
  - [x] 三種結局：甜味過重 / 苦味過重 / 平衡
  - **完成日**：2026-01-25

- [x] **縱向延伸話題系統**（實際 3hr）✅ **完成**
  - [x] Day 1「你的手」延伸（裁縫記憶深化）
  - [x] Day 2「那個夢」延伸（女兒美雪記憶）
  - [x] Day 2「你怎麼來的」延伸（雪夜最後一針）
  - **完成日**：2026-01-25

- [x] **人物紀傳撰寫**（實際 2hr）✅ **完成**
  - [x] `田中太郎_人生紀實.md`（1,127 行）
  - [x] `田中太郎_人生紀實整合建議.md`（634 行）
  - [x] `田中太郎劇情流程圖.md`（427 行）
  - **完成日**：2026-01-25

### ✅ 已完成（Week 4 Day 6: 2026-01-26）
- [x] **V4.5 劇本昇華三痛點**（實際 5hr）✅ **完成**
  - [x] 翻譯者概念：撫慰鹹粥增強（雪子作為溝通介面）
  - [x] 裂痕事件：Day 2 延伸話題 `ceremony_rift`（缺席的典禮）
  - [x] 時代孤獨：Day 1 延伸話題 `twilight_artisan`（空蕩的店）
  - [x] 新增 3 個記憶標籤：`失語`、`缺席的典禮`、`空蕩的店`
  - [x] 版本號更新：V4.4 → V4.5
  - **完成日**：2026-01-26

- [x] **全路線測試通過**（實際 2hr）✅ **完成**
  - [x] 苦味結局測試通過
  - [x] 甜味結局測試通過
  - [x] 平衡結局測試通過
  - [x] 新標籤五味數值驗證
  - **完成日**：2026-01-26

### ✅ 已完成（Week 4 Day 7: 2026-01-27）
- [x] **V4.6 結局變體系統**（實際 4hr）✅ **完成**
  - [x] 結局名稱動態化（18 種：3 預設 + 4 變體 × 3 結局 + 全收集 × 3）
  - [x] 黑貓評論動態化（18 種觀眾代言人式評論）
  - [x] 遺物描述動態化（18 種）
  - [x] 告別對話模組化堆疊（開頭骨架 + 變體層/全收集專屬 + 結尾骨架）
  - [x] 全收集專屬設計（變體記憶 >= 3 時觸發專屬對話/名稱/評論）
  - [x] 最終章動態引言（根據變體記憶顯示不同引言）
  - [x] 版本號更新：V4.5 → V4.6
  - **完成日**：2026-01-27

### ✅ 已完成（Week 5 Day 1: 2026-01-28）⭐ 最新
- [x] **V4.7 敘事修復與圖鑑系統**（實際 2hr）✅ **完成**
  - [x] 新增 `getTruthMonologue(endingType)` - 三種結局各有不同的真相揭露過程
  - [x] 修復甜味結局「大徹大悟後又裝睡」的敘事割裂問題
  - [x] 新增 `lifetimeHeirlooms` 欄位 - 永久記錄已獲得的遺物（跨輪次保留）
  - [x] 遺物採用策略A（覆蓋制）：每次更新為最新變體描述
  - **完成日**：2026-01-28

- [x] **V4.8 Rich Menu UX 完整實作**（實際 4hr）✅ **完成**
  - [x] Rich Menu 分級管制系統（沉浸破壞型/工具輔助型）
  - [x] 回程票系統 `restoreGameScreen()` - 解決洗版後迷路問題
  - [x] 靈魂狀態面板 `getStatusFlexMessage()` - 五味進度條 + 記憶列表
  - [x] `/menu` 文字指令支援（LINE Official Account Manager 相容）
  - [x] Debug 指令擴充（`/debug richmenu` 等 8 個指令）
  - [x] Rich Menu 圖片設計與部署
  - [x] 版本號更新：V4.6 → V4.8
  - **完成日**：2026-01-28

- [x] **新增函數（V4.8）**
  - [x] `restoreGameScreen()` - 回程票核心函數
  - [x] `handleOpenBio()` / `handleOpenHeirloom()` - 帶攔截的圖鑑處理
  - [x] `handleOpenStatus()` / `handleOpenHelp()` - 工具輔助處理
  - [x] `getStatusFlexMessage()` - 靈魂狀態面板生成
  - [x] `getFlavorBar()` - 五味進度條生成
  - [x] `handleHeirloomRequestWithReturn()` / `handleBiographyRequestWithReturn()` - 帶回程票的圖鑑
  - [x] `getHelpMessageWithReturn()` - 帶回程票的說明

---

## 🟠 P1：MVP 收尾（Guest 1 完整體驗）

- [x] **V4.6 結局變體系統測試**（預估 2hr）
  - [x] 部署最新代碼到 GAS
  - [x] 測試 9 條變體路線（詳見 `測試路線表_V4.6結局變體系統.md`）
  - [x] 驗證結局名稱/黑貓評論/遺物描述動態顯示
  - [x] 驗證全收集專屬內容
  - **負責人**：開發者

- [ ] **設計 Flex Message 模板優化**（預估 2hr）
  - [ ] 人物卡模板（靈魂進場）
  - [ ] 記憶劇場模板（Carousel）
  - [ ] 遺物卡模板（超渡後）
  - [ ] 使用 LINE Flex Simulator 測試
  - **負責人**：開發者

- [ ] **進行封閉測試**（預估 8hr）
  - [ ] 招募 5-10 名測試者
  - [ ] 收集反饋：情感體驗、卡點、建議
  - [ ] 迭代劇本與互動流程
  - **負責人**：全員

---

## 🟡 P2：體驗強化（圖鑑與 Rich Menu）

### ✅ 已完成（2026-01-28）⭐ 最新
- [x] **V4.8 Rich Menu UX 系統**（實際 6hr）✅ **完成**
  - [x] 分級管制機制：沉浸破壞型（人物紀傳/遺物圖鑑）遊戲中黑貓攔截
  - [x] 工具輔助型（靈魂狀態/遊戲說明）隨時可開
  - [x] 回程票系統 `restoreGameScreen()`：解決洗版後迷路問題
  - [x] 靈魂狀態面板：五味進度條 + 已收集記憶 + 黑貓評論
  - [x] `/menu` 文字指令支援（LINE Official Account Manager 相容）
  - [x] Debug 指令擴充（`/debug richmenu` 等）
  - [x] Rich Menu 圖片設計（哥德式風格 2x2）
  - [x] 版本號更新：V4.6 → V4.8
  - **完成日**：2026-01-28

- [x] **Rich Menu 功能規劃**（已實作）
  - [x] 📖 **人物紀傳**：查看已解鎖的靈魂完整故事（遊戲中攔截）
  - [x] 📊 **靈魂狀態**：取代食材庫，顯示五味傾向與記憶（隨時可開）
  - [x] 🎁 **遺物圖鑑**：查看通關後獲得的遺物及故事（遊戲中攔截）
  - [x] ❓ **遊戲說明**：玩法教學（隨時可開）

### 🔄 進行中
    - ❓ **遊戲說明**：操作指引與世界觀介紹
  - [ ] 實作對應的 Bot 回覆邏輯
  - **負責人**：開發者

- [ ] **食材/遺物/人物說明系統**（預估 3hr）
  - [ ] 建立 `ITEM_DESCRIPTIONS` 資料結構
  - [ ] 食材說明（icon、五味屬性、故事描述）
  - [ ] 遺物說明（獲得條件、背景故事）
  - [ ] 整合人物紀傳到遊戲內查看
  - **負責人**：開發者

- [ ] **LIFF 烹飪小遊戲原型**（預估 6hr）← 可選
  - [ ] 設計拖曳食材介面
  - [ ] 實作合成驗證邏輯
  - [ ] **或**使用 Quick Reply 簡化版（如果 LIFF 太複雜）
  - **負責人**：開發者

---

## 🔵 P3：未來規劃（對話企劃表 & App 階段）

### 對話企劃表系統（LINE Bot 階段）
- [ ] **標籤組合驅動對話邏輯**（預估 4hr）
  - [ ] 實作標籤組合邏輯（`["warmth", "softness"]` → 特定劇情）
  - [ ] 擴展 `dialogueLibrary` 支援 `required_tags` 欄位
  - [ ] 建立對話企劃表（方便未來擴展劇本）
  - [ ] 測試標籤組合的分支
  - **備註**：V4.6 結局變體系統已實現結局階段的動態化，此功能為對話過程中的動態化

### App 階段（非 MVP 範圍）
- [ ] **建立 Guest 2 劇本**
  - [ ] 設計「離婚的鹹味記憶」故事線
  - [ ] 驗證系統支援多靈魂切換
  - **備註**：移至 App 開發階段

- [ ] **設計隱藏靈魂解鎖機制**
  - [ ] 完成 3 位靈魂 → 解鎖「老闆的秘密」
  - [ ] 設計元敘事劇情（食堂的真相）

- [ ] **優化 LIFF 視覺體驗**
  - [ ] 設計食堂外觀（根據玩家情緒變化）
  - [ ] 添加 BGM 與音效

- [ ] **建立數據分析儀表板**
  - [ ] 追蹤玩家完成率、流失點
  - [ ] 分析最受歡迎的靈魂故事
  - [ ] 優化劇本與難度曲線

---

## 🗂️ 待歸檔的舊任務（已不適用）

以下是從舊 Backlog 中識別出的**已過時任務**，建議歸檔：

### 來自「待辦事項-優化每日推播.md」
- ~~優化雲寶的每日推播內容~~ → **已放棄推播機制**
- ~~設計 7 天的情緒變化曲線~~ → **已改為 3 日結構**

### 來自「待辦事項-問卷更新.md」
- ~~更新陪伴性驗證問卷~~ → **轉型為敘事遊戲後，驗證目標已改變**

**建議**：將這些檔案移動到 `00-工作區/歷史歸檔/` 資料夾。

---

## 📊 Sprint 進度追蹤

### Week 3 (2026-01-15 ~ 2026-01-19)

**目標**：完成架構重構，跑通 Guest 1 的完整流程 ✅ **達成**

| 任務 | 預估 | 實際 | 狀態 | 阻礙 |
|------|------|------|------|------|
| 重構程式碼.gs | 2hr | 2hr | ✅ 已完成 | - |
| 跨日檢查邏輯 | 1hr | 1hr | ✅ 已完成 | - |
| 標籤持久化 | 1hr | 1hr | ✅ 已完成 | - |
| 動態台詞檢索 | 1hr | 1hr | ✅ 已完成 | - |
| **畫鬼腳 MVP** | 4hr | 5hr | ✅ 已完成 | GAS 部署問題（已解決） |
| **田中太郎劇本** | 4hr | 6hr | ✅ 已完成 | 劇本深度超出預期 |

**里程碑**：
- [x] 週三檢查點：確認資料結構重構完成 ✅
- [x] 週六（1/18）：畫鬼腳 MVP 部署完成 ✅
- [x] 週日（1/19）：田中太郎劇本深化完成 ✅

### Week 4 (2026-01-20 ~ 2026-01-26)

**目標**：完成田中太郎版實裝、測試、UX 優化、五味系統、劇本昇華

| 任務 | 預估 | 實際 | 狀態 | 阻礙 |
|------|------|------|------|------|
| **代碼實作** | 6hr | 5hr | ✅ 已完成（1/20） | - |
| **部署測試** | 2hr | 2hr | ✅ 已完成（1/20） | Bug 修正（已解決） |
| **UX 分析** | - | 2hr | ✅ 已完成（1/20） | - |
| P0: 互動優化 + Loading | 3hr | 4hr | ✅ 已完成（1/21） | Loading API 限制（已解決） |
| P1: 玩家輸入 | 4hr | 2hr | ✅ 已完成（1/21） | - |
| **Day 1 動態系統** | - | 3hr | ✅ 已完成（1/21） | 重大突破 ✨ |
| Day 2-3 動態系統 | 6hr | 6hr | ✅ 已完成（1/23） | 8 個 Bug 修正 |
| **五味數值系統** | 4hr | 4hr | ✅ 已完成（1/25） | - |
| **縱向延伸話題** | 3hr | 3hr | ✅ 已完成（1/25） | - |
| **V4.5 劇本昇華** | 5hr | 5hr | ✅ 已完成（1/26） | - |
| **全路線測試** | 2hr | 2hr | ✅ 已完成（1/26） | 測試計劃調整 |

**里程碑**：
- [x] Day 1（1/20）：代碼實作完成 ✅
- [x] Day 1（1/20）：部署測試成功 ✅
- [x] Day 1（1/20）：UX 改進方案設計 ✅
- [x] Day 2（1/21）：P0+P1 優化完成 ✅
- [x] Day 2（1/21）：Day 1 動態系統完成 ✅
- [x] Day 3（1/23）：Day 2-3 動態系統完成 ✅
- [x] Day 5（1/25）：五味系統 + 縱向延伸 + 人物紀傳 ✅
- [x] Day 6（1/26）：V4.5 劇本昇華三痛點 + 全路線測試通過 ✅

---

## 🚨 風險與阻礙

### 當前風險
1. **測試風險**：難以找到願意測試的受眾
   - **緩解方案**：先進行內部測試（朋友、同事）

2. **範圍蔓延**：功能持續擴展可能延遲 MVP 發布
   - **緩解方案**：明確 MVP 範圍為 Guest 1 + Rich Menu，其他移至 App 階段

### ✅ 已解決的風險
- ~~跨日邏輯的時區處理~~ → 已使用 GAS 伺服器時間解決
- ~~劇本撰寫耗時超出預期~~ → Guest 1 劇本已完成，Guest 2 移至 App 階段

---

## 📚 相關文件

- [[架構診斷報告_2026-01-15]] - 本次重構的診斷依據
- [[專案實作對照表]] - 開發時的技術規格
- [[靈魂考古_3日邏輯鏈]] - 劇本設計藍圖
- [[開發決策鏈]] - 理解為何做這些決定

---

**下次更新**：2026-02-03（每週一更新）  
**維護者**：專案負責人

---

## 📌 MVP 定義（明確範圍）

### ✅ MVP 包含
- Guest 1 完整體驗（田中太郎 V4.6）
- 18 種結局變體
- Rich Menu（人物紀傳/食材庫/遺物圖鑑/說明）
- 基本圖鑑系統

### ❌ MVP 不包含（移至 App 階段）
- Guest 2+ 劇本
- 隱藏靈魂解鎖機制
- LIFF 視覺體驗優化
- 數據分析儀表板

