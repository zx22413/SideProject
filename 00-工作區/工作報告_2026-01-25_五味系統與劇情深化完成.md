# 靈魂食堂 - 五味系統與劇情深化完成報告

> **日期**：2026-01-25  
> **類型**：開發 + 劇本設計  
> **狀態**：✅ 已完成

---

## 📋 今日工作總結

### ✅ 已完成

#### 1. 五味數值系統實作完成

**核心機制**：
- ✅ 建立 `MEMORY_FLAVOR_MAP` 對照表（記憶標籤 → 五味數值）
- ✅ 實作 `calculateFlavorBalance()` 函數（累加所有收集記憶的五味數值）
- ✅ 實作 `determineEnding()` 函數（依據五味比例判定結局類型）
- ✅ 調整「裁縫手藝」味覺數值（甜 1→3、鹹 3→2），優化甜味路線達成條件

**五味映射邏輯**：
- **甜**（土）：撫慰與接地 → 適用驚魂未定的靈魂
- **酸**（木）：聚焦與收斂 → 適用衝動決策導致後悔
- **苦**（火）：清醒與瀉火 → 適用無法接受現實
- **辛**（金）：宣洩與流動 → 適用情感淤塞、憂鬱
- **鹹**（水）：意志與記憶 → 適用失智、忘記姓名

**新增高甜值記憶標籤**：
- `銀座的驕傲`（甜 6）
- `美雪的笑容`（甜 6）
- `第一次叫爸爸`（甜 5）

---

#### 2. 縱向延伸話題系統（深挖角色）

**Day 1 延伸話題**：
- ✅ 「你的手」→「那…這雙手做過最驕傲的事是什麼？」（`hands_pride`）
  - 解鎖條件：完成 `hands_part2` 後出現
  - 獲得記憶：`銀座的驕傲`（甜 6）
  - 劇情意義：從「手的功能」深挖到「手的意義」，揭示田中職業生涯的巔峰

**Day 2 延伸話題**：
- ✅ 「那個夢」→「夢裡那個小女孩…她小時候是什麼樣子？」（`miyuki_childhood`）
  - 解鎖條件：完成 `dream_part3` 後出現
  - 獲得記憶：`美雪的笑容`（甜 6）、`第一次叫爸爸`（甜 5）
  - 劇情意義：從「夢境」深挖到「美雪的童年」，強化父女關係的情感連結

- ✅ 「你怎麼來的」→「你說有很多雪…那時候你原本在做什麼？」（`snow_then`）
  - 解鎖條件：完成 `death` 話題後出現
  - 獲得記憶：`最後一針`、`閣樓`
  - 劇情意義：從「死亡場景」深挖到「死亡前的最後時刻」，揭示田中的執念

**設計理念**：
- 玩家視角：不知道角色背景，只能透過追問逐步挖掘
- 避免上帝視角：不直接告訴玩家「這是田中太郎，他是裁縫師」
- 層層剝開：從表層對話 → 延伸追問 → 深層記憶

---

#### 3. 橫向劇情發展（甜/苦路線設計）

**甜味過重路線**（重新定義）：
- 路線組成：`沉默陪伴` + `那個夢` + `關於美雪小時候`
- 調整內容：
  - 避免「你的手」話題（五味混合，不易達成甜味過重）
  - 聚焦「沉默陪伴」的寧靜感、「那個夢」的溫暖、「美雪小時候」的純甜記憶
- 配方調整：`熱茶` 配方擴展為接受 `寧靜` + `陪伴` 記憶，讓「沉默陪伴」路線可在 Day 1 完成料理

**苦味過重路線**（新設計）：
- 路線組成：`你怎麼來的` + `雪中那時…`（延伸話題）
- 記憶標籤：`最後一針`、`閣樓`（高苦值）
- 劇情意義：聚焦死亡前的遺憾與未完成

**結局判定邏輯**：
- 保持 `determineEnding()` 原始邏輯（`sweet > others` 判定甜味結局）
- 不改變判定條件，而是透過調整話題內容與記憶數值，讓玩家更容易達成特定路線
- 設計理念：內容引導 > 邏輯限制

---

#### 4. 動態對話系統優化

**Day 1 動態系統**（已完成）：
- ✅ `getDay1DayShift(state)` - 動態話題選擇（已完成話題自動隱藏）
- ✅ 話題完成後回到選擇畫面（可收集多種食材）
- ✅ `getDay1CookingScene(state)` - 動態顯示廚房食材

**Day 3 動態系統**（已完成）：
- ✅ `getDay3CookingStart(state)` - 動態顯示所有收集的記憶食材
- ✅ `handleDay3Cooking()` - 預設回應顯示完整廚房場景
- ✅ 結局判定依據收集的記憶自動計算五味比例

**核心設計原則**：
1. **多次對話收集**：玩家可選擇多個話題收集不同食材
2. **動態按鈕顯示**：完成的話題自動隱藏
3. **進度可視化**：顯示已收集話題數量
4. **靈活進入廚房**：完成任意話題後可選擇進入廚房
5. **食材動態顯示**：廚房根據收集的食材動態生成內容

---

#### 5. Loading 動畫調整

**修正內容**：
- ✅ 修正 API 格式（URL + payload + loadingSeconds 必須是 5 的倍數）
- ✅ 所有 input 都加入 Loading Animation（35 處）
- ✅ 修正 `advancePhase` 函數，確保 Loading 動畫在按鈕按下瞬間立即顯示
- ✅ 優化 Loading 時間，避免等待過久問題

**UX 改進**：
- 按鈕按下 → Loading 動畫立即顯示 → 減少玩家等待焦慮
- 所有用戶輸入都有視覺反饋

---

#### 6. Bug 修正（累計 12+ 個）

**LINE API 訊息限制相關**：
- ✅ Day 1「窗外的雨」首次選擇跳過對話 → 訊息超過 5 條限制，合併訊息
- ✅ Day 2「你怎麼來的」訊息 6 條超過限制 → 合併為 4 條
- ✅ Day 3 Cooking Part 1 訊息 6 條超過限制 → 合併為 4 條
- ✅ Day 1「做熱茶」卡住 → 修正 return 語句 + 訊息數量限制（6→5條）

**競爭條件與 Phase 錯誤**：
- ✅ 連點按鈕導致 phase 混亂 → `advancePhase` 增加競爭條件保護，重新獲取最新狀態
- ✅ phase 被意外設為 COOKING 導致話題失效 → `handleDay1Cooking` 和 `handleDay2Cooking` 增加安全檢查
- ✅ Day 1 Cooking 預設回應 quickReply 與雙選項衝突 → 移除 quickReply，改為顯示完整廚房場景

**邏輯錯誤**：
- ✅ Day 1 Cooking Part 3 條件寫錯 → `cooking_tea_part3` → `cooking_tea_part2` 修正
- ✅ 「我是誰」匹配條件太寬鬆 → 改為嚴格匹配 `=== "我是誰？"`

**安全機制強化**：
- ✅ `advancePhase()` 增加競爭條件保護（重新獲取最新狀態，避免連點問題）
- ✅ `handleDay1Cooking()` 增加話題選擇安全檢查（如果用戶輸入話題選擇文字，自動重置 phase 為 DAY）
- ✅ `handleDay2Cooking()` 增加相同安全機制

---

#### 7. 人物紀傳撰寫

**完成文件**：
- ✅ `02-劇本設計/田中太郎_人生紀實.md`（1,127 行）
  - 完整生平：從昭和二十年銀座工房 → 一針一線的成長 → 成功後的落寞 → 與美雪的裂痕 → 最後的告別
  - 核心主題：「每一針，都是說不出口的話」
  - 情感深度：創傷、遺憾、光榮、成就、衰敗、家庭、孤獨

**整合建議**：
- ✅ `02-劇本設計/田中太郎_人生紀實整合建議.md`（634 行）
  - 將紀實內容轉化為遊戲對話的具體建議
  - 避免上帝視角，保持玩家探索感
  - 層次化記憶揭露的設計方案

**劇情流程圖**：
- ✅ `02-劇本設計/田中太郎劇情流程圖.md`（427 行）
  - 完整遊戲流程視覺化
  - 話題選擇 → 記憶收集 → 料理製作 → 結局判定

---

## 📊 代碼變更統計

| 類別 | 數量 |
|------|------|
| 新增函數 | 3（延伸話題處理、五味計算、結局判定） |
| 修改函數 | 15+ |
| Bug 修正 | 12+ 處 |
| 新增記憶標籤 | 5 個（銀座的驕傲、美雪的笑容、第一次叫爸爸、最後一針、閣樓） |
| 調整記憶數值 | 1 個（裁縫手藝：甜 1→3、鹹 3→2） |
| 新增話題 | 3 個（Day 1 延伸、Day 2 延伸 × 2） |
| 新增行數 | +300+ |

**代碼總行數**：~3,653 行 → **~4,231 行**（五味料理版）

---

## 🎯 核心設計突破

### 1. 五味系統：從機制到敘事

**設計理念**：
- 不改變結局判定邏輯，而是透過內容調整引導玩家走向特定結局
- 玩家選擇影響記憶收集 → 記憶數值影響五味比例 → 五味比例決定結局
- 讓玩家「自然」達成特定路線，而非「被迫」選擇

**實作成果**：
- 甜味過重路線：`沉默陪伴` + `那個夢` + `關於美雪小時候` 可達成
- 苦味過重路線：`你怎麼來的` + `雪中那時…` 可達成
- 平衡路線：混合選擇，五味均衡

---

### 2. 縱向延伸：深挖角色深度

**設計理念**：
- 玩家視角：不知道角色背景，只能透過追問逐步挖掘
- 避免上帝視角：不直接告訴玩家「這是田中太郎，他是裁縫師」
- 層層剝開：從表層對話 → 延伸追問 → 深層記憶

**實作成果**：
- Day 1：從「你的手」→「最驕傲的事」→ 揭示職業巔峰
- Day 2：從「那個夢」→「美雪小時候」→ 強化父女關係
- Day 2：從「你怎麼來的」→「雪中那時」→ 揭示死亡前的執念

---

### 3. 橫向發展：多路線探索

**設計理念**：
- 不同話題組合 → 不同記憶收集 → 不同五味傾向 → 不同結局
- 讓玩家有「探索感」，而非「單一路線」

**實作成果**：
- 甜味路線：聚焦溫暖記憶（美雪、陪伴、寧靜）
- 苦味路線：聚焦遺憾記憶（死亡、未完成、裂痕）
- 平衡路線：混合選擇，五味均衡

---

## 🔗 受影響的核心文件

- [[../../00-核心企劃/當前專案_靈魂食堂/靈魂食堂：最終開發執行企劃書]] - 更新至 V4.4（五味系統、食物作為自白劑、縱向延伸話題）
- [[../../01-開發實驗/專案實作對照表]] - 新增五味系統實作記錄、延伸話題代碼位置
- [[主 Backlog_2026-01-15]] - 五味系統 + 縱向延伸話題任務完成
- [[../../02-劇本設計/田中太郎_人生紀實]] - 人物紀傳完成
- [[../../02-劇本設計/田中太郎劇情流程圖]] - 更新至最新版本

---

## 📚 相關文件

### 新建文件
- `02-劇本設計/田中太郎_人生紀實.md` - 完整人物生平（1,127 行）
- `02-劇本設計/田中太郎_人生紀實整合建議.md` - 紀實轉遊戲對話建議（634 行）
- `02-劇本設計/田中太郎劇情流程圖.md` - 完整遊戲流程視覺化（427 行）

### 修改文件
- `01-開發實驗/程式碼/靈魂食堂_田中太郎_五味料理版.gs` - 主代碼（4,231 行）
- `00-核心企劃/當前專案_靈魂食堂/靈魂食堂：最終開發執行企劃書.md` - V4.4 更新

### 前置報告
- [[工作報告_2026-01-21_UX全面改進]] - Day 1 動態系統完成
- [[工作報告_2026-01-23_Day2-3動態系統完成]] - Day 2-3 動態系統完成

---

## 🎯 下一步行動

### 立即行動（明日繼續）
1. **全面測試**：測試甜味過重、苦味過重、平衡路線的完整流程
2. **劇情優化**：根據測試反饋調整對話節奏與分段呈現
3. **邊緣情況測試**：連點、快速切換、異常輸入等

### 中期計劃
1. Rich Menu 設計與實作
2. 記憶卡片圖片化
3. Guest 2 劇本撰寫（應用相同設計模式）

---

**報告人**：AI Assistant  
**報告時間**：2026-01-25  
**狀態**：✅ 五味系統與劇情深化全部完成  
**優先級**：P0 - 全面測試 + 劇情優化

#tier2/追蹤
