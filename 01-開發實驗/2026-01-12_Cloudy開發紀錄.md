# 📝 Cloudy V1.4 開發紀錄：2026-01-12

> [!abstract] 今日里程碑
> **日期**：2026-01-12  
> **版本**：V1.4 (Bird Alone 模式)  
> **階段**：技術底層打通  
> **關聯專案**：[[MVP 企劃：3日陪伴實驗_Bird Alone模式]]

---

## 🎯 今日完成項目

### ✅ 技術底層打通

#### 1. LINE Messaging API 串接成功
- ✅ 完成 `doPost()` 函數實作
- ✅ 成功接收 LINE Webhook 事件
- ✅ 正確解析 `userId` 和 `replyToken`
- ✅ 實作 `replyToLine()` 函數，可回覆訊息給用戶

#### 2. Google Apps Script (GAS) 權限授權解決
- ✅ 解決 `SpreadsheetApp` 權限授權問題
- ✅ 成功連接到 Google Sheets
- ✅ 實作 `setup()` 函數觸發權限審核流程

#### 3. Google Sheets 資料庫架構建立
- ✅ 試算表結構定義完成：
  - `userId` (Column A) - 用戶唯一識別碼
  - `day` (Column B) - 當前天數 (1-3)
  - `currentMood` (Column C) - 當前情緒狀態
  - `tags` (Column D) - 記憶標籤（逗號分隔）
  - `lastInteraction` (Column E) - 最後互動時間

#### 4. 用戶狀態初始化邏輯
- ✅ 實作用戶識別邏輯（根據 `userId` 查找現有記錄）
- ✅ 新用戶自動初始化為 Day 1
- ✅ 現有用戶正確讀取 `day` 計數器
- ✅ 成功更新 `lastInteraction` 時間戳記

---

## 📊 目前數據狀態

### 測試結果
- ✅ **連線測試成功**：雲寶已能正確讀寫試算表
- ✅ **用戶識別成功**：系統能正確識別 `userId`
- ✅ **初始化成功**：新用戶自動建立記錄，`day` 設為 1
- ✅ **狀態讀取成功**：現有用戶能正確讀取 `day` 值

### 目前程式碼結構
```javascript
// 核心函數
- doPost(e)          // LINE Webhook 處理
- replyToLine()      // LINE API 回覆
- doGet(e)           // 測試用
- setup()            // 權限觸發
```

> [!info] 程式碼位置
> 程式碼已歸檔至：`01-開發實驗/程式碼/程式碼.gs`  
> 詳見 [[程式碼/README]] 了解安全注意事項

---

## 🚧 技術待辦清單 (Backlog)

### Phase 1: 核心互動機制

#### [ ] 圖文選單實作
- **任務描述**：
  - 在 LINE OA 後台設定圖文選單（3 個按鈕：餵食、聊天、查看狀態）
  - 在 `doPost()` 中處理 `postback` 事件
  - 定義關鍵字觸發邏輯：
    - `"餵食"` / `"feed"` → 觸發餵食流程
    - `"聊天"` / `"chat"` → 觸發聊天流程
    - `"查看狀態"` / `"status"` → 回傳外部網頁連結
- **對應程式碼位置**：`doPost()` 函數中的事件類型判斷

#### [ ] 對話桶系統 (Dialogue Bucket System)
- **任務描述**：
  - 在 GAS 中建立 `dialogueLibrary` 物件（參考企劃書結構）
  - 實作 `getDialogue(day, action, mood, tags)` 函數
  - 實作隨機選取邏輯：從對應的對話桶中隨機選擇一條回應
  - 對話桶結構範例：
    ```javascript
    const dialogueLibrary = {
      "day1_feed_happy": ["回應1", "回應2", ...],
      "day1_feed_sad": ["回應1", "回應2", ...],
      "day2_memory_bunbun": ["回應1", "回應2", ...],
      // ...
    };
    ```
- **對應程式碼位置**：新增 `dialogueLibrary` 物件和 `getDialogue()` 函數

#### [ ] 標籤系統 (Tag System)
- **任務描述**：
  - 實作 `updateUserTags(userId, newTag)` 函數
  - 處理選擇題結果：當用戶選擇 A/B 選項時，提取對應標籤
  - 將標籤存入 Sheets 的 `tags` 欄位（逗號分隔格式）
  - 實作標籤讀取邏輯：`getUserTags(userId)` → 返回標籤陣列
- **對應程式碼位置**：新增 `updateUserTags()` 和 `getUserTags()` 函數

#### [ ] 情緒選擇流程
- **任務描述**：
  - 實作餵食流程：當用戶點擊「餵食」時，回傳快速回覆選單（開心/難過/生氣）
  - 處理用戶選擇的情緒：更新 Sheets 的 `currentMood` 欄位
  - 根據 `day` + `mood` 匹配對應的對話桶
  - 回傳預設對話回應
- **對應程式碼位置**：在 `doPost()` 中處理 `message` 事件（快速回覆）

#### [ ] 選擇題系統
- **任務描述**：
  - 實作聊天流程：當用戶點擊「聊天」時，回傳選擇題（A/B 選項）
  - 根據 `day` 決定選擇題內容：
    - Day 1: 「咖哩怎麼吃？」（A. 拌拌派 / B. 分開派）
    - Day 2: 「累爆時會先做什麼？」（A. 放空派 / B. 儀式派）
    - Day 3: 「這三天跟雲寶相處比較像什麼？」（A. 樹洞模式 / B. 陪伴模式）
  - 處理用戶選擇：提取標籤並存入 `tags`
  - 回傳對應的對話回應
- **對應程式碼位置**：在 `doPost()` 中處理選擇題回覆，呼叫 `updateUserTags()`

### Phase 2: 記憶系統

#### [ ] 記憶觸發邏輯
- **任務描述**：
  - 實作 `checkMemoryTriggers(userId, day)` 函數
  - Day 2-3 時，根據 `tags` 匹配對應的記憶對話
  - 例如：如果 `tags` 包含「拌拌派」→ 匹配 `day2_memory_bunbun`
  - 在餵食/聊天回應中，隨機插入記憶對話
- **對應程式碼位置**：新增 `checkMemoryTriggers()` 函數，整合到 `getDialogue()` 中

#### [ ] Day 計數器自動更新
- **任務描述**：
  - 實作 `updateDay(userId)` 函數
  - 根據 `lastInteraction` 判斷是否跨天
  - 如果跨天且 `day < 3`，自動 `day++`
  - 如果 `day == 3`，觸發結局流程
- **對應程式碼位置**：新增 `updateDay()` 函數，在 `doPost()` 開頭呼叫

### Phase 3: 外部網頁

#### [ ] HTML Service 實作
- **任務描述**：
  - 使用 GAS 的 `HtmlService.createTemplateFromFile()` 建立外部網頁
  - 設計 HTML 結構（參考企劃書的 HTML 範例）
  - 實作 URL 參數解析：`?userId=xxx` 或 `?day=1&mood=happy&tags=拌拌派`
  - 從 Sheets 讀取用戶狀態，動態渲染雲寶樣貌
- **對應程式碼位置**：新增 `doGet()` 的 HTML 回傳邏輯，新增 `index.html` 檔案

#### [ ] 視覺動態效果
- **任務描述**：
  - 實作 CSS 動畫（根據 `mood` 變色、根據 `day` 變形）
  - 實作 JavaScript 狀態讀取（從 URL 參數或 Sheets API）
  - 顯示進度條（Day X/3）
  - 顯示記憶標籤
- **對應程式碼位置**：`index.html` 中的 CSS 和 JavaScript

#### [ ] 外部網頁連結生成
- **任務描述**：
  - 實作 `generateStatusUrl(userId)` 函數
  - 生成 GAS Web App 的公開 URL
  - 當用戶點擊「查看狀態」時，回傳此連結
- **對應程式碼位置**：新增 `generateStatusUrl()` 函數

### Phase 4: 推播系統

#### [ ] 定時推播設定
- **任務描述**：
  - 使用 GAS 的 `Time-driven triggers` 設定每天定時推播
  - 實作 `sendDailyPush()` 函數
  - 根據 `day` 決定推播文案（參考企劃書的推播文案）
  - 使用 LINE Messaging API 的 `pushMessage` 功能
- **對應程式碼位置**：新增 `sendDailyPush()` 函數，設定 GAS 觸發器

---

## 📝 技術筆記

### 目前程式碼架構
```
程式碼.gs
├── doPost(e)              // LINE Webhook 入口
│   ├── 解析事件
│   ├── 讀取/寫入 Sheets
│   └── 回覆訊息
├── replyToLine()          // LINE API 回覆
├── doGet(e)               // 測試/外部網頁入口
└── setup()                // 權限觸發
```

### 試算表結構 (userState Sheet)
| Column | 欄位名稱 | 資料型態 | 說明 |
|:------|:--------|:--------|:-----|
| A | userId | String | LINE 用戶 ID |
| B | day | Number | 當前天數 (1-3) |
| C | currentMood | String | 當前情緒 (happy/sad/angry) |
| D | tags | String | 記憶標籤（逗號分隔，如："拌拌派,放空派"） |
| E | lastInteraction | Date | 最後互動時間 |

### 下一步優先順序
1. **高優先級**：圖文選單實作、對話桶系統、情緒選擇流程
2. **中優先級**：選擇題系統、標籤系統、記憶觸發邏輯
3. **低優先級**：外部網頁、推播系統

---

## 🔗 相關連結

- [[MVP 企劃：3日陪伴實驗_Bird Alone模式]] - 核心企劃文件
- [[角色設定：雲寶]] - 角色設定與語氣參考
- [[企劃書與Bird Alone結合探討]] - 技術架構參考
- [[程式碼/README]] - 程式碼歸檔說明

---

## 📦 程式碼歸檔

**位置**：`01-開發實驗/程式碼/`

- `程式碼.gs` - Google Apps Script 程式碼備份（含安全警告）
- `userState_備份_2026-01-12.csv` - 測試數據備份
- `README.md` - 檔案說明與安全建議

> [!warning] 注意
> 程式碼包含敏感資訊（LINE Token、Google Sheets ID），已加入 `.gitignore` 保護

---

**狀態**：🟢 執行中  
**最後更新**：2026-01-12
