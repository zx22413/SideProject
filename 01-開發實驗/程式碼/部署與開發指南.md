# 靈魂食堂 - 部署與開發指南

> **當前版本**：V4.8（Rich Menu UX 完整實作）  
> **最後更新**：2026-01-28  
> **狀態**：✅ Rich Menu 分級管制 + 回程票系統完成

---

## 📁 代碼文件說明

### 主要文件

#### `靈魂食堂_田中太郎_五味料理版.gs` ✅ **正式部署版本**
- **版本**：V4.8（2026-01-28）
- **行數**：~5,785 行
- **狀態**：✅ Rich Menu UX 系統完成，MVP 功能基本完備

**V4.8 新增特色**（2026-01-28）：
- ✅ Rich Menu 分級管制系統（沉浸破壞型/工具輔助型）
- ✅ 回程票系統 `restoreGameScreen()` - 解決洗版後迷路問題
- ✅ 靈魂狀態面板 `getStatusFlexMessage()` - 五味進度條 + 記憶列表
- ✅ `/menu` 文字指令支援（LINE Official Account Manager 相容）
- ✅ Debug 指令擴充（`/debug richmenu` 等 8 個指令）

**V4.7 新增特色**（2026-01-28）：
- ✅ `getTruthMonologue(endingType)` - 三種結局不同真相揭露過程
- ✅ `lifetimeHeirlooms` 永久遺物系統（跨輪次保留）
- ✅ 遺物策略 A（覆蓋制）：同類型結局顯示最新變體描述

**V4.6 新增特色**（2026-01-27）：
- ✅ 結局名稱/黑貓評論/遺物描述動態化（18 種變體）
- ✅ 告別對話模組化堆疊
- ✅ 全收集專屬設計（變體記憶 >= 3 時觸發）

**V4.5 新增特色**（2026-01-26）：
- ✅ 劇本昇華三痛點（翻譯者/裂痕事件/時代孤獨）
- ✅ 新增延伸話題：`ceremony_rift`、`twilight_artisan`

**V4.4 新增特色**（2026-01-25）：
- ✅ 五味數值系統完整實作
- ✅ 縱向延伸話題系統

#### 歷史版本（已歸檔）

**`靈魂食堂_田中太郎重構版.gs`**（V3.0，已整合至五味料理版）
- Day 2 動態料理系統
- 料理記錄系統（dishesCooked）
- 配方檢查機制

### 歷史版本

#### `archive-versions/靈魂食堂_田中太郎重構版_v2.0_2026-01-24.gs`
- **版本**：V2.0（2026-01-20 創建，2026-01-24 歸檔）
- **狀態**：已歸檔
- **說明**：v3.0 開發前的穩定版本，包含 Day 1-3 動態系統、Loading Animation、防鬼打牆機制

#### `靈魂食堂_畫鬼腳MVP.gs`
- **版本**：V4.1（2026-01-18）
- **狀態**：測試版本
- **用途**：快速驗證敘事體驗的簡化版本
- **特色**：3天9條路徑的畫鬼腳結構

#### `config.template.gs`
- **用途**：配置文件模板
- **包含**：LINE Token、Sheets ID 等敏感資訊的格式範例
- **注意**：實際配置不要上傳到 Git

---

## 🚀 快速部署（10 分鐘上線）

### 步驟 1：準備 Google Sheets

1. 建立新的 Google Sheets 試算表
2. 創建以下 Sheet（分頁）：

#### Sheet: `userStateTanaka`（用戶狀態）
| 欄位 | 說明 | 範例 |
|------|------|------|
| A: userId | LINE User ID | `U1234567890abcdef` |
| B: currentDay | 當前天數（1-3） | `1` |
| C: phase | 當前階段 | `night`, `day`, `cooking`, `after` |
| D: collectedMemories | 已收集記憶（JSON陣列） | `["針","縫線","寒冷"]` |
| E: topicsDone | 已完成話題（JSON陣列） | `["hands_part1","hands_part2"]` |
| F: lastActive | 最後活躍時間 | `2026-01-24 10:30:00` |
| G: dishesCooked | 本輪做過的料理（JSON陣列） | `["蜜汁燉菜","苦辛醒神湯"]` |

**標題行範例**：
```
userId | currentDay | phase | collectedMemories | topicsDone | lastActive | dishesCooked
```

---

### 步驟 2：部署到 Google Apps Script

1. 開啟 [Google Apps Script](https://script.google.com/)
2. 新增專案 → 命名為「靈魂食堂」
3. 刪除預設的 `Code.gs`
4. 複製 `靈魂食堂_田中太郎_五味料理版.gs` 的**完整內容**
5. 貼上到編輯器
6. 儲存（Ctrl+S）

### 步驟 2.5：設定 Script Properties（🔐 安全配置）

> **重要**：敏感資訊（Token、Sheet ID）存放在 GAS 的「指令碼屬性」中，不會出現在程式碼裡，因此程式碼可以安全地推送到 Git。

1. 在 GAS 編輯器中，點擊左側的 **「專案設定」**（齒輪圖示 ⚙️）
2. 滑到最下方找到 **「指令碼屬性 (Script Properties)」**
3. 點擊 **「新增指令碼屬性」**，加入以下兩個屬性：

| 屬性 (Property) | 值 (Value) | 如何取得 |
|----------------|-----------|---------|
| `SPREADSHEET_ID` | 你的 Google Sheets ID | 從試算表網址中擷取：`https://docs.google.com/spreadsheets/d/【這串就是ID】/edit` |
| `LINE_CHANNEL_ACCESS_TOKEN` | 你的 LINE Channel Access Token | LINE Developers Console → Messaging API → Channel access token |

4. 按下 **「儲存」**

#### 驗證設定是否成功

在 GAS 編輯器中執行 `testScriptProperties` 函數（在 `config.template.gs` 中），查看執行記錄確認：
```
=== Script Properties 測試 ===
SPREADSHEET_ID: ✅ 已設定 (1A2b3C4d5E...)
LINE_CHANNEL_ACCESS_TOKEN: ✅ 已設定 (長度: 172)
🎉 所有必要設定都已完成！
```

---

### 步驟 3：部署為 Web App

1. 點擊右上角「部署」→「新增部署作業」
2. 類型選擇「網頁應用程式」
3. 設定：
   - **執行身分**：我
   - **存取權**：所有人
4. 點擊「部署」
5. 複製「網頁應用程式 URL」（這就是你的 Webhook URL）

---

### 步驟 4：設定 LINE Webhook

1. 前往 [LINE Developers Console](https://developers.line.biz/)
2. 選擇你的 Messaging API Channel
3. 到「Messaging API」頁籤
4. 在「Webhook settings」區塊：
   - 貼上剛才複製的 Web App URL
   - 點擊「Verify」測試連線
   - 開啟「Use webhook」開關
5. 確認「Auto-reply messages」和「Greeting messages」都關閉（否則會衝突）

---

### 步驟 5：測試

在 LINE OA 對話框中輸入：

```
/debug state
```

如果回傳用戶狀態（JSON 格式），代表部署成功！

接著輸入：
```
/debug reset
```

重置狀態後即可開始遊戲。

---

## 🧪 DEBUG 指令集

### 基本指令

| 指令 | 功能 | 範例 |
|------|------|------|
| `/debug state` | 查看當前狀態 | - |
| `/debug reset` | 重置遊戲（回到 Day 1 Night） | - |

### 遊戲流程指令

| 指令 | 功能 | 用途 |
|------|------|------|
| `觀察他` | Day 1 Night 開始遊戲 | 觸發第一段劇情 |
| `你的手` | Day 1 Day 話題選擇 | 進入「手」話題分支 |
| `你從哪裡來？` | Day 1 Day 話題選擇 | 進入「來歷」話題分支 |
| `窗外一直在下雨...` | Day 1 Day 話題選擇 | 進入「雨」話題分支 |
| `【靜靜陪伴】` | Day 1 Day 話題選擇 | 進入「陪伴」話題分支 |
| `【進入廚房】` | Day 1 Day 進入烹飪階段 | 需至少完成一個話題 |
| `做熱茶` | Day 1 Cooking 選擇料理 | 烹飪場景 |
| `做熱湯` | Day 1 Cooking 選擇料理 | 烹飪場景 |
| `【繼續】` | 通用繼續指令 | 推進劇情 |
| `你夢到了什麼？` | Day 2 Day 話題選擇 | 進入「那個夢」話題分支 |
| `你在找什麼？` | Day 2 Day 話題選擇 | 進入「尋找」話題分支 |
| `你是怎麼來到這裡的？` | Day 2 Day 話題選擇 | 進入「死亡」話題分支 |
| `【做蜜汁燉菜】` | Day 2 Cooking 選擇料理 | 需收集「蜜糖笑容」+「眼淚」 |
| `【做苦辛醒神湯】` | Day 2 Cooking 選擇料理 | 需收集「執念」+（「雪」或「死亡」） |
| `【做撫慰鹹粥】` | Day 2 Cooking 選擇料理 | 需收集「寧靜」+「陪伴」 |
| `最後一天` | Day 2 After 推進到 Day 3 | 進入最終章 |
| `【製作最終料理】` | Day 3 Cooking 開始最終料理 | 烹飪最終料理 |
| `【端出料理】` | Day 3 Cooking 完成料理 | 進入結局 |
| `【告別】` | Day 3 After 告別 | 完成遊戲 |

---

## 🛠️ 技術架構

### 核心系統

#### 1. 狀態管理系統
- **函數**：`getUserState(userId)`, `updateUserState(userId, newState)`
- **說明**：從 Google Sheets 讀取/寫入用戶狀態
- **快取**：無（每次都從 Sheets 讀取，確保一致性）

#### 2. 階段路由系統
- **函數**：`handleTextMessage(event, userId, userText)`
- **說明**：根據 `currentDay` 和 `phase` 路由到對應的處理函數
- **路由邏輯**：
  ```
  Day 1 + night   → handleDay1Night
  Day 1 + day     → handleDay1Day
  Day 1 + cooking → handleDay1Cooking
  Day 1 + after   → handleDay1After
  （Day 2-3 類似）
  ```

#### 3. 動態 UI 生成系統
- **函數**：`getDay1DayShift(state)`, `getDay1CookingScene(state)`
- **說明**：根據用戶狀態動態生成 Flex Message
- **特色**：已完成的話題按鈕會隱藏，解鎖新選項

#### 4. 訊息推送系統
- **函數**：`pushMessages(userId, messages)`, `replyMessage(replyToken, message)`
- **說明**：分段推送訊息（最多 5 則），支援 Loading Animation
- **Loading**：`showLoadingAnimation(userId, seconds)`

#### 5. 記憶收集系統
- **函數**：`addMemory(userId, state, memory)`, `addTopic(userId, state, topic)`
- **說明**：收集玩家的對話選擇，作為「記憶食材」

#### 6. 動態料理系統（v3.0 新增）
- **函數**：`getDay2AvailableRecipes(memories)`, `addDishCooked(userId, state, dish)`
- **說明**：依收集的記憶判斷可做料理，記錄本輪做過的料理
- **配方**：
  - 蜜汁燉菜：需「蜜糖笑容」+「眼淚」
  - 苦辛醒神湯：需「執念」+（「雪」或「死亡」）
  - 撫慰鹹粥：需「寧靜」+「陪伴」
- **用途**：Day 3 結局依 `dishesCooked` 追加額外台詞

---

## 📋 主要函數說明

### 入口函數

#### `doPost(e)`
- **說明**：LINE Webhook 入口
- **處理**：解析 LINE 事件，路由到對應處理函數

### 狀態管理

#### `getUserState(userId)`
- **回傳**：用戶狀態物件（從 Sheets 讀取）
- **預設狀態**：
  ```javascript
  {
    userId: userId,
    currentDay: 1,
    phase: "night",
    collectedMemories: [],
    topicsDone: [],
    lastActive: "",
    dishesCooked: []  // v3.0 新增
  }
  ```

#### `updateUserState(userId, newState)`
- **說明**：更新用戶狀態到 Sheets
- **操作**：找到該 userId 的行，更新對應欄位

### 階段處理函數

#### `handleDay1Night(event, userId, state, userText)`
- **說明**：處理 Day 1 Night 階段
- **觸發**：用戶輸入「觀察他」
- **流程**：
  1. 顯示 Loading Animation
  2. 回傳開場劇情（Flex Card）
  3. 提供「和他聊聊」按鈕（Quick Reply）
  4. 點擊後 → `advancePhase` → 進入 Day 1 Day

#### `handleDay1Day(event, userId, state, userText)`
- **說明**：處理 Day 1 Day 階段（話題選擇）
- **觸發**：
  - 「你的手」→ 觸發「手」話題對話
  - 「你從哪裡來？」→ 觸發「來歷」話題對話
  - 「窗外一直在下雨...」→ 觸發「雨」話題對話
  - 「【靜靜陪伴】」→ 觸發「陪伴」話題對話
  - 「【進入廚房】」→ 進入 Cooking 階段
- **流程**：
  1. 顯示 Loading Animation
  2. 推送分段劇情（`pushMessages`）
  3. 添加記憶（`addMemory`）
  4. 回傳更新後的話題選單（`getDay1DayShift(state)`）

#### `handleDay1Cooking(event, userId, state, userText)`
- **說明**：處理 Day 1 Cooking 階段
- **觸發**：
  - 初次進入 → 顯示廚房場景（`getDay1CookingScene`）
  - 「做熱茶」→ 觸發熱茶烹飪劇情
  - 「做熱湯」→ 觸發熱湯烹飪劇情
- **流程**：
  1. 顯示 Loading Animation
  2. 推送分段烹飪劇情（`pushMessages`，最多 5 則）
  3. 最後一段包含「繼續」Quick Reply
  4. 點擊「繼續」→ `advancePhase` → 進入 After 階段

### 動態 UI 生成

#### `getDay1DayShift(state)`
- **說明**：生成 Day 1 Day Shift 10:00 的 Flex Card
- **邏輯**：
  - 檢查 `state.topicsDone` 陣列
  - 隱藏已完成的話題按鈕
  - 如果 `topicsDone.length > 0`，顯示「進入廚房」按鈕
- **回傳**：Flex Message JSON

#### `getDay1CookingScene(state)`
- **說明**：生成 Day 1 Cooking Time 18:00 的 Flex Card
- **邏輯**：
  - 根據 `state.collectedMemories` 動態生成「記憶食材」清單
  - 顯示「做熱茶」「做熱湯」按鈕
- **回傳**：Flex Message JSON

### 輔助函數

#### `showLoadingAnimation(userId, seconds)`
- **說明**：顯示「正在輸入...」動畫
- **限制**：`seconds` 必須是 5 的倍數（LINE API 限制）
- **自動調整**：`Math.round(seconds / 5) * 5`

#### `pushMessages(userId, messages)`
- **說明**：批量推送訊息（最多 5 則）
- **限制**：LINE Push API 單次最多 5 則訊息
- **注意**：如果超過 5 則會報錯

#### `addMemory(userId, state, memory)`
- **說明**：添加記憶到 `collectedMemories` 陣列
- **去重**：不會重複添加相同記憶

#### `addTopic(userId, state, topic)`
- **說明**：標記話題為已完成
- **去重**：不會重複添加相同話題

#### `advancePhase(event, userId, state)`
- **說明**：推進到下一個階段
- **邏輯**：
  ```
  night → day → cooking → after → (下一天的 night)
  ```
- **自動處理**：Day 3 After 後 → 結束遊戲

---

## 🎨 UX 設計原則（V4.3）

### 1. Loading Animation 策略
- **何時使用**：任何玩家 input 動作都需要
- **時長**：5 秒（短劇情）、10 秒（長劇情）
- **目的**：提供即時反饋，避免「卡住」感

### 2. 訊息分段（Segmented Messages）
- **規則**：
  - 敘事文本：30-80 字/段
  - 左右交替：角色對話（左）→ 玩家思考（右）
  - 最後一段：附帶 Quick Reply「繼續」按鈕
- **目的**：模擬真實對話節奏，提升沉浸感

### 3. 玩家輸入系統（Message Action）
- **規則**：
  - 玩家「說話」選項 → Message Action（綠色對話泡泡）
  - 系統指令（如「繼續」「進入廚房」）→ 使用 `【】` 標註
- **目的**：區分角色對話與系統操作

### 4. 動態話題系統
- **規則**：
  - 已完成話題按鈕隱藏
  - 完成任一話題後解鎖「進入廚房」
  - 可自由選擇話題順序（非線性）
- **目的**：增加探索感與重玩價值

### 5. 防鬼打牆機制
- **規則**：
  - 所有階段的 `default` 分支必須提供 Quick Reply 引導
  - 避免「無效輸入 → 卡住 → 鬼打牆」
- **實作**：
  ```javascript
  default:
    showLoadingAnimation(userId, 5);
    replyMessage(replyToken, {
      type: "text",
      text: "【黑貓】「...不太明白你的意思。」",
      quickReply: {
        items: [...]  // 提供有效選項
      }
    });
    return;  // 重要：每個分支都要 return
  ```

---

## 🐛 常見問題與解決

### 問題 1：部署後 Webhook 驗證失敗
**可能原因**：
- GAS 部署設定錯誤（執行身分/存取權）
- Webhook URL 複製錯誤

**解決方法**：
1. 確認部署設定：執行身分 = 我，存取權 = 所有人
2. 重新部署並複製新的 URL
3. 在 LINE Developers 點擊「Verify」測試

---

### 問題 2：用戶輸入後沒有反應
**可能原因**：
- `handleTextMessage` 的路由邏輯有誤
- 某個處理函數沒有 `return`，導致執行流繼續到 `default`

**解決方法**：
1. 使用 `/debug state` 查看當前狀態
2. 檢查 GAS 執行記錄（執行 → 執行記錄）
3. 確認所有 `if/else if` 分支都有 `return`

---

### 問題 3：「做熱茶」後卡住（鬼打牆）
**原因**：`pushMessages` 超過 5 則訊息限制

**解決方法**：
1. 檢查 `getDay1CookingTea_Part1()` 等函數
2. 確保回傳的陣列長度 ≤ 5
3. 合併部分內容或分成多次推送

---

### 問題 4：Loading Animation 沒有顯示
**原因**：
- `loadingSeconds` 不是 5 的倍數
- LINE API URL 或 Header 錯誤

**解決方法**：
1. 確認 `showLoadingAnimation` 函數有自動調整邏輯：
   ```javascript
   seconds = Math.round(seconds / 5) * 5;
   ```
2. 確認 LINE API URL 格式：
   ```javascript
   "https://api.line.me/v2/bot/chat/loading/start"
   ```

---

## 📱 Rich Menu 設定指南（V4.8 新增）

### Rich Menu 佈局

| 左上 (📖 人物紀傳) | 右上 (🎁 遺物圖鑑) |
|------------------|------------------|
| 左下 (📊 靈魂狀態) | 右下 (❓ 遊戲說明) |

### LINE Developers Console 配置

在 LINE Developers Console 的 Rich Menu 設定中，配置以下 4 個按鈕：

#### 按鈕配置（Postback Action）

| 位置 | 按鈕名稱 | Postback Data | 行為 |
|-----|---------|---------------|------|
| 左上 | 📖 人物紀傳 | `OPEN_BIO` | 遊戲中攔截，結局後開放 |
| 右上 | 🎁 遺物圖鑑 | `OPEN_HEIRLOOM` | 遊戲中攔截，結局後開放 |
| 左下 | 📊 靈魂狀態 | `OPEN_STATUS` | 隨時可開 |
| 右下 | ❓ 遊戲說明 | `OPEN_HELP` | 隨時可開 |

#### Rich Menu JSON 範例

```json
{
  "size": {
    "width": 2500,
    "height": 1686
  },
  "areas": [
    {
      "bounds": { "x": 0, "y": 0, "width": 1250, "height": 843 },
      "action": {
        "type": "postback",
        "data": "OPEN_BIO",
        "displayText": "查看人物紀傳"
      }
    },
    {
      "bounds": { "x": 1250, "y": 0, "width": 1250, "height": 843 },
      "action": {
        "type": "postback",
        "data": "OPEN_HEIRLOOM",
        "displayText": "查看遺物圖鑑"
      }
    },
    {
      "bounds": { "x": 0, "y": 843, "width": 1250, "height": 843 },
      "action": {
        "type": "postback",
        "data": "OPEN_STATUS",
        "displayText": "查看靈魂狀態"
      }
    },
    {
      "bounds": { "x": 1250, "y": 843, "width": 1250, "height": 843 },
      "action": {
        "type": "postback",
        "data": "OPEN_HELP",
        "displayText": "查看遊戲說明"
      }
    }
  ]
}
```

### 分級管制機制

- **🔴 沉浸破壞型**（人物紀傳、遺物圖鑑）
  - 遊戲進行中（Day/Cooking 階段）黑貓會攔截
  - 結局後（After 階段）開放查看
  
- **🟢 工具輔助型**（靈魂狀態、遊戲說明）
  - 隨時可開，不會攔截
  - 所有 Flex Card 底部都有「回到遊戲」按鈕

### 回程票系統

當玩家查看圖鑑後，點擊「回到遊戲」按鈕，系統會自動重新發送當前階段的遊戲畫面（話題選單或料理介面），解決「洗版後找不到選項」的問題。

### Debug 指令（測試用）

| 指令 | 功能 |
|-----|------|
| `/debug richmenu` | 顯示所有 Rich Menu 測試指令 |
| `/debug bio` | 強制顯示人物紀傳（忽略攔截） |
| `/debug heirloom` | 強制顯示遺物圖鑑（忽略攔截） |
| `/debug status` | 顯示靈魂狀態面板 |
| `/debug help` | 顯示遊戲說明 |
| `/debug restore` | 測試回程票功能 |
| `/debug phase` | 顯示當前階段詳情 |
| `/debug setphase [day] [phase]` | 設定階段（如 `/debug setphase 2 cooking`） |

---

## 🔮 未來規劃：LIFF 廚房小遊戲

### 設計概念

將廚房料理從「文字選擇」升級為「拖曳調配」的互動體驗。

### 核心玩法

1. **記憶托盤**：左側顯示所有已收集的記憶 icon（永久可用，不消耗）
2. **靈魂之鍋**：中央的料理鍋，顯示實時的五味光譜
3. **拖曳注入**：玩家拖曳記憶 icon 到鍋中，觀察五味變化
4. **調味挑戰**：黑貓給出目標（「他現在需要甜一點」），玩家調配至完美平衡

### 技術方案

- **平台**：LINE LIFF v2
- **前端**：HTML5 + CSS3 + Vanilla JS（或 Vue.js）
- **後端**：Google Apps Script Web App API
- **數據流**：LIFF 讀取 userId → 調用 GAS API 獲取 userState → 實時計算五味

### 不在 MVP 範圍的原因

1. **開發成本**：需要前端網頁開發 + API 架設，約增加 2-3 週工時
2. **風險**：在驗證核心敘事前投入過多技術，可能偏離重點
3. **替代方案**：當前的 Flex Message 選單已足夠完成 MVP 驗證

### 啟動條件

當滿足以下條件時，考慮開發 LIFF：
- [ ] 至少 50 名玩家完成 Guest 1 全流程
- [ ] 玩家反饋中超過 30% 提到「希望有更多互動」
- [ ] 已完成 Guest 2-3 的劇本開發

---

## 📚 相關文件

### 核心文件
- [[../../00-核心企劃/當前專案_靈魂食堂/靈魂食堂：最終開發執行企劃書]] - 完整世界觀與設計
- [[../../00-工作區/主 Backlog_2026-01-15]] - 任務清單與優先級
- [[../../00-工作區/工作報告_2026-01-22_UX全面改進]] - 最新進度

### 劇本文件
- [[../../02-劇本設計/Guest1_田中太郎_重構版_神秘感優先]] - 完整劇本（1712 行）

### 技術文件
- [[專案實作對照表]] - 企劃與代碼映射
- [[敏感文件同步指南]] - 安全規範
- [[../../00-核心企劃/開發決策鏈]] - 決策歷史

---

## 🎯 下一步開發計畫

### P0（本週）
- [x] Rich Menu UX 系統（分級管制 + 回程票）✅ V4.8 完成
- [ ] Day 2-3 動態話題系統擴展
- [ ] 修正剩餘小 Bug

### P1（兩週內）
- [ ] 記憶食材視覺化（Flex Card 設計）
- [ ] Day 2 夢境場景完整實作
- [ ] Day 3 最終料理與告別儀式

### P2（一個月內）
- [ ] Guest 2 劇本撰寫
- [ ] LIFF 廚房小遊戲原型（見上方未來規劃章節）
- [ ] 完整測試與問卷收集

---

**維護者**：專案負責人  
**狀態**：✅ 可立即部署使用

