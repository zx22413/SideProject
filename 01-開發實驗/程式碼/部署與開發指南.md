# 靈魂食堂 - 部署與開發指南

> **當前版本**：V4.3（田中太郎重構版）  
> **最後更新**：2026-01-21  
> **狀態**：✅ 已部署並測試成功

---

## 📁 代碼文件說明

### 主要文件

#### `靈魂食堂_田中太郎重構版.gs` ✅ **正式部署版本**
- **版本**：V4.3（2026-01-21）
- **行數**：~3488 行
- **狀態**：✅ 部署並測試成功，Day 1-3 完整流程通過
- **特色**：
  - ✅ UX 全面優化（Loading Animation + 訊息分段）
  - ✅ 玩家輸入系統（Message Action）
  - ✅ Day 1 動態話題系統
  - ✅ 記憶即食材系統
  - ✅ 防鬼打牆機制（Quick Reply 引導）
  - ✅ 完整的 DEBUG 模式

#### `靈魂食堂_畫鬼腳MVP.gs`
- **版本**：V4.1（2026-01-18）
- **狀態**：測試版本
- **用途**：快速驗證敘事體驗的簡化版本
- **特色**：3天9條路徑的畫鬼腳結構

#### `config.template.gs`
- **用途**：配置文件模板
- **包含**：LINE Token、Sheets ID 等敏感資訊的格式範例
- **注意**：實際配置不要上傳到 Git

---

## 🚀 快速部署（10 分鐘上線）

### 步驟 1：準備 Google Sheets

1. 建立新的 Google Sheets 試算表
2. 創建以下 Sheet（分頁）：

#### Sheet: `userState`（用戶狀態）
| 欄位 | 說明 | 範例 |
|------|------|------|
| A: userId | LINE User ID | `U1234567890abcdef` |
| B: currentDay | 當前天數（1-3） | `1` |
| C: phase | 當前階段 | `night`, `day`, `cooking`, `after` |
| D: guestID | 客人編號 | `tanaka` |
| E: collectedMemories | 已收集記憶（JSON陣列） | `["hands","window_rain"]` |
| F: topicsDone | 已完成話題（JSON陣列） | `["hands_part1","hands_part2"]` |
| G: lastActive | 最後活躍時間 | `2026-01-22 10:30:00` |
| H: completedGuests | 已完成客人（JSON陣列） | `["tanaka"]` |
| I: inventory | 物品庫存（JSON物件） | `{"tea":1}` |
| J: lifetimeHeirlooms | 累計遺物數 | `3` |

**標題行範例**：
```
userId | currentDay | phase | guestID | collectedMemories | topicsDone | lastActive | completedGuests | inventory | lifetimeHeirlooms
```

---

### 步驟 2：部署到 Google Apps Script

1. 開啟 [Google Apps Script](https://script.google.com/)
2. 新增專案 → 命名為「靈魂食堂」
3. 刪除預設的 `Code.gs`
4. 複製 `靈魂食堂_田中太郎重構版.gs` 的**完整內容**
5. 貼上到編輯器
6. 修改以下兩個配置：
   ```javascript
   var SPREADSHEET_ID = "你的_Google_Sheets_ID";
   var TOKEN = "你的_LINE_Channel_Access_Token";
   ```

7. 儲存（Ctrl+S）

---

### 步驟 3：部署為 Web App

1. 點擊右上角「部署」→「新增部署作業」
2. 類型選擇「網頁應用程式」
3. 設定：
   - **執行身分**：我
   - **存取權**：所有人
4. 點擊「部署」
5. 複製「網頁應用程式 URL」（這就是你的 Webhook URL）

---

### 步驟 4：設定 LINE Webhook

1. 前往 [LINE Developers Console](https://developers.line.biz/)
2. 選擇你的 Messaging API Channel
3. 到「Messaging API」頁籤
4. 在「Webhook settings」區塊：
   - 貼上剛才複製的 Web App URL
   - 點擊「Verify」測試連線
   - 開啟「Use webhook」開關
5. 確認「Auto-reply messages」和「Greeting messages」都關閉（否則會衝突）

---

### 步驟 5：測試

在 LINE OA 對話框中輸入：

```
/debug state
```

如果回傳用戶狀態（JSON 格式），代表部署成功！

接著輸入：
```
/debug reset
```

重置狀態後即可開始遊戲。

---

## 🧪 DEBUG 指令集

### 基本指令

| 指令 | 功能 | 範例 |
|------|------|------|
| `/debug state` | 查看當前狀態 | - |
| `/debug reset` | 重置遊戲（回到 Day 1 Night） | - |

### 遊戲流程指令

| 指令 | 功能 | 用途 |
|------|------|------|
| `觀察他` | Day 1 Night 開始遊戲 | 觸發第一段劇情 |
| `你的手` | Day 1 Day 話題選擇 | 進入「手」話題分支 |
| `你從哪裡來？` | Day 1 Day 話題選擇 | 進入「來歷」話題分支 |
| `窗外一直在下雨...` | Day 1 Day 話題選擇 | 進入「雨」話題分支 |
| `【靜靜陪伴】` | Day 1 Day 話題選擇 | 進入「陪伴」話題分支 |
| `【進入廚房】` | Day 1 Day 進入烹飪階段 | 需至少完成一個話題 |
| `做熱茶` | Day 1 Cooking 選擇料理 | 烹飪場景 |
| `做熱湯` | Day 1 Cooking 選擇料理 | 烹飪場景 |
| `【繼續】` | 通用繼續指令 | 推進劇情 |

---

## 🛠️ 技術架構

### 核心系統

#### 1. 狀態管理系統
- **函數**：`getUserState(userId)`, `updateUserState(userId, newState)`
- **說明**：從 Google Sheets 讀取/寫入用戶狀態
- **快取**：無（每次都從 Sheets 讀取，確保一致性）

#### 2. 階段路由系統
- **函數**：`handleTextMessage(event, userId, userText)`
- **說明**：根據 `currentDay` 和 `phase` 路由到對應的處理函數
- **路由邏輯**：
  ```
  Day 1 + night   → handleDay1Night
  Day 1 + day     → handleDay1Day
  Day 1 + cooking → handleDay1Cooking
  Day 1 + after   → handleDay1After
  （Day 2-3 類似）
  ```

#### 3. 動態 UI 生成系統
- **函數**：`getDay1DayShift(state)`, `getDay1CookingScene(state)`
- **說明**：根據用戶狀態動態生成 Flex Message
- **特色**：已完成的話題按鈕會隱藏，解鎖新選項

#### 4. 訊息推送系統
- **函數**：`pushMessages(userId, messages)`, `replyMessage(replyToken, message)`
- **說明**：分段推送訊息（最多 5 則），支援 Loading Animation
- **Loading**：`showLoadingAnimation(userId, seconds)`

#### 5. 記憶收集系統
- **函數**：`addMemory(userId, state, memory)`, `addTopic(userId, state, topic)`
- **說明**：收集玩家的對話選擇，作為「記憶食材」

---

## 📋 主要函數說明

### 入口函數

#### `doPost(e)`
- **說明**：LINE Webhook 入口
- **處理**：解析 LINE 事件，路由到對應處理函數

### 狀態管理

#### `getUserState(userId)`
- **回傳**：用戶狀態物件（從 Sheets 讀取）
- **預設狀態**：
  ```javascript
  {
    userId: userId,
    currentDay: 1,
    phase: "night",
    guestID: "tanaka",
    collectedMemories: [],
    topicsDone: [],
    lastActive: new Date(),
    completedGuests: [],
    inventory: {},
    lifetimeHeirlooms: 0
  }
  ```

#### `updateUserState(userId, newState)`
- **說明**：更新用戶狀態到 Sheets
- **操作**：找到該 userId 的行，更新對應欄位

### 階段處理函數

#### `handleDay1Night(event, userId, state, userText)`
- **說明**：處理 Day 1 Night 階段
- **觸發**：用戶輸入「觀察他」
- **流程**：
  1. 顯示 Loading Animation
  2. 回傳開場劇情（Flex Card）
  3. 提供「和他聊聊」按鈕（Quick Reply）
  4. 點擊後 → `advancePhase` → 進入 Day 1 Day

#### `handleDay1Day(event, userId, state, userText)`
- **說明**：處理 Day 1 Day 階段（話題選擇）
- **觸發**：
  - 「你的手」→ 觸發「手」話題對話
  - 「你從哪裡來？」→ 觸發「來歷」話題對話
  - 「窗外一直在下雨...」→ 觸發「雨」話題對話
  - 「【靜靜陪伴】」→ 觸發「陪伴」話題對話
  - 「【進入廚房】」→ 進入 Cooking 階段
- **流程**：
  1. 顯示 Loading Animation
  2. 推送分段劇情（`pushMessages`）
  3. 添加記憶（`addMemory`）
  4. 回傳更新後的話題選單（`getDay1DayShift(state)`）

#### `handleDay1Cooking(event, userId, state, userText)`
- **說明**：處理 Day 1 Cooking 階段
- **觸發**：
  - 初次進入 → 顯示廚房場景（`getDay1CookingScene`）
  - 「做熱茶」→ 觸發熱茶烹飪劇情
  - 「做熱湯」→ 觸發熱湯烹飪劇情
- **流程**：
  1. 顯示 Loading Animation
  2. 推送分段烹飪劇情（`pushMessages`，最多 5 則）
  3. 最後一段包含「繼續」Quick Reply
  4. 點擊「繼續」→ `advancePhase` → 進入 After 階段

### 動態 UI 生成

#### `getDay1DayShift(state)`
- **說明**：生成 Day 1 Day Shift 10:00 的 Flex Card
- **邏輯**：
  - 檢查 `state.topicsDone` 陣列
  - 隱藏已完成的話題按鈕
  - 如果 `topicsDone.length > 0`，顯示「進入廚房」按鈕
- **回傳**：Flex Message JSON

#### `getDay1CookingScene(state)`
- **說明**：生成 Day 1 Cooking Time 18:00 的 Flex Card
- **邏輯**：
  - 根據 `state.collectedMemories` 動態生成「記憶食材」清單
  - 顯示「做熱茶」「做熱湯」按鈕
- **回傳**：Flex Message JSON

### 輔助函數

#### `showLoadingAnimation(userId, seconds)`
- **說明**：顯示「正在輸入...」動畫
- **限制**：`seconds` 必須是 5 的倍數（LINE API 限制）
- **自動調整**：`Math.round(seconds / 5) * 5`

#### `pushMessages(userId, messages)`
- **說明**：批量推送訊息（最多 5 則）
- **限制**：LINE Push API 單次最多 5 則訊息
- **注意**：如果超過 5 則會報錯

#### `addMemory(userId, state, memory)`
- **說明**：添加記憶到 `collectedMemories` 陣列
- **去重**：不會重複添加相同記憶

#### `addTopic(userId, state, topic)`
- **說明**：標記話題為已完成
- **去重**：不會重複添加相同話題

#### `advancePhase(event, userId, state)`
- **說明**：推進到下一個階段
- **邏輯**：
  ```
  night → day → cooking → after → (下一天的 night)
  ```
- **自動處理**：Day 3 After 後 → 結束遊戲

---

## 🎨 UX 設計原則（V4.3）

### 1. Loading Animation 策略
- **何時使用**：任何玩家 input 動作都需要
- **時長**：5 秒（短劇情）、10 秒（長劇情）
- **目的**：提供即時反饋，避免「卡住」感

### 2. 訊息分段（Segmented Messages）
- **規則**：
  - 敘事文本：30-80 字/段
  - 左右交替：角色對話（左）→ 玩家思考（右）
  - 最後一段：附帶 Quick Reply「繼續」按鈕
- **目的**：模擬真實對話節奏，提升沉浸感

### 3. 玩家輸入系統（Message Action）
- **規則**：
  - 玩家「說話」選項 → Message Action（綠色對話泡泡）
  - 系統指令（如「繼續」「進入廚房」）→ 使用 `【】` 標註
- **目的**：區分角色對話與系統操作

### 4. 動態話題系統
- **規則**：
  - 已完成話題按鈕隱藏
  - 完成任一話題後解鎖「進入廚房」
  - 可自由選擇話題順序（非線性）
- **目的**：增加探索感與重玩價值

### 5. 防鬼打牆機制
- **規則**：
  - 所有階段的 `default` 分支必須提供 Quick Reply 引導
  - 避免「無效輸入 → 卡住 → 鬼打牆」
- **實作**：
  ```javascript
  default:
    showLoadingAnimation(userId, 5);
    replyMessage(replyToken, {
      type: "text",
      text: "【黑貓】「...不太明白你的意思。」",
      quickReply: {
        items: [...]  // 提供有效選項
      }
    });
    return;  // 重要：每個分支都要 return
  ```

---

## 🐛 常見問題與解決

### 問題 1：部署後 Webhook 驗證失敗
**可能原因**：
- GAS 部署設定錯誤（執行身分/存取權）
- Webhook URL 複製錯誤

**解決方法**：
1. 確認部署設定：執行身分 = 我，存取權 = 所有人
2. 重新部署並複製新的 URL
3. 在 LINE Developers 點擊「Verify」測試

---

### 問題 2：用戶輸入後沒有反應
**可能原因**：
- `handleTextMessage` 的路由邏輯有誤
- 某個處理函數沒有 `return`，導致執行流繼續到 `default`

**解決方法**：
1. 使用 `/debug state` 查看當前狀態
2. 檢查 GAS 執行記錄（執行 → 執行記錄）
3. 確認所有 `if/else if` 分支都有 `return`

---

### 問題 3：「做熱茶」後卡住（鬼打牆）
**原因**：`pushMessages` 超過 5 則訊息限制

**解決方法**：
1. 檢查 `getDay1CookingTea_Part1()` 等函數
2. 確保回傳的陣列長度 ≤ 5
3. 合併部分內容或分成多次推送

---

### 問題 4：Loading Animation 沒有顯示
**原因**：
- `loadingSeconds` 不是 5 的倍數
- LINE API URL 或 Header 錯誤

**解決方法**：
1. 確認 `showLoadingAnimation` 函數有自動調整邏輯：
   ```javascript
   seconds = Math.round(seconds / 5) * 5;
   ```
2. 確認 LINE API URL 格式：
   ```javascript
   "https://api.line.me/v2/bot/chat/loading/start"
   ```

---

## 📚 相關文件

### 核心文件
- [[../../00-核心企劃/當前專案_靈魂食堂/靈魂食堂：最終開發執行企劃書]] - 完整世界觀與設計
- [[../../00-工作區/主 Backlog_2026-01-15]] - 任務清單與優先級
- [[../../00-工作區/工作報告_2026-01-22_UX全面改進]] - 最新進度

### 劇本文件
- [[../../02-劇本設計/Guest1_田中太郎_重構版_神秘感優先]] - 完整劇本（1712 行）

### 技術文件
- [[專案實作對照表]] - 企劃與代碼映射
- [[敏感文件同步指南]] - 安全規範
- [[../../00-核心企劃/開發決策鏈]] - 決策歷史

---

## 🎯 下一步開發計畫

### P0（本週）
- [ ] Day 2-3 動態話題系統擴展
- [ ] 修正剩餘小 Bug（如「做熱茶」後的流程）

### P1（兩週內）
- [ ] 記憶食材視覺化（Flex Card 設計）
- [ ] Day 2 夢境場景完整實作
- [ ] Day 3 最終料理與告別儀式

### P2（一個月內）
- [ ] Guest 2 劇本撰寫
- [ ] Rich Menu 狀態機
- [ ] 完整測試與問卷收集

---

**維護者**：專案負責人  
**狀態**：✅ 可立即部署使用

