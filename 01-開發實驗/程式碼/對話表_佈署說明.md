# 對話表佈署說明（方案 B：CSV 匯入）

對話表用於存放擴充用台詞（第一版邊角料及之後新增），GAS 依 `id` 讀取，組成 `replyMessage` 所需內容。與 userState 使用**同一個 Google 試算表**。

---

## 步驟一：試算表新增工作表

1. 開啟現有後台試算表（即 `SPREADSHEET_ID` 對應的那份，目前 userState 在 `userStateTanaka` 工作表）。
2. 新增一個工作表：**底部「+」或 右鍵 → 新增工作表**。
3. 將新工作表命名為 **「對話表」**（或 `dialogue`，須與 GAS 內 `getSheetByName` 一致）。

---

## 步驟二：匯入 CSV

1. 開啟同目錄下的 **`對話表_第一版範例.csv`**（UTF-8，可含 BOM 以利 Excel 開啟）。
2. **方式 A**：在 Google 試算表「對話表」工作表中，**檔案 → 匯入 → 上傳**，選擇該 CSV，匯入位置選「取代目前的工作表」或「插入新工作表」（若選插入，再將該 Sheet 重新命名為「對話表」）。
3. **方式 B**：用 Excel 或記事本開啟 CSV，複製全部內容，貼到「對話表」工作表第一列（A1）起。
4. 確認**第一列為標題列**：`id,day,phase,speaker,text,quick_reply,next_id,note`，第二列起為資料。

---

## 步驟三：GAS 讀取函數與插入點

在 `.gs` 中新增函數，例如：

```javascript
/**
 * 從「對話表」工作表依 id 取得一筆對話
 * @param {string} id - 對話唯一鍵（如 day1_after_strange）
 * @returns {{ text: string, quickReply?: object } | null}
 */
function getDialogueFromSheet(id) {
  if (!SPREADSHEET_ID) return null;
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName("對話表");
    if (!sheet) return null;
    const data = sheet.getDataRange().getValues();
    const header = data[0];
    const idCol = header.indexOf("id");
    const textCol = header.indexOf("text");
    const qrCol = header.indexOf("quick_reply");
    if (idCol < 0 || textCol < 0) return null;
    for (let i = 1; i < data.length; i++) {
      if (data[i][idCol] === id) {
        const text = (data[i][textCol] != null) ? String(data[i][textCol]) : "";
        let quickReply = undefined;
        if (qrCol >= 0 && data[i][qrCol]) {
          const raw = String(data[i][qrCol]);
          const items = raw.split(";").map(function(s) {
            const parts = s.split("|");
            return { label: (parts[0] || "").trim(), text: (parts[1] || "").trim() };
          }).filter(function(x) { return x.label || x.text; });
          if (items.length > 0) {
            quickReply = { items: items.map(function(it) {
              return { type: "action", action: { type: "message", label: it.label, text: it.text } };
            }) };
          }
        }
        return { text: text, quickReply: quickReply };
      }
    }
    return null;
  } catch (e) {
    Logger.log("getDialogueFromSheet error: " + e);
    return null;
  }
}
```

在需要擴充台詞的插入點呼叫：

- 取得物件後組成一則 LINE 訊息，例如：`{ type: "text", text: row.text, quickReply: row.quickReply }`，放入 `replyMessage(event.replyToken, [...])` 的陣列中，或單獨 `replyMessage(event.replyToken, { type: "text", text: row.text, quickReply: row.quickReply })`。
- 插入點見 [02-劇本設計/邊角料對照表.md](../../02-劇本設計/邊角料對照表.md)（例如 Day 1 After 在 `handleDay1After` 預設分支前先送一組從表讀出的對話，再接「今天就到這吧。明天再說。」）。

---

## 欄位說明

| 欄位 | 說明 |
|------|------|
| id | 唯一鍵，GAS 用於查詢 |
| day | 可選，1/2/3，方便篩選 |
| phase | 可選，night/day/cooking/after |
| speaker | 誰在講（黑貓/老人/主角/系統） |
| text | 內文，多行可用 \n |
| quick_reply | 選項：`label\|text`，多選用 `;` 分隔，例：`繼續\|【繼續】` 或 `聽更多\|【聽更多】;明天繼續\|【明天繼續】` |
| next_id | 可選，下一段 id |
| note | 可選，企劃備註 |
