# Dialogue 擴增劇本佈署說明

dialogue 工作表用於存放擴增劇本，與 `userStateTanaka` 使用**同一個 Google 試算表**（`SPREADSHEET_ID`）。GAS 依 `block_id` 與 `seq` 讀取節點，組成 LINE 訊息與 quickReply。

---

## 步驟一：試算表新增工作表

1. 開啟現有後台試算表（即 `SPREADSHEET_ID` 對應的那份，目前 userState 在 `userStateTanaka` 工作表）。
2. 新增一個工作表：**底部「+」或 右鍵 → 新增工作表**。
3. 將新工作表命名為 **「dialogue」**（須與 GAS 內 `getSheetByName("dialogue")` 一致）。

---

## 步驟二：建立標題列與填入資料

### 標題列（A~F 欄）

| A | B | C | D | E | F |
|---|---|---|---|---|---|
| block_id | seq | system_msg | quick_reply | next_seq | note |

### 填入方式

- **手動填入**：依下表欄位說明逐筆輸入。
- **CSV 匯入**：使用 `dialogue_第一版範例.csv`（UTF-8，可含 BOM 以利 Excel 開啟）。
  - 在「dialogue」工作表中，**檔案 → 匯入 → 上傳**，選擇該 CSV，匯入位置選「取代目前的工作表」。
  - 或複製 CSV 內容，貼到 A1 起，確認第一列為標題列。

---

## 欄位說明

| 欄位 | 說明 | 範例 |
|------|------|------|
| block_id | 對話區塊識別（程式用於路由） | day1_to_day2_transition |
| seq | 節點序號（同 block 內 1,2,3...） | 1 |
| system_msg | 系統訊息。`\n` 會轉成換行（Excel 反斜線若在 LINE 顯示為 ¥，程式會自動處理）。用 `\|\|\|` 可拆成多則訊息 | 【老人】\n窗外什麼都沒有。只有雨。 |
| quick_reply | 選項：`label\|text`，多選用 `;` 分隔 | 繼續\|【繼續】 或 聽更多\|【聽更多】;明天繼續\|【明天繼續】 |
| next_seq | 下一節點 seq。單一值如 `2`；多選時用 `,` 對應各選項，如 `2,3` | 2 或 2,5,7 |
| note | 企劃備註 | 呼吸點／目的二 |

### system_msg 換行與分則

- **換行**：輸入 `\n`（反斜線＋n），程式會轉成實際換行。若 Excel 中反斜線在 LINE 顯示為 `¥`，程式仍會正確解析。
- **做法 A（分訊息傳送）**：同一儲存格內用 `|||` 分隔，會拆成多則訊息分別送出，最後一則帶 quickReply。

### quick_reply 格式

- 單選：`label|text`，例：`繼續|【繼續】`
- 多選：`label1|text1;label2|text2`，例：`你還好嗎?|你還好嗎?看你覺得很疑惑;明天繼續|【明天繼續】`
- `label` 為按鈕顯示文字，`text` 為玩家點擊後傳送的實際文字（用於程式匹配）

### next_seq 多選分支

- **單一值**（如 `2`）：所有選項皆導向 seq 2
- **多值**（如 `2,3`）：第一個選項導向 seq 2，第二個導向 seq 3
- **「明天繼續」**：若選項 text 為 `【明天繼續】` 或 `明天繼續` 或 `明天`，程式會直接推進 Day 2，不需填 next_seq

---

## GAS 讀取

- **函數**：`getDialogueNode(blockId, seq)`
- **職責**：從 dialogue 工作表取得指定 block、seq 的節點，回傳 `{ systemMsg, quickReply, options, nextSeqs }` 或 `null`
- **容錯**：若 dialogue 工作表不存在或無該 block 資料，回傳 `null`，程式會回退到既有硬編碼流程

---

## 插入點（本版實驗）

- **block**：`day1_to_day2_transition`
- **位置**：Day 1 After 結束與 Day 2 Day 開始之間的過渡段
- **流程**：Day 1 料理記憶劇場最後一則訊息直接接入 seq 1 的 quickReply；玩家依序選擇選項推進 seq，直到點選「明天繼續」進入 Day 2
