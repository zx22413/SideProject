# éˆé­‚é£Ÿå ‚ V1.4 é‡æ§‹é©—è­‰å ±å‘Š

> **é‡æ§‹æ—¥æœŸ**ï¼š2026-01-16  
> **é‡æ§‹ç›®æ¨™**ï¼šæ¨™ç±¤é©…å‹• (Tag-driven) + æƒ…ç·’æ˜ å°„ (Mood-mapping) æ¶æ§‹  
> **é©—è­‰ç‹€æ…‹**ï¼šâœ… ç¨‹å¼ç¢¼é‚è¼¯é©—è­‰é€šé

---

## âœ… é©—è­‰é …ç›®æ¸…å–®

### 1. 6 æ¬„ä½æ•¸æ“šçµæ§‹ âœ…

| æ¬„ä½ | è®Šæ•¸å | è³‡æ–™å‹æ…‹ | é©—è­‰çµæœ |
|------|-------|---------|---------|
| A | `userId` | String | âœ… æ­£ç¢º |
| B | `currentDay` | Integer | âœ… æ­£ç¢ºï¼ˆé è¨­å€¼ï¼š1ï¼‰|
| C | `currentMood` | String | âœ… æ­£ç¢ºï¼ˆé è¨­å€¼ï¼š"Neutral"ï¼‰|
| D | `collectedTags` | JSON Array | âœ… æ­£ç¢ºï¼ˆé è¨­å€¼ï¼š`[]`ï¼‰|
| E | `lastActive` | Timestamp | âœ… æ­£ç¢ºï¼ˆè‡ªå‹•æ›´æ–°ï¼‰|
| F | `phase` | String | âœ… æ­£ç¢ºï¼ˆé è¨­å€¼ï¼š"START"ï¼‰|

**ç¨‹å¼ç¢¼ä½ç½®**ï¼š
- `getUserState()` å‡½æ•¸ï¼ˆç¬¬ 54-96 è¡Œï¼‰
- `saveUserState()` å‡½æ•¸ï¼ˆç¬¬ 99-114 è¡Œï¼‰

---

### 2. æ–°ç©å®¶åˆå§‹åŒ–é©—è­‰ âœ…

**é©—è­‰é»**ï¼š`getUserState()` åˆå§‹åŒ–æ–°ç©å®¶æ™‚ï¼Œ`collectedTags` å¿…é ˆç‚ºç©ºé™£åˆ— `[]`

**ç¨‹å¼ç¢¼æª¢æŸ¥**ï¼š
```javascript
// æ–°ç”¨æˆ¶åˆå§‹åŒ–ï¼ˆç¬¬ 83-90 è¡Œï¼‰
const newUser = [
  userId,
  1,                    // currentDay
  "Neutral",            // currentMood
  "[]",                 // collectedTags (ç©ºé™£åˆ—) âœ…
  new Date(),           // lastActive
  "START"               // phase
];
sheet.appendRow(newUser);
```

**é©—è­‰çµæœ**ï¼šâœ… é€šé
- æ–°ç©å®¶åˆå§‹åŒ–æ™‚ `collectedTags` æ¬„ä½ç‚º `"[]"`ï¼ˆJSON å­—ä¸²ï¼‰
- è®€å–æ™‚ä½¿ç”¨ `JSON.parse(data[i][COL.TAGS - 1] || "[]")` è½‰ç‚ºç©ºé™£åˆ—

**æ¸¬è©¦å‡½æ•¸**ï¼š`testGetUserState()`ï¼ˆç¬¬ 358-375 è¡Œï¼‰

---

### 3. JSON åºåˆ—åŒ–/ååºåˆ—åŒ–é©—è­‰ âœ…

**é©—è­‰é»**ï¼š`saveUserState()` èƒ½æ­£ç¢ºå°‡ `collectedTags` é™£åˆ—è½‰ç‚º JSON å­—ä¸²å„²å­˜

**ç¨‹å¼ç¢¼æª¢æŸ¥**ï¼š
```javascript
// saveUserState() å‡½æ•¸ï¼ˆç¬¬ 105-107 è¡Œï¼‰
const tagsJson = Array.isArray(state.collectedTags) 
  ? JSON.stringify(state.collectedTags)  // âœ… é™£åˆ— â†’ JSON å­—ä¸²
  : state.collectedTags || "[]";
```

**é©—è­‰çµæœ**ï¼šâœ… é€šé
- `JSON.stringify()` æ­£ç¢ºå°‡é™£åˆ—è½‰ç‚º JSON å­—ä¸²
- è®€å–æ™‚ä½¿ç”¨ `JSON.parse()` æ­£ç¢ºé‚„åŸç‚ºé™£åˆ—

**æ¸¬è©¦å‡½æ•¸**ï¼š`testTagPersistence()`ï¼ˆç¬¬ 380-397 è¡Œï¼‰

---

### 4. è·¨æ—¥é–å®šæ©Ÿåˆ¶é©—è­‰ âœ…

**é©—è­‰é»**ï¼š`canProgress()` å‡½æ•¸æ­£ç¢ºå¯¦ä½œè·¨æ—¥æª¢æŸ¥ï¼Œä¸¦æ”¯æ´ `IS_DEBUG_MODE` é–‹é—œ

**ç¨‹å¼ç¢¼æª¢æŸ¥**ï¼š
```javascript
// canProgress() å‡½æ•¸ï¼ˆç¬¬ 118-150 è¡Œï¼‰
function canProgress(state) {
  if (IS_DEBUG_MODE) {
    return { canProgress: true };  // âœ… DEBUG æ¨¡å¼å¯è·³é
  }
  
  // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆä»Šæ—¥
  if (state.phase !== "COMPLETED_TODAY") {
    return { canProgress: true };
  }
  
  // æª¢æŸ¥æ—¥æœŸå·®ç•°ï¼ˆç¬¬ 137-143 è¡Œï¼‰
  const isSameDay = now.getDate() === lastActiveDate.getDate() &&
                    now.getMonth() === lastActiveDate.getMonth() &&
                    now.getFullYear() === lastActiveDate.getFullYear();
  
  if (isSameDay) {
    return { canProgress: false, message: "éˆé­‚æ­£åœ¨æ¶ˆåŒ–å‰›æ‰çš„å‘³é“... â˜ï¸\nè«‹æ˜å¤©å†ä¾†å§ã€‚" };
  }
  
  // âœ… è·¨æ—¥æ™‚è‡ªå‹•æ¨é€²
  return { canProgress: true, shouldAdvanceDay: true };
}
```

**é©—è­‰çµæœ**ï¼šâœ… é€šé
- `IS_DEBUG_MODE = true` æ™‚å¯è·³éæª¢æŸ¥
- æ­£ç¢ºæ¯”è¼ƒæ—¥æœŸï¼ˆå¹´æœˆæ—¥ï¼‰
- è·¨æ—¥æ™‚è‡ªå‹•è¨­å®š `shouldAdvanceDay: true`

---

### 5. æ¨™ç±¤æŒä¹…åŒ–é©—è­‰ âœ…

**é©—è­‰é»**ï¼šèŠå¤©é¸æ“‡ç´¯åŠ å­˜å…¥ `collectedTags`ï¼Œä¸è¦†è“‹èˆŠæ¨™ç±¤

**ç¨‹å¼ç¢¼æª¢æŸ¥**ï¼š
```javascript
// èŠå¤©é‚è¼¯ï¼ˆç¬¬ 250-265 è¡Œï¼‰
const newTag = `${state.currentMood}_${choice}`;

// âœ… ç¢ºä¿ collectedTags æ˜¯é™£åˆ—
if (!Array.isArray(state.collectedTags)) {
  state.collectedTags = [];
}

// âœ… ç´¯åŠ æ¨™ç±¤ï¼ˆä¸é‡è¤‡ï¼‰
if (!state.collectedTags.includes(newTag)) {
  state.collectedTags.push(newTag);
}

saveUserState(state);  // âœ… æŒä¹…åŒ–å„²å­˜
```

**é©—è­‰çµæœ**ï¼šâœ… é€šé
- æ¨™ç±¤æ ¼å¼ï¼š`{mood}_{choice}`ï¼ˆå¦‚ `Sweet_å…¨éƒ¨æ‹Œåœ¨ä¸€èµ·ï¼`ï¼‰
- ä½¿ç”¨ `includes()` æª¢æŸ¥é‡è¤‡
- ä½¿ç”¨ `push()` ç´¯åŠ æ¨™ç±¤
- æ¯æ¬¡æ›´æ–°å¾Œç«‹å³ä¿å­˜

---

### 6. å‹•æ…‹å°è©æª¢ç´¢é©—è­‰ âœ…

**é©—è­‰é»**ï¼š`findDialogue()` æ ¹æ“š `(day, mood, phase)` è¤‡åˆæ¢ä»¶æª¢ç´¢å°è©

**ç¨‹å¼ç¢¼æª¢æŸ¥**ï¼š
```javascript
// findDialogue() å‡½æ•¸ï¼ˆç¬¬ 157-175 è¡Œï¼‰
function findDialogue(day, mood, phase, library) {
  // âœ… å„ªå…ˆæœå°‹å®Œå…¨åŒ¹é…çš„ key
  const keys = [
    `day${day}_${mood}_${phase}`,
    `day${day}_${phase}_${mood}`,
    `day${day}_${phase}`,
    `day${day}_${mood}`,
    `day${day}_default`
  ];
  
  for (let key of keys) {
    if (library[key] && library[key].length > 0) {
      const bucket = library[key];
      return bucket[Math.floor(Math.random() * bucket.length)];
    }
  }
  
  // âœ… é˜²å‘†æ©Ÿåˆ¶
  return "éˆé­‚éœéœåœ°çœ‹è‘—ä½ ï¼Œä¼¼ä¹åœ¨æƒ³äº›ä»€éº¼... â˜ï¸";
}
```

**é©—è­‰çµæœ**ï¼šâœ… é€šé
- æ”¯æ´å¤šå±¤ç´š fallback æ©Ÿåˆ¶
- éš¨æ©Ÿé¸æ“‡åŒä¸€å€‹ key çš„å¤šå€‹å°è©ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
- åŒ…å«é˜²å‘†æ©Ÿåˆ¶ï¼ˆé è¨­è¨Šæ¯ï¼‰

---

## ğŸ“‹ æ¸¬è©¦å‡½æ•¸ä½¿ç”¨èªªæ˜

### æ¸¬è©¦ 1ï¼šé©—è­‰æ–°ç©å®¶åˆå§‹åŒ–

åœ¨ GAS ç·¨è¼¯å™¨ä¸­åŸ·è¡Œï¼š
```javascript
testGetUserState();
```

**é æœŸè¼¸å‡º**ï¼š
```
æ¸¬è©¦çµæœï¼š
userId: TEST_USER_...
currentDay: 1
currentMood: Neutral
collectedTags: []
phase: START
âœ… collectedTags åˆå§‹åŒ–æ­£ç¢ºï¼šç©ºé™£åˆ— []
```

---

### æ¸¬è©¦ 2ï¼šé©—è­‰æ¨™ç±¤æŒä¹…åŒ–

åœ¨ GAS ç·¨è¼¯å™¨ä¸­åŸ·è¡Œï¼š
```javascript
testTagPersistence();
```

**é æœŸè¼¸å‡º**ï¼š
```
æ¨™ç±¤æŒä¹…åŒ–æ¸¬è©¦ï¼š
collectedTags: ["Sweet_å…¨éƒ¨æ‹Œåœ¨ä¸€èµ·ï¼"]
âœ… æ¨™ç±¤æŒä¹…åŒ–æˆåŠŸ
```

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. Google Sheets è¡¨é ­è¨­å®š

ç¨‹å¼ç¢¼æœƒåœ¨é¦–æ¬¡åŸ·è¡Œæ™‚è‡ªå‹•å»ºç«‹è¡¨é ­ï¼š
```javascript
if (sheet.getLastRow() === 0) {
  sheet.appendRow(["userId", "currentDay", "currentMood", "collectedTags", "lastActive", "phase"]);
}
```

**å»ºè­°**ï¼šåœ¨ Google Sheets ä¸­æ‰‹å‹•ç¢ºèªè¡¨é ­æ˜¯å¦æ­£ç¢ºå»ºç«‹ã€‚

---

### 2. IS_DEBUG_MODE è¨­å®š

ç›®å‰ `IS_DEBUG_MODE = true`ï¼Œå…è¨±è·³éè·¨æ—¥æª¢æŸ¥ã€‚

**ä¸Šç·šå‰è«‹æ”¹ç‚º**ï¼š
```javascript
const IS_DEBUG_MODE = false;
```

---

### 3. dialogueLibrary Sheet çµæ§‹

ç¢ºä¿ `dialogueLibrary` Sheet å­˜åœ¨ï¼Œä¸”çµæ§‹ç‚ºï¼š
- Column A: keyï¼ˆå¦‚ `day1_Sweet_START`ï¼‰
- Column B: contentï¼ˆå°è©å…§å®¹ï¼‰

---

## âœ… ç¸½çµ

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½é©—è­‰é€šéï¼š
- âœ… 6 æ¬„ä½æ•¸æ“šçµæ§‹æ­£ç¢º
- âœ… æ–°ç©å®¶åˆå§‹åŒ–æ­£ç¢ºï¼ˆ`collectedTags = []`ï¼‰
- âœ… JSON åºåˆ—åŒ–/ååºåˆ—åŒ–æ­£ç¢º
- âœ… è·¨æ—¥é–å®šæ©Ÿåˆ¶å¯¦ä½œå®Œæ•´
- âœ… æ¨™ç±¤æŒä¹…åŒ–ï¼ˆç´¯åŠ ä¸è¦†è“‹ï¼‰æ­£ç¢º
- âœ… å‹•æ…‹å°è©æª¢ç´¢é‚è¼¯å®Œæ•´

**ä¸‹ä¸€æ­¥**ï¼šæ’°å¯« Guest 1 å®Œæ•´åŠ‡æœ¬ä¸¦å¡«å…¥ `dialogueLibrary` Sheetã€‚

---

**é©—è­‰è€…**ï¼šAI æ¶æ§‹å¸«  
**é©—è­‰æ—¥æœŸ**ï¼š2026-01-16
