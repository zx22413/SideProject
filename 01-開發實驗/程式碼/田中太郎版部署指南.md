# 靈魂食堂 - 田中太郎重構版部署指南

> **版本**: 2.0  
> **創建日期**: 2026-01-20  
> **基於**: 畫鬼腳 MVP v1.0  
> **劇本**: 田中太郎重構版（神秘感優先）

---

## 📋 部署前準備

### 1. 需要的資源

- ✅ Google 帳號
- ✅ LINE Developers 帳號
- ✅ LINE Official Account（Messaging API）
- ✅ 田中太郎重構版劇本（已完成）
- ✅ 代碼文件：`靈魂食堂_田中太郎重構版.gs`

### 2. Google Sheets 設置

#### Step 1: 創建新的 Spreadsheet

1. 前往 [Google Sheets](https://sheets.google.com)
2. 創建新的試算表，命名為：`靈魂食堂_田中太郎版`
3. 記下 Spreadsheet ID（從 URL 中複製）
   ```
   https://docs.google.com/spreadsheets/d/【這段就是 ID】/edit
   ```

#### Step 2: 創建 Sheet - userStateTanaka

創建一個名為 `userStateTanaka` 的工作表，欄位結構如下：

| A          | B          | C                         | D                 | E            | F           |
| ---------- | ---------- | ------------------------- | ----------------- | ------------ | ----------- |
| userId     | currentDay | phase                     | collectedMemories | topicsDone   | lastActive  |
| (LINE UID) | (1-3)      | (night/day/cooking/after) | (JSON Array)      | (JSON Array) | (Timestamp) |

**第一行（表頭）**：
```
userId | currentDay | phase | collectedMemories | topicsDone | lastActive
```

**範例數據**（第二行可留空）：
```
U1234567890abcdef | 1 | night | [] | [] | 2026-01-20T10:00:00
```

---

## 🚀 部署步驟

### Step 1: 設置 Google Apps Script

1. 在 Google Sheets 中，點選 **擴充功能** → **Apps Script**
2. 刪除預設的 `Code.gs` 內容
3. 複製 `靈魂食堂_田中太郎重構版.gs` 的全部內容
4. 貼上到編輯器中

### Step 2: 修改配置

找到代碼開頭的配置區：

```javascript
const SPREADSHEET_ID = '1204bJ1DWPWidrYCJlfXF9rnmyyS8vwqFWI9YZuItsoc';
const CONFIG = {
  LINE_CHANNEL_ACCESS_TOKEN: "你的_LINE_CHANNEL_ACCESS_TOKEN",
  SHEET_NAME: "userStateTanaka",
  DEBUG_MODE: true
};
```

**修改以下項目：**
1. `SPREADSHEET_ID`：改為你的 Spreadsheet ID
2. `LINE_CHANNEL_ACCESS_TOKEN`：改為你的 LINE Channel Access Token
3. `SHEET_NAME`：確認為 `userStateTanaka`（如果你用不同名稱請修改）
4. `DEBUG_MODE`：測試時保持 `true`，正式上線後改為 `false`

### Step 3: 部署為 Web App

1. 點選 **部署** → **新增部署作業**
2. 類型選擇：**網頁應用程式**
3. 設定：
   - **執行身分**：我
   - **具有存取權的使用者**：任何人
4. 點選 **部署**
5. **複製 Web App URL**（格式：`https://script.google.com/macros/s/.../exec`）

### Step 4: 設置 LINE Bot Webhook

1. 前往 [LINE Developers Console](https://developers.line.biz/)
2. 選擇你的 Provider 和 Channel
3. 在 **Messaging API** 分頁找到 **Webhook URL**
4. 貼上剛才複製的 Web App URL
5. 點選 **驗證**（應該會成功）
6. 啟用 **Use webhook**

### Step 5: 關閉自動回應

在 LINE Official Account Manager 中：
1. **回應設定** → 關閉 **自動回應訊息**
2. 啟用 **Webhook**

---

## 🧪 測試流程

### 基本測試

1. **測試 1: 開場**
   - 用 LINE 掃描 QR Code 加入 Bot
   - 發送任意訊息
   - 應該看到：極簡神秘開場 + 黑貓登場

2. **測試 2: Day 1 流程**
   - 點選「等等，這裡是...？」
   - 黑貓回應
   - 客人進場
   - 話題選擇：選擇「你的手」
   - 進入廚房
   - 選擇「做熱茶」
   - 看到記憶碎片閃現
   - Day 1 結束

3. **測試 3: Day 2 流程**
   - 點選「明天繼續」
   - Day 2 開場
   - 選擇話題：「那個夢」
   - 看到美雪的記憶
   - 製作蜜汁燉菜
   - 記憶劇場
   - Day 2 結束

4. **測試 4: Day 3 結局**
   - 進入 Day 3
   - 製作最終料理
   - 看到完整真相
   - 告別田中太郎
   - 獲得銀頂針遺物

### 狀態檢查

發送指令 `狀態` 或 `status`，應該看到：
```
Day 1 - night
收集的記憶: 0個
已完成話題: 0個
```

### 重新開始

發送指令 `重新開始` 或 `restart`，可以重置遊戲。

---

## 📊 與畫鬼腳 MVP 的差異

| 特性 | 畫鬼腳 MVP | 田中太郎重構版 |
|------|-----------|--------------|
| **Sheet 欄位** | 3 欄（userId, pathCode, lastActiveDay） | 6 欄（userId, currentDay, phase, collectedMemories, topicsDone, lastActive） |
| **狀態追蹤** | 路徑代碼（A/B/C → A-X/A-Y/A-Z） | 天數 + 時段系統 |
| **記憶系統** | 裝飾性標籤（顯示用） | 真實收集（影響劇情） |
| **時段系統** | 無 | Night → Day → Cooking → After Hours |
| **話題選單** | 固定選項 | 動態解鎖（基於已完成話題） |
| **料理系統** | 固定結局 | 記憶即食材（動態組合） |
| **黑貓角色** | 無 | 老油條店長貓（全程互動） |
| **劇本長度** | ~500 行 | ~1500 行 |

---

## 🔧 常見問題

### Q1: 部署後 LINE Bot 沒反應？

**解決方案：**
1. 檢查 Webhook URL 是否正確
2. 檢查 LINE Channel Access Token 是否正確
3. 檢查 Spreadsheet ID 是否正確
4. 在 Apps Script 中查看 **執行記錄**（Executions）看有無錯誤

### Q2: 收到錯誤訊息「找不到 Sheet」？

**解決方案：**
1. 確認 Sheet 名稱為 `userStateTanaka`（大小寫要一致）
2. 或修改代碼中的 `SHEET_NAME` 配置

### Q3: 用戶狀態沒有儲存？

**解決方案：**
1. 檢查 Sheet 的第一行是否有正確的表頭
2. 檢查 Spreadsheet 權限（Apps Script 應該有寫入權限）
3. 查看 Apps Script 執行記錄

### Q4: Flex Message 顯示不正常？

**解決方案：**
1. 確認 LINE Bot 是在手機上測試（電腦版可能不支援某些功能）
2. 檢查代碼中的 Flex Message JSON 格式是否正確

### Q5: 想要測試多次但不想等 Day 1 → Day 2？

**解決方案：**
1. 發送 `重新開始` 重置狀態
2. 或直接在 Google Sheets 中修改用戶的 `currentDay` 和 `phase`

---

## 🎯 下一步優化

### 優先級 P0
- [ ] 實作 Day 2 的其他話題（你在找什麼、你怎麼來的）
- [ ] 實作 Day 1 的其他話題（你從哪來、窗外的雨、沉默）
- [ ] 實作 Day 1 的熱湯料理路線

### 優先級 P1
- [ ] 增加更多記憶碎片的視覺化（圖片或 GIF）
- [ ] 優化 Flex Message 設計（更美觀的卡片）
- [ ] 增加音效提示（可選）

### 優先級 P2
- [ ] 建立 Guest 2（其他靈魂）
- [ ] 遺物收藏系統
- [ ] 多結局分支（基於不同話題選擇）

---

## 📝 技術細節

### 狀態管理邏輯

```javascript
// 初始化新用戶
{
  currentDay: 1,
  phase: "night",
  collectedMemories: [],
  topicsDone: [],
  lastActive: "2026-01-20T10:00:00"
}

// Day 1 結束後
{
  currentDay: 2,
  phase: "day",
  collectedMemories: ["寒冷", "針", "縫線", "小手捧茶"],
  topicsDone: ["hands"],
  lastActive: "2026-01-20T10:30:00"
}

// Day 3 結束後
{
  currentDay: 3,
  phase: "after",
  collectedMemories: ["寒冷", "針", "縫線", "蜜糖笑容", "女兒-美雪", "婚紗"],
  topicsDone: ["hands", "dream"],
  lastActive: "2026-01-20T11:00:00"
}
```

### 階段推進流程

```
Day 1: night → day → cooking → after → (進入 Day 2)
Day 2: day → cooking → after → (進入 Day 3)
Day 3: cooking → after → (結束)
```

### 話題 → 記憶映射

| 話題 | 解鎖記憶 |
|------|---------|
| hands（Day 1） | 寒冷、針、縫線、裁縫手藝 |
| dream（Day 2） | 蜜糖笑容、女兒-美雪、婚禮 |
| search（Day 2） | 執念、婚紗 |
| death（Day 2） | 雪、死亡、寒冷 |

---

## 📚 相關文件

- **劇本**：`02-劇本設計/Guest1_田中太郎_重構版_神秘感優先.md`
- **企劃書**：`00-核心企劃/當前專案_靈魂食堂/靈魂食堂：最終開發執行企劃書.md`
- **工作報告**：`00-工作區/工作報告_2026-01-19.md`
- **代碼**：`01-開發實驗/程式碼/靈魂食堂_田中太郎重構版.gs`

---

## ✅ 部署檢查清單

- [ ] Google Sheets 已創建（userStateTanaka）
- [ ] Spreadsheet ID 已更新到代碼
- [ ] LINE Channel Access Token 已更新到代碼
- [ ] Apps Script 已部署為 Web App
- [ ] Webhook URL 已設置到 LINE Developers
- [ ] LINE 自動回應已關閉
- [ ] 基本測試已通過（開場 → Day 1 → Day 2 → Day 3）
- [ ] 狀態指令測試正常
- [ ] 重新開始指令測試正常

---

**部署完成！🎉**

現在可以開始體驗田中太郎的故事了。

如果遇到問題，請查看：
1. Apps Script 執行記錄
2. Google Sheets 的用戶狀態數據
3. LINE Developers Console 的 Webhook 日誌
