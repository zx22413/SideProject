# å°ˆæ¡ˆå¯¦ä½œå°ç…§è¡¨ï¼šéˆé­‚é£Ÿå ‚çš„æ•˜äº‹-æŠ€è¡“æ˜ å°„æ‰‹å†Š

> **æ–‡ä»¶æ€§è³ª**ï¼šé–‹ç™¼è–ç¶“ï¼ˆDev Bibleï¼‰  
> **ç›®æ¨™è®€è€…**ï¼šé–‹ç™¼è€…ã€åŠ‡æœ¬ç·¨å¯«è€…ã€æ¸¬è©¦äººå“¡  
> **ç¶­è­·åŸå‰‡**ï¼šä¼åŠƒæ¦‚å¿µæ›´æ–°æ™‚ï¼Œæ­¤è¡¨å¿…é ˆåŒæ­¥æ›´æ–°  
> **å»ºç«‹æ—¥æœŸ**ï¼š2026-01-15

---

## ğŸ¯ æ–‡ä»¶ç›®çš„

æœ¬æ–‡ä»¶è§£æ±ºã€Œä¼åŠƒã€èˆ‡ã€Œä»£ç¢¼ã€ä¹‹é–“çš„**èªç¾©é´»æº**ã€‚  
ç•¶ä¼åŠƒèªªã€Œä¾›å¥‰æ–™ç†ã€æ™‚ï¼Œé–‹ç™¼è€…å¿…é ˆçŸ¥é“é€™å°æ‡‰åˆ°å“ªå€‹è³‡æ–™æ¬„ä½ã€è§¸ç™¼å“ªå€‹å‡½æ•¸ã€‚  
ç•¶ä»£ç¢¼æ‹‹å‡ºéŒ¯èª¤æ™‚,ä¼åŠƒå¿…é ˆçŸ¥é“é€™å½±éŸ¿å“ªå€‹æ•˜äº‹ç’°ç¯€ã€‚

---

## ğŸ“Š æ ¸å¿ƒè³‡æ–™çµæ§‹æ˜ å°„

### ä¸€ã€Google Sheets æ¶æ§‹ç¸½è¦½

```
SPREADSHEET: "Cloudy V1.4 â†’ éˆé­‚é£Ÿå ‚" 
â”œâ”€â”€ Sheet 1: userState (ç©å®¶ç‹€æ…‹)
â”œâ”€â”€ Sheet 2: dialogueLibrary (å°è©åº«)
â”œâ”€â”€ Sheet 3: recipeDatabase (é£Ÿè­œè³‡æ–™åº«)
â”œâ”€â”€ Sheet 4: heirlooms (éºç‰©æ”¶è—)
â””â”€â”€ Sheet 5: guestConfig (éˆé­‚é…ç½®)
```

---

### äºŒã€userState Sheetï¼šç©å®¶ç‹€æ…‹è¿½è¹¤è¡¨

#### å®Œæ•´æ¬„ä½å®šç¾©

| æ¬„ä½ | è®Šæ•¸å | è³‡æ–™å‹æ…‹ | ä¼åŠƒæ¦‚å¿µ | ç¯„ä¾‹å€¼ | æ›´æ–°æ™‚æ©Ÿ |
|------|-------|---------|---------|--------|---------|
| **A** | `userId` | String | ç©å®¶çš„ LINE UID | `U1234567890abcdef` | é¦–æ¬¡åŠ å…¥æ™‚ |
| **B** | `currentDay` | Integer (1-3) | ç•¶å‰æ˜¯ç¬¬å¹¾å¤©è€ƒå¤ | `2` | æ¯æ—¥é‡ç½®æ™‚ |
| **C** | `guestID` | String | ç•¶å‰æ¥å¾…çš„éˆé­‚ç·¨è™Ÿ | `guest1` | æ¥å®¢æ™‚æŒ‡æ´¾ |
| **D** | `collectedTags` | JSON Array | æ”¶é›†åˆ°çš„æ„Ÿå®˜/è¨˜æ†¶æ¨™ç±¤ | `["warmth","softness"]` | æ¯æ¬¡äº’å‹•å¾Œ |
| **E** | `lastActive` | Timestamp | æœ€å¾Œäº’å‹•æ™‚é–“ï¼ˆé˜²æ­¢è·³æ—¥ï¼‰ | `2026-01-15 23:45:00` | æ¯æ¬¡ç™¼é€è¨Šæ¯ |
| **F** | `unlockedRecipe` | String | å·²è§£é–çš„æ–™ç†åç¨± | `lamb_soup_grandma` | Day 2 è¨˜æ†¶è§£é–æ™‚ |
| **G** | `phase` | Enum | ç•¶å‰éšæ®µ | `sensory` / `memory` / `cooking` | åˆ‡æ›éšæ®µæ™‚ |
| **H** | `inventory` | JSON Object | ç‰©å“åº«å­˜ï¼ˆé£Ÿæï¼‰ | `{"lamb":1,"carrot":2}` | ç²å¾—/æ¶ˆè€—é£Ÿææ™‚ |
| **I** | `completedGuests` | JSON Array | å·²è¶…æ¸¡çš„éˆé­‚åˆ—è¡¨ | `["guest1","guest2"]` | éˆé­‚é›¢é–‹æ™‚ |
| **J** | `lifetimeHeirlooms` | Integer | ç´¯è¨ˆç²å¾—çš„éºç‰©æ•¸é‡ | `5` | ç²å¾—éºç‰©æ™‚ |

#### ä¼åŠƒ-ä»£ç¢¼æ˜ å°„ç¯„ä¾‹

**ä¼åŠƒéœ€æ±‚**ï¼šã€Œç•¶ç©å®¶å®Œæˆ Day 2 çš„è¨˜æ†¶è§£é–å¾Œï¼Œé€²å…¥ Day 3 çš„çƒ¹é£ªéšæ®µã€

**ä»£ç¢¼å¯¦ç¾**ï¼š
```javascript
// æª¢æŸ¥æ¢ä»¶
const currentDay = userSheet.getRange(userRow, 2).getValue(); // B æ¬„
const unlockedRecipe = userSheet.getRange(userRow, 6).getValue(); // F æ¬„

if (currentDay === 2 && unlockedRecipe !== "") {
  // æ›´æ–°éšæ®µåˆ°ã€Œçƒ¹é£ªã€
  userSheet.getRange(userRow, 7).setValue("cooking"); // G æ¬„
  
  // æ¨é€²åˆ° Day 3
  userSheet.getRange(userRow, 2).setValue(3); // B æ¬„
  
  // ç™¼é€é€šçŸ¥
  sendPushMessage(userId, "ä¸»äºº...æˆ‘èåˆ°äº†é‚£é“æ–™ç†çš„é¦™å‘³ã€‚ä»Šå¤©å¯ä»¥è©¦è‘—åšåšçœ‹å—ï¼Ÿ");
}
```

---

### ä¸‰ã€dialogueLibrary Sheetï¼šå°è©åº«æ¨™ç±¤ç³»çµ±

#### å‘½åè¦ç¯„ï¼ˆNaming Conventionï¼‰

**æ ¼å¼**ï¼š`{guestID}_day{X}_{context}_{variant}`

| éƒ¨åˆ† | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|
| `guestID` | éˆé­‚ç·¨è™Ÿï¼ˆå°æ‡‰ guestConfigï¼‰ | `guest1` |
| `day{X}` | ç¬¬å¹¾å¤©çš„åŠ‡æƒ… | `day1`, `day2`, `day3` |
| `context` | æƒ…å¢ƒæ¨™è­˜ | `entry`ï¼ˆé€²å ´ï¼‰, `warmth`ï¼ˆæ¨™ç±¤ï¼‰, `memory`ï¼ˆå›æ†¶ï¼‰ |
| `variant` | è®Šé«”ï¼ˆè‹¥æœ‰å¤šå€‹ç‰ˆæœ¬ï¼‰ | `_A`, `_B`, æˆ–çœç•¥ |

#### å®Œæ•´æ¬„ä½å®šç¾©

| æ¬„ä½ | è®Šæ•¸å | ä¼åŠƒæ¦‚å¿µ | ç¯„ä¾‹å€¼ | èªªæ˜ |
|------|-------|---------|--------|------|
| **A** | `key` | å°è©çš„å”¯ä¸€è­˜åˆ¥ç¢¼ | `guest1_day1_warmth` | ç”¨æ–¼ç¨‹å¼æŸ¥è©¢ |
| **B** | `content` | å°è©±æ–‡æœ¬ | `ã€Œé€™å€‹æº«åº¦...å¥½åƒåœ¨å“ªè£¡...ã€` | å¯¦éš›é¡¯ç¤ºçš„å…§å®¹ |
| **C** | `required_tags` | è§¸ç™¼æ¢ä»¶ï¼ˆç©å®¶å¿…é ˆæ“æœ‰çš„æ¨™ç±¤ï¼‰ | `["warmth"]` | JSON é™£åˆ— |
| **D** | `unlock_tags` | è§£é–çå‹µï¼ˆæ–°å¢åˆ°ç©å®¶æ¨™ç±¤ï¼‰ | `["memory_tea"]` | JSON é™£åˆ— |
| **E** | `emotion` | æƒ…ç·’æ¨™è¨˜ï¼ˆä¾› NLP åˆ†ææˆ–è¦–è¦ºæ•ˆæœï¼‰ | `sad` / `happy` / `neutral` | Enum |
| **F** | `next_scene` | ä¸‹ä¸€å€‹åŠ‡æƒ…ç¯€é»ï¼ˆè‹¥ç‚ºç·šæ€§ï¼‰ | `guest1_day1_followup` | å¯é¸ |
| **G** | `media_url` | é™„åŠ çš„åœ–ç‰‡/éŸ³æ•ˆ URL | `https://...` | å¯é¸ï¼ˆFlex Message ç”¨ï¼‰ |

#### ä¼åŠƒ-ä»£ç¢¼æ˜ å°„ç¯„ä¾‹

**ä¼åŠƒéœ€æ±‚**ï¼šã€Œç•¶ç©å®¶åœ¨ Day 1 æ”¶é›†åˆ°ã€æº«æš–ã€æ¨™ç±¤å¾Œï¼Œéˆé­‚æœƒè§¸ç™¼é—œæ–¼ç†±èŒ¶çš„å°è©±ã€

**dialogueLibrary è¨­å®š**ï¼š

| key | content | required_tags | unlock_tags | emotion |
|-----|---------|---------------|-------------|---------|
| `guest1_day1_warmth` | `ã€Œï¼ˆæ¥éèŒ¶æ¯ï¼‰...é€™å€‹æº«åº¦...ã€` | `["warmth"]` | `["memory_tea"]` | `nostalgic` |

**ä»£ç¢¼æŸ¥è©¢é‚è¼¯**ï¼š
```javascript
function findMatchingDialogue(guestID, day, userTags) {
  const library = getDialogueLibrary();
  const prefix = `${guestID}_day${day}_`;
  
  for (let key in library) {
    if (!key.startsWith(prefix)) continue;
    
    const entry = library[key];
    const required = JSON.parse(entry.required_tags || "[]");
    
    // æª¢æŸ¥ç©å®¶æ˜¯å¦æ“æœ‰æ‰€æœ‰å¿…éœ€æ¨™ç±¤
    const hasAllTags = required.every(tag => userTags.includes(tag));
    
    if (hasAllTags) {
      return {
        key: key,
        content: entry.content,
        unlock: JSON.parse(entry.unlock_tags || "[]"),
        emotion: entry.emotion
      };
    }
  }
  
  // è‹¥ç„¡åŒ¹é…ï¼Œè¿”å›é è¨­å°è©±
  return library[`${guestID}_day${day}_default`];
}
```

---

### å››ã€recipeDatabase Sheetï¼šæ–™ç†åˆæˆè¦å‰‡è¡¨

#### å®Œæ•´æ¬„ä½å®šç¾©

| æ¬„ä½ | è®Šæ•¸å | ä¼åŠƒæ¦‚å¿µ | ç¯„ä¾‹å€¼ | èªªæ˜ |
|------|-------|---------|--------|------|
| **A** | `recipeID` | æ–™ç†çš„å”¯ä¸€è­˜åˆ¥ç¢¼ | `lamb_soup_grandma` | å°æ‡‰ unlockedRecipe |
| **B** | `displayName` | æ–™ç†çš„é¡¯ç¤ºåç¨± | `ã€å¥¶å¥¶çš„ç¾Šè‚‰æ¹¯ã€‘` | çµ¦ç©å®¶çœ‹çš„ |
| **C** | `physical_ingredients` | ç‰©ç†é£Ÿæï¼ˆå¯å¾ inventory å–å¾—ï¼‰ | `{"lamb":1,"carrot":1}` | JSON Object |
| **D** | `abstract_ingredients` | æŠ½è±¡é£Ÿæï¼ˆå¾æ¨™ç±¤è½‰æ›ï¼‰ | `{"warmth":1}` | JSON Object |
| **E** | `cookingSteps` | çƒ¹é£ªæ­¥é©Ÿï¼ˆè‹¥æœ‰å°éŠæˆ²ï¼‰ | `[{"question":"ç«å€™?","answer":"å°ç«"}]` | JSON Array |
| **F** | `successText` | çƒ¹é£ªæˆåŠŸçš„æè¿° | `ã€Œæ¹¯æ±è½‰ç‚ºç¥ç€è‰²...ã€` | æ„Ÿå®˜æå¯« |
| **G** | `failText` | çƒ¹é£ªå¤±æ•—çš„æè¿° | `ã€Œæ¹¯ç‡’ç„¦äº†...ã€` | å¤±æ•—æç¤º |
| **H** | `flashbackScenes` | è¨˜æ†¶åŠ‡å ´çš„å ´æ™¯ ID åˆ—è¡¨ | `["scene1","scene2","scene3"]` | å°æ‡‰ Flex Carousel |
| **I** | `heirloomID` | å®Œæˆå¾Œç²å¾—çš„éºç‰© | `recipe_card_1` | å°æ‡‰ heirlooms sheet |

#### ä¼åŠƒ-ä»£ç¢¼æ˜ å°„ç¯„ä¾‹

**ä¼åŠƒéœ€æ±‚**ï¼šã€Œç©å®¶éœ€è¦ 1 å€‹ç¾Šè‚‰ + 1 å€‹è˜¿è”” + ã€æº«æš–ã€çš„æƒ…æ„Ÿæ‰èƒ½åšå‡ºå¥¶å¥¶çš„ç¾Šè‚‰æ¹¯ã€

**recipeDatabase è¨­å®š**ï¼š

| recipeID | displayName | physical_ingredients | abstract_ingredients |
|----------|-------------|---------------------|----------------------|
| `lamb_soup_grandma` | `ã€å¥¶å¥¶çš„ç¾Šè‚‰æ¹¯ã€‘` | `{"lamb":1,"carrot":1}` | `{"warmth":1}` |

**ä»£ç¢¼é©—è­‰é‚è¼¯**ï¼š
```javascript
function canCookRecipe(userId, recipeID) {
  const userInventory = JSON.parse(userSheet.getRange(userRow, 8).getValue()); // H æ¬„
  const userTags = JSON.parse(userSheet.getRange(userRow, 4).getValue()); // D æ¬„
  
  const recipe = getRecipeByID(recipeID);
  const physicalReq = JSON.parse(recipe.physical_ingredients);
  const abstractReq = JSON.parse(recipe.abstract_ingredients);
  
  // æª¢æŸ¥ç‰©ç†é£Ÿæ
  for (let item in physicalReq) {
    if ((userInventory[item] || 0) < physicalReq[item]) {
      return { canCook: false, reason: `ç¼ºå°‘é£Ÿæï¼š${item}` };
    }
  }
  
  // æª¢æŸ¥æŠ½è±¡é£Ÿæï¼ˆæ¨™ç±¤ï¼‰
  for (let tag in abstractReq) {
    if (!userTags.includes(tag)) {
      return { canCook: false, reason: `ç¼ºå°‘æƒ…æ„Ÿå…ƒç´ ï¼š${tag}` };
    }
  }
  
  return { canCook: true };
}
```

---

### äº”ã€heirlooms Sheetï¼šéºç‰©æ”¶è—ç³»çµ±

#### å®Œæ•´æ¬„ä½å®šç¾©

| æ¬„ä½ | è®Šæ•¸å | ä¼åŠƒæ¦‚å¿µ | ç¯„ä¾‹å€¼ |
|------|-------|---------|--------|
| **A** | `userId` | æ“æœ‰è€… | `U1234567890abcdef` |
| **B** | `guestID` | ä¾†è‡ªå“ªä½éˆé­‚ | `guest1` |
| **C** | `heirloomID` | éºç‰©è­˜åˆ¥ç¢¼ | `recipe_card_1` |
| **D** | `displayName` | é¡¯ç¤ºåç¨± | `ã€å¥¶å¥¶çš„é£Ÿè­œã€‘` |
| **E** | `description` | æè¿°æ–‡æœ¬ | `ã€Œè¦ç”¨å°ç«æ…¢ç‡‰...ã€` |
| **F** | `obtainedAt` | ç²å¾—æ™‚é–“ | `2026-01-15 23:59:59` |
| **G** | `rarity` | ç¨€æœ‰åº¦ï¼ˆå¯é¸ï¼‰ | `common` / `rare` / `legendary` |

#### ä¼åŠƒæ„ç¾©
- **åœ–é‘‘ç³»çµ±**ï¼šç©å®¶å¯ä»¥å›é¡§æ‰€æœ‰é€èµ°çš„éˆé­‚
- **é€²åº¦çå‹µ**ï¼šæ”¶é›† 10 å€‹éºç‰©è§£é–ã€Œè€é—†çš„ç§˜å¯†ã€åŠ‡æƒ…
- **ç¤¾äº¤ç‚«è€€**ï¼šç”Ÿæˆç²¾ç¾å¡ç‰‡åˆ†äº«åˆ° LINE ç¾¤çµ„

---

### å…­ã€guestConfig Sheetï¼šéˆé­‚é…ç½®è¡¨

#### å®Œæ•´æ¬„ä½å®šç¾©

| æ¬„ä½ | è®Šæ•¸å | ä¼åŠƒæ¦‚å¿µ | ç¯„ä¾‹å€¼ |
|------|-------|---------|--------|
| **A** | `guestID` | éˆé­‚ç·¨è™Ÿ | `guest1` |
| **B** | `displayName` | é¡¯ç¤ºåç¨±ï¼ˆåˆå§‹ç‚º ???ï¼‰ | `ã€Œ??? è™Ÿéˆé­‚ã€` |
| **C** | `realName` | çœŸå¯¦å§“åï¼ˆDay 2 è§£é–ï¼‰ | `ã€Œç”°ä¸­å¤ªéƒã€` |
| **D** | `avatar_url` | è§’è‰²å‰ªå½±åœ– | `https://...` |
| **E** | `backstory` | èƒŒæ™¯æ•…äº‹ï¼ˆä¼åŠƒå‚™è¨»ï¼‰ | `ã€Œå› å¾Œæ‚”è€Œå›°æ–¼æ™‚é–“è¿´åœˆçš„è€äººã€` |
| **F** | `targetRecipe` | ç›®æ¨™æ–™ç† | `lamb_soup_grandma` |
| **G** | `difficulty` | é›£åº¦ç­‰ç´šï¼ˆæ±ºå®šæ¨™ç±¤æ•¸é‡è¦æ±‚ï¼‰ | `1` / `2` / `3` |
| **H** | `unlockCondition` | è§£é–æ¢ä»¶ï¼ˆè‹¥éåˆå§‹éˆé­‚ï¼‰ | `{"completedGuests":3}` |

**ä¼åŠƒç”¨é€”**ï¼š
- æ–°å¢éˆé­‚æ™‚ï¼Œåªéœ€åœ¨æ­¤è¡¨æ–°å¢ä¸€è¡Œï¼Œç³»çµ±è‡ªå‹•è­˜åˆ¥
- æ”¯æ´ã€Œéš±è—éˆé­‚ã€æ©Ÿåˆ¶ï¼ˆéœ€å®Œæˆç‰¹å®šæ¢ä»¶è§£é–ï¼‰

---

## ğŸ”„ æ ¸å¿ƒæµç¨‹çš„ä»£ç¢¼æ˜ å°„

### æµç¨‹ 1ï¼šä¾›å¥‰æ–™ç†ï¼ˆDay 1 äº’å‹•ï¼‰

**ä¼åŠƒæè¿°**ï¼šã€Œç©å®¶é»æ“Šã€çµ¦ä»–ç†±èŒ¶ã€ï¼Œéˆé­‚å›æ‡‰ä¸¦è§¸ç™¼ã€æº«æš–ã€æ¨™ç±¤ã€

**ä»£ç¢¼æµç¨‹**ï¼š
```javascript
// 1. æ¥æ”¶ç©å®¶é¸æ“‡
if (userMsg === "[è¡Œå‹•-ç†±èŒ¶]") {
  
  // 2. æŸ¥è©¢å°æ‡‰çš„å°è©
  const dialogue = findDialogue("guest1_day1_tea");
  
  // 3. æ›´æ–°ç©å®¶æ¨™ç±¤ï¼ˆD æ¬„ï¼‰
  const currentTags = JSON.parse(userSheet.getRange(userRow, 4).getValue());
  currentTags.push("warmth");
  userSheet.getRange(userRow, 4).setValue(JSON.stringify(currentTags));
  
  // 4. æ›´æ–°æœ€å¾Œäº’å‹•æ™‚é–“ï¼ˆE æ¬„ï¼‰
  userSheet.getRange(userRow, 5).setValue(new Date());
  
  // 5. å›å‚³ Flex Message
  replyFlexMessage(replyToken, {
    type: "bubble",
    body: {
      type: "box",
      layout: "vertical",
      contents: [
        { type: "text", text: dialogue.content, wrap: true },
        { type: "text", text: "âœ¨ ä½ æ•æ‰åˆ°äº†ã€Œæº«æš–ã€çš„è¨˜æ†¶ç¢ç‰‡ã€‚", color: "#FFD700", size: "sm" }
      ]
    }
  });
}
```

**å½±éŸ¿çš„è³‡æ–™æ¬„ä½**ï¼š
- âœ… `userState.D`ï¼ˆcollectedTagsï¼‰
- âœ… `userState.E`ï¼ˆlastActiveï¼‰
- âœ… `dialogueLibrary.A`ï¼ˆæŸ¥è©¢ keyï¼‰

---

### æµç¨‹ 2ï¼šè¨˜æ†¶è€ƒå¤ï¼ˆDay 2 å›æ†¶è§¸ç™¼ï¼‰

**ä¼åŠƒæè¿°**ï¼šã€Œç•¶ç©å®¶æ“æœ‰ã€æº«æš–ã€+ã€æŸ”è»Ÿã€æ¨™ç±¤æ™‚ï¼Œè‡ªå‹•è§¸ç™¼å¥¶å¥¶çš„å›æ†¶å ´æ™¯ã€

**ä»£ç¢¼æµç¨‹**ï¼š
```javascript
// Day 2 é–‹å§‹æ™‚è‡ªå‹•è§¸ç™¼
function checkDay2Unlock(userId) {
  const userTags = JSON.parse(userSheet.getRange(userRow, 4).getValue());
  
  // å®šç¾©è¨˜æ†¶è§¸ç™¼æ¢ä»¶
  const memoryConditions = {
    "memory_grandma": ["warmth", "softness"],
    "memory_divorce": ["salty", "rain"]
  };
  
  // æª¢æŸ¥å“ªå€‹è¨˜æ†¶è¢«è§£é–
  for (let memoryKey in memoryConditions) {
    const required = memoryConditions[memoryKey];
    if (required.every(tag => userTags.includes(tag))) {
      
      // è§£é–å°æ‡‰çš„æ–™ç†ï¼ˆF æ¬„ï¼‰
      const recipeID = getRecipeByMemory(memoryKey);
      userSheet.getRange(userRow, 6).setValue(recipeID);
      
      // åˆ‡æ›éšæ®µåˆ° memoryï¼ˆG æ¬„ï¼‰
      userSheet.getRange(userRow, 7).setValue("memory");
      
      // ç™¼é€è¨˜æ†¶åŠ‡æƒ…
      sendMemoryFlashback(userId, memoryKey);
      return;
    }
  }
  
  // è‹¥ç„¡åŒ¹é…ï¼Œæç¤ºç©å®¶ Day 1 æ¨™ç±¤ä¸è¶³
  sendMessage(userId, "éˆé­‚ä¾ç„¶é™·å…¥è¿·èŒ«...ä¹Ÿè¨±éœ€è¦æ›´å¤šç·šç´¢ï¼Ÿ");
}
```

**å½±éŸ¿çš„è³‡æ–™æ¬„ä½**ï¼š
- âœ… `userState.D`ï¼ˆè®€å– collectedTagsï¼‰
- âœ… `userState.F`ï¼ˆå¯«å…¥ unlockedRecipeï¼‰
- âœ… `userState.G`ï¼ˆæ›´æ–° phaseï¼‰

---

### æµç¨‹ 3ï¼šè¶…æ¸¡é€²åº¦ï¼ˆDay 3 çµå±€åˆ¤å®šï¼‰

**ä¼åŠƒæè¿°**ï¼šã€Œæ ¹æ“šæ”¶é›†çš„æ¨™ç±¤æ•¸é‡èˆ‡çƒ¹é£ªçµæœï¼Œæ±ºå®šã€å®Œç¾çµå±€ã€æˆ–ã€æ™®é€šçµå±€ã€ã€

**ä»£ç¢¼æµç¨‹**ï¼š
```javascript
function determineFarewell(userId) {
  const userTags = JSON.parse(userSheet.getRange(userRow, 4).getValue());
  const cookedRecipe = userSheet.getRange(userRow, 6).getValue();
  
  // çµå±€åˆ¤å®šé‚è¼¯
  let ending = "normal";
  
  if (userTags.length >= 5 && cookedRecipe !== "") {
    ending = "perfect"; // å®Œç¾çµå±€ï¼šæ”¶é›†å®Œæ•´è¨˜æ†¶ + æˆåŠŸçƒ¹é£ª
  } else if (cookedRecipe !== "") {
    ending = "normal"; // æ™®é€šçµå±€ï¼šæˆåŠŸçƒ¹é£ªä½†è¨˜æ†¶ä¸å®Œæ•´
  } else {
    ending = "bad"; // å¤±æ•—çµå±€ï¼šæœªèƒ½å®Œæˆæ–™ç†
  }
  
  // ç™¼é€å°æ‡‰çš„å‘Šåˆ¥åŠ‡æƒ…
  const farewellScript = getDialogue(`guest1_farewell_${ending}`);
  sendFlexCarousel(userId, farewellScript);
  
  // æ›´æ–°å®Œæˆç‹€æ…‹ï¼ˆI æ¬„ï¼‰
  const completed = JSON.parse(userSheet.getRange(userRow, 9).getValue() || "[]");
  completed.push("guest1");
  userSheet.getRange(userRow, 9).setValue(JSON.stringify(completed));
  
  // æ–°å¢éºç‰©ï¼ˆå¯«å…¥ heirlooms sheetï¼‰
  addHeirloom(userId, "guest1", "recipe_card_1");
}
```

**å½±éŸ¿çš„è³‡æ–™æ¬„ä½**ï¼š
- âœ… `userState.D`ï¼ˆè®€å– collectedTags æ•¸é‡ï¼‰
- âœ… `userState.F`ï¼ˆè®€å– unlockedRecipeï¼‰
- âœ… `userState.I`ï¼ˆå¯«å…¥ completedGuestsï¼‰
- âœ… `heirlooms.A-G`ï¼ˆæ–°å¢ä¸€è¡Œéºç‰©è¨˜éŒ„ï¼‰

---

## ğŸ¨ è¦–è¦ºå›é¥‹çš„æŠ€è¡“æ˜ å°„

### å¤–éƒ¨ç¶²é è¦–è¦ºæ¨£è²Œï¼ˆæœªä¾†æ“´å……ï¼‰

**ä¼åŠƒéœ€æ±‚**ï¼šã€Œç•¶ç©å®¶ä¾›å¥‰ä¸åŒæƒ…ç·’çš„æ–™ç†æ™‚ï¼Œé£Ÿå ‚çš„å¤–è§€æœƒæ”¹è®Šã€

**æŠ€è¡“æ–¹æ¡ˆ**ï¼š
1. **LIFF åµŒå…¥å¼ç¶²é **ï¼š
   - è®€å– `userState.C`ï¼ˆcurrentMoodï¼‰
   - å‹•æ…‹æ”¹è®Š CSS è®Šæ•¸ï¼ˆå¦‚èƒŒæ™¯è‰²ã€BGMï¼‰
   
2. **ç¯„ä¾‹ä»£ç¢¼**ï¼š
```javascript
// LIFF ç¶²é çš„ JavaScript
liff.init({ liffId: 'YOUR_LIFF_ID' }).then(() => {
  liff.getProfile().then(profile => {
    const userId = profile.userId;
    
    // å¾å¾Œç«¯ API è®€å– userState
    fetch(`https://script.google.com/macros/s/.../exec?userId=${userId}`)
      .then(res => res.json())
      .then(data => {
        const mood = data.currentMood; // "happy" / "sad" / "angry"
        
        // æ ¹æ“šæƒ…ç·’æ”¹è®Šè¦–è¦º
        document.body.className = `theme-${mood}`;
        
        if (mood === "sad") {
          document.getElementById("canteen").style.filter = "grayscale(0.5)";
        }
      });
  });
});
```

**ä¼åŠƒ-è¦–è¦ºæ˜ å°„è¡¨**ï¼š

| currentMood | èƒŒæ™¯è‰²èª¿ | BGM | é£Ÿå ‚è£é£¾ |
|-------------|---------|-----|---------|
| `happy` | æš–æ©˜è‰² | è¼•å¿«çš„å‰ä»– | å‘æ—¥è‘µç›†æ ½ |
| `sad` | å†·è—è‰² | ç·©æ…¢çš„é‹¼ç´ | æ¯èçš„èŠ± |
| `angry` | æ·±ç´…è‰² | ä½æ²‰çš„é¼“è² | è£‚é–‹çš„ç¢— |
| `neutral` | ç±³ç™½è‰² | ç’°å¢ƒéŸ³ | ä¹¾æ·¨æ¡Œé¢ |

---

## âš ï¸ å¸¸è¦‹å•é¡Œï¼šä¼åŠƒèˆ‡æŠ€è¡“çš„é´»æº

### Q1ï¼šä¼åŠƒèªªã€Œéˆé­‚æœƒè¨˜ä½ç©å®¶çš„é¸æ“‡ã€ï¼Œé€™å¦‚ä½•å¯¦ç¾ï¼Ÿ
**A**ï¼šé€é `userState.D`ï¼ˆcollectedTagsï¼‰ã€‚æ¯æ¬¡ç©å®¶é¸æ“‡éƒ½æœƒæ–°å¢æ¨™ç±¤ï¼Œå¾ŒçºŒå°è©±æœƒæª¢æŸ¥é€™äº›æ¨™ç±¤ä¾†æ±ºå®šå›æ‡‰å…§å®¹ã€‚

**ç¯„ä¾‹**ï¼š
- Day 1 é¸æ“‡ã€Œçµ¦ç†±èŒ¶ã€ â†’ æ–°å¢ `["warmth"]`
- Day 2 éˆé­‚å°è©±æœƒæª¢æŸ¥ï¼š`if (userTags.includes("warmth"))` â†’ è§¸ç™¼ã€ŒèŒ¶ã€ç›¸é—œè¨˜æ†¶

---

### Q2ï¼šä¼åŠƒèªªã€ŒDay 2 çš„å°è©±è¦æ ¹æ“š Day 1 çš„çµæœè®ŠåŒ–ã€ï¼Œå¦‚ä½•é¿å…å¯«æ­»æ‰€æœ‰çµ„åˆï¼Ÿ
**A**ï¼šä½¿ç”¨ã€Œæ¨™ç±¤çµ„åˆæ˜ å°„è¡¨ã€è€Œéçª®èˆ‰æ‰€æœ‰å¯èƒ½å°è©±ã€‚

**ä¸å¥½çš„è¨­è¨ˆ**ï¼ˆçª®èˆ‰ï¼‰ï¼š
```
day2_warmth â†’ "ä½ çµ¦éæˆ‘ç†±èŒ¶"
day2_softness â†’ "ä½ çµ¦éæˆ‘æ¯›æ¯¯"
day2_warmth_softness â†’ "ä½ çµ¦éæˆ‘ç†±èŒ¶å’Œæ¯›æ¯¯"
day2_warmth_salty â†’ "..."
```

**å¥½çš„è¨­è¨ˆ**ï¼ˆæ¨™ç±¤é©…å‹•ï¼‰ï¼š
```javascript
// å‹•æ…‹çµ„åˆå°è©±
let response = "æˆ‘è¨˜å¾—";
if (userTags.includes("warmth")) response += "é‚£æ¯èŒ¶çš„æº«æš–";
if (userTags.includes("softness")) response += "å’Œæ¯›æ¯¯çš„æŸ”è»Ÿ";
response += "ã€‚";
```

---

### Q3ï¼šä¼åŠƒèªªã€Œè¦æœ‰ 10 å€‹ä¸åŒçš„éˆé­‚æ•…äº‹ã€ï¼Œéœ€è¦æ”¹å¤šå°‘ä»£ç¢¼ï¼Ÿ
**A**ï¼šå¹¾ä¹ä¸ç”¨æ”¹ä»£ç¢¼ï¼Œåªéœ€åœ¨ `guestConfig` å’Œ `dialogueLibrary` æ–°å¢è³‡æ–™ã€‚

**æ­¥é©Ÿ**ï¼š
1. åœ¨ `guestConfig` æ–°å¢ä¸€è¡Œï¼š`guest10`
2. åœ¨ `dialogueLibrary` æ–°å¢ä»¥ `guest10_` é–‹é ­çš„å°è©
3. åœ¨ `recipeDatabase` æ–°å¢å°æ‡‰çš„æ–™ç†

ç³»çµ±æœƒè‡ªå‹•è­˜åˆ¥ä¸¦å¥—ç”¨ç›¸åŒçš„æµç¨‹é‚è¼¯ã€‚

---

## ğŸš¨ æŠ€è¡“å‚µå‹™è­¦ç¤º

### ç•¶å‰æ¶æ§‹çš„ä¸‰å¤§æŠ€è¡“å‚µ

#### å‚µå‹™ 1ï¼šç¨‹å¼ç¢¼ç‰ˆæœ¬è½å¾Œï¼ˆCriticalï¼‰
**ç—‡ç‹€**ï¼š`ç¨‹å¼ç¢¼.gs` ä»ä½¿ç”¨ Cloudy V1.4 çš„é‚è¼¯
**å½±éŸ¿**ï¼šç„¡æ³•æ”¯æ´ã€Œæ¨™ç±¤é©…å‹•å°è©±ã€èˆ‡ã€Œæ–™ç†åˆæˆã€
**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- [ ] é‡æ§‹ `doPost()` å‡½æ•¸ï¼Œæ”¯æ´ `guestID` è€Œé `day`
- [ ] æ–°å¢ `findMatchingDialogue()` å‡½æ•¸
- [ ] æ–°å¢ `canCookRecipe()` å‡½æ•¸

#### å‚µå‹™ 2ï¼šç¼ºå°‘æ™‚é–“æ¨é€²æ©Ÿåˆ¶ï¼ˆHighï¼‰
**ç—‡ç‹€**ï¼šç©å®¶å¯ä»¥ç„¡é™å°è©±ï¼Œç„¡æ³•å¼·åˆ¶éš”æ—¥è§£é–
**å½±éŸ¿**ï¼šç ´å£ã€Œæ¯æ—¥ä¸€é»é€²åº¦ã€çš„è¨­è¨ˆç¯€å¥
**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```javascript
function canProgressToNextDay(userId) {
  const lastActive = userSheet.getRange(userRow, 5).getValue();
  const now = new Date();
  
  // æª¢æŸ¥æ˜¯å¦å·²é 24 å°æ™‚
  const hoursPassed = (now - lastActive) / (1000 * 60 * 60);
  return hoursPassed >= 24;
}
```

#### å‚µå‹™ 3ï¼šç¼ºå°‘ Flex Message æ¨¡æ¿ï¼ˆMediumï¼‰
**ç—‡ç‹€**ï¼šæ‰€æœ‰å›è¦†éƒ½æ˜¯ç´”æ–‡å­—ï¼Œç¼ºä¹è¦–è¦ºè¡æ“Š
**å½±éŸ¿**ï¼šæƒ…æ„Ÿæ·±åº¦ä¸è¶³ï¼Œç©å®¶å®¹æ˜“è·³å‡º
**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- [ ] å»ºç«‹ `flexTemplates.js` å‡½æ•¸åº«
- [ ] è¨­è¨ˆ 3 ç¨®æ ¸å¿ƒæ¨¡æ¿ï¼šäººç‰©å¡ã€è¨˜æ†¶åŠ‡å ´ã€éºç‰©å¡

---

## ğŸ“‹ é–‹ç™¼æª¢æŸ¥æ¸…å–®ï¼šå¾ä¼åŠƒåˆ°ä¸Šç·š

### Phase 1ï¼šè³‡æ–™çµæ§‹æ­å»ºï¼ˆæœ¬é€±ï¼‰
- [ ] æ“´å…… `userState` è‡³ 10 æ¬„ï¼ˆA-Jï¼‰
- [ ] å»ºç«‹ `recipeDatabase` sheet
- [ ] å»ºç«‹ `heirlooms` sheet
- [ ] å»ºç«‹ `guestConfig` sheet

### Phase 2ï¼šæ ¸å¿ƒå‡½æ•¸é–‹ç™¼ï¼ˆä¸‹é€±ï¼‰
- [ ] å¯¦ä½œ `findMatchingDialogue()`
- [ ] å¯¦ä½œ `canCookRecipe()`
- [ ] å¯¦ä½œ `addHeirloom()`
- [ ] å¯¦ä½œ `determineFarewell()`

### Phase 3ï¼šåŠ‡æœ¬å¡«å……ï¼ˆç¬¬ä¸‰é€±ï¼‰
- [ ] å®Œæˆ Guest 1 å®Œæ•´åŠ‡æœ¬ï¼ˆ3å¤© Ã— 20 å€‹å°è©±ç¯€é»ï¼‰
- [ ] è¨­è¨ˆ 5 ç¨®æ„Ÿå®˜æ¨™ç±¤çµ„åˆçš„åˆ†æ”¯
- [ ] æ’°å¯« 3 ç¨®çµå±€çš„å‘Šåˆ¥åŠ‡æƒ…

### Phase 4ï¼šè¦–è¦ºåŒ–èˆ‡æ¸¬è©¦ï¼ˆç¬¬å››é€±ï¼‰
- [ ] è¨­è¨ˆ Flex Message æ¨¡æ¿
- [ ] æ­å»º LIFF çƒ¹é£ªå°éŠæˆ²åŸå‹
- [ ] é€²è¡Œå°é–‰æ¸¬è©¦ï¼ˆ10 åç©å®¶ï¼‰

---

## ğŸ”— ç›¸é—œæ–‡ä»¶ç´¢å¼•

- [[é–‹ç™¼æ±ºç­–éˆ]] - ç†è§£ç‚ºä½•åšé€™äº›æ±ºå®š
- [[éˆé­‚è€ƒå¤_3æ—¥é‚è¼¯éˆ]] - åŠ‡æœ¬è¨­è¨ˆè—åœ–
- [[éˆé­‚é£Ÿå ‚ä¼åŠƒï¼šæ–™ç†èˆ‡æ•‘è´–]] - ä¼åŠƒæºé ­
- `ç¨‹å¼ç¢¼.gs` - ç•¶å‰ä»£ç¢¼å¯¦ç¾

---

**æ–‡ä»¶ç‹€æ…‹**ï¼šğŸŸ¢ Active  
**æ›´æ–°é »ç‡**ï¼šæ¯æ¬¡ Sprint çµæŸå¾Œ  
**ç¶­è­·è²¬ä»»**ï¼šæŠ€è¡“ Lead + ä¼åŠƒ Lead å…±åŒç¶­è­·  
**æœ€å¾Œæ›´æ–°**ï¼š2026-01-15
