# 專案實作對照表：靈魂食堂的敘事-技術映射手冊

> **文件性質**：開發聖經（Dev Bible）  
> **目標讀者**：開發者、劇本編寫者、測試人員  
> **維護原則**：企劃概念更新時，此表必須同步更新  
> **建立日期**：2026-01-15  
> **最後更新**：2026-02-08（V4.15 劇本擴增收尾；getDay2IdleLine 新增，無新欄位）

---

## 🎯 文件目的

本文件解決「企劃」與「代碼」之間的**語義鴻溝**。  
當企劃說「供奉料理」時，開發者必須知道這對應到哪個資料欄位、觸發哪個函數。  
當代碼拋出錯誤時，企劃必須知道這影響哪個敘事環節。

---

## 📊 核心資料結構映射

### 一、Google Sheets 架構總覽

```
SPREADSHEET: "靈魂食堂 - 田中太郎版" 
└── Sheet 1: userStateTanaka (玩家狀態) ← 唯一需要的工作表
```

**設計原則**：單表設計，所有玩家資料在同一行，不需要跨表查詢。

---

### 二、userStateTanaka Sheet：玩家狀態追蹤表（V4.8 版本）

#### 完整欄位定義

| 欄位 | 變數名 | 資料型態 | 企劃概念 | 範例值 | 更新時機 |
|------|--------|----------|----------|--------|----------|
| **A** | `userId` | String | 玩家的 LINE UID | `U1234567890abcdef` | 首次加入時 |
| **B** | `currentDay` | Integer (1-3) | 當前是第幾天 | `2` | 每天結束時 |
| **C** | `phase` | Enum | 當前階段 | `night`/`day`/`cooking`/`after` | 階段切換時 |
| **D** | `collectedMemories` | JSON Array | 已收集的記憶食材 | `["針","縫線","寒冷"]` | 對話選擇後 |
| **E** | `topicsDone` | JSON Array | 已完成的話題 | `["hands_part1","origin"]` | 話題完成時 |
| **F** | `lastActive` | Timestamp | 最後互動時間戳（記錄／分析用，非進度門檻） | `2026-01-28 10:30:00` | 每次互動 |
| **G** | `dishesCooked` | JSON Array | 本輪做過的料理 | `["蜜汁燉菜","苦辛醒神湯"]` | 料理完成時 |
| **H** | `lifetimeHeirlooms` | JSON Object | 永久遺物記錄（跨輪次） | 見下方範例 | 結局達成時 |

#### lifetimeHeirlooms 結構範例

```json
{
  "BITTER": { 
    "obtained": true, 
    "name": "彎曲的針", 
    "desc": "一根被用力折彎的縫紉針...", 
    "date": "2026-01-28" 
  },
  "SWEET": { 
    "obtained": false, 
    "name": "???", 
    "desc": "", 
    "date": "" 
  },
  "BALANCED": { 
    "obtained": true, 
    "name": "銀頂針", 
    "desc": "泛著銀光的舊頂針...", 
    "date": "2026-01-27" 
  }
}
```

**策略 A（覆蓋制）**：同一結局類型的不同變體會覆蓋舊描述，顯示最新獲得的版本。

---

### 三、階段系統（Phase System）

#### 時段定義

```javascript
const PHASE = {
  NIGHT: "night",      // 夜晚：觀察階段
  DAY: "day",          // 白天：對話階段（話題選擇）
  COOKING: "cooking",  // 傍晚：料理階段
  AFTER: "after"       // 深夜：揭露/結束階段
};
```

#### 階段流程

```
Day 1: NIGHT → DAY → COOKING → AFTER
Day 2: (從 DAY 開始) → COOKING → AFTER
Day 3: (從 COOKING 開始) → AFTER → 結局
```

---

### 四、五味系統（Flavor System）

#### 五味數值對照表

```javascript
const MEMORY_FLAVOR_MAP = {
  // Day 1 基礎記憶
  "針":       { sweet: 0, sour: 1, bitter: 2, spicy: 0, salty: 1 },
  "縫線":     { sweet: 1, sour: 0, bitter: 1, spicy: 0, salty: 2 },
  "寒冷":     { sweet: 0, sour: 2, bitter: 2, spicy: 1, salty: 0 },
  "裁縫手藝": { sweet: 3, sour: 0, bitter: 1, spicy: 0, salty: 2 },
  
  // Day 2 進階記憶
  "蜜糖笑容": { sweet: 3, sour: 0, bitter: 0, spicy: 0, salty: 1 },
  "執念":     { sweet: 0, sour: 1, bitter: 3, spicy: 0, salty: 1 },
  "死亡":     { sweet: 0, sour: 2, bitter: 3, spicy: 0, salty: 0 },
  
  // V4.5 變體記憶（劇本昇華三痛點）
  "銀座的驕傲": { sweet: 1, sour: 0, bitter: 1, spicy: 0, salty: 3 },
  "缺席的典禮": { sweet: 0, sour: 1, bitter: 3, spicy: 3, salty: 0 },
  "失語":       { sweet: 0, sour: 3, bitter: 1, spicy: 0, salty: 2 },
  "空蕩的店":   { sweet: 0, sour: 2, bitter: 1, spicy: 0, salty: 3 }
};
```

#### 結局判定邏輯（V4.9 更新）

```javascript
function determineEnding(flavors) {
  const { sweet, sour, bitter, spicy, salty } = flavors;
  const others = sour + bitter + spicy + salty;
  
  // 情境 C：甜味過重（沉浸美好）- 優先判定
  if (sweet > others) return "ENDING_SWEET";
  
  // 情境 A：苦味過重（帶遺憾）
  if (bitter > (sweet + salty)) return "ENDING_BITTER";
  
  // 情境 B：回甘平衡（釋懷）
  return "ENDING_BALANCED";
}
```

---

## 🔄 核心函數映射

### 一、狀態管理函數

| 函數名 | 用途 | 企劃對應 |
|--------|------|----------|
| `getUserState(userId)` | 讀取玩家狀態 | 讀取存檔 |
| `updateUserState(userId, updates)` | 更新玩家狀態 | 存檔 |
| `initializeUser(userId)` | 初始化新玩家 | 新遊戲 |
| `resetUser(userId)` | 重置（保留遺物） | 重新開始 |

### 二、階段處理函數

| 函數名 | 階段 | 企劃對應 |
|--------|------|----------|
| `handleDay1Night()` | Day 1 Night | 觀察老人 |
| `handleDay1Day()` | Day 1 Day | 與老人對話 |
| `handleDay1Cooking()` | Day 1 Cooking | 製作熱茶/熱湯 |
| `handleDay2Day()` | Day 2 Day | 深入對話 |
| `handleDay2Cooking()` | Day 2 Cooking | 製作進階料理 |
| `handleDay3Cooking()` | Day 3 Cooking | 最終料理 |
| `handleDay3Ending()` | Day 3 After | 結局演出 |

### 三、Flex Message 生成函數

| 函數名 | 用途 | UI 對應 |
|--------|------|---------|
| `getDay1DayShift(state)` | Day 1 話題選單 | 動態按鈕卡片 |
| `getDay2DayShift(state)` | Day 2 話題選單 | 動態按鈕卡片 |
| `getDay1CookingScene(state)` | Day 1 廚房介面 | 料理選項卡片 |
| `getDay2CookingScene(state)` | Day 2 廚房介面 | 動態料理選項 |
| `getDay3CookingStart(state)` | Day 3 廚房介面 | 動態最終料理選項（V4.9） |
| `getDay3Farewell(state, userId)` | 結局畫面 | 遺物卡片 + 告別對話 |

### 三-A、料理演出函數（V4.10 動態化）

**設計原則**：有啥食材顯示啥 - 從玩家實際收集的記憶中，篩選出與該料理相關的記憶來顯示。

| 函數名 | Day | 相關記憶池 | 說明 |
|--------|-----|------------|------|
| `getDay1CookingTea_Part1(state)` | 1 | 針/縫線/寒冷/寧靜/陪伴 | 熱茶演出 |
| `getDay1CookingSoup_Part1(state)` | 1 | 雨聲/失憶/迷茫 | 熱湯演出 |
| `getDay2CookingResult(state)` | 2 | 蜜糖笑容/眼淚 | 蜜汁燉菜演出 |
| `getDay2CookingResult_苦辛(state)` | 2 | 執念/雪/死亡 | 苦辛醒神湯演出（含 Flex Card） |
| `getDay2CookingResult_撫慰()` | 2 | 寧靜/陪伴 | 撫慰鹹粥演出 |
| `getDay3CookingProcess_Part1(state)` | 3 | 全部記憶 | 最終料理演出 Part 1 |
| `getDay3CookingProcess_Part2(state)` | 3 | 全部記憶 | 最終料理演出 Part 2 |
| `getDay3CookingMemoryCard(state)` | 3 | 全部記憶 | 黑貓評論卡片 |

### 三-B、料理解鎖條件（V4.10）

完整的料理食譜系統設計庫，詳見：[[../../00-核心企劃/當前專案_靈魂食堂/靈魂食堂：最終開發執行企劃書#五-A、料理食譜系統（結構設計庫）|企劃書「五-A、料理食譜系統」章節]]

| Day | 料理 | 解鎖條件 |
|-----|------|----------|
| 1 | ☕ 熱茶 | 寒冷 OR 針 OR 縫線 OR (寧靜+陪伴) |
| 1 | 🍜 熱湯 | 雨聲 OR 失憶 OR 迷茫 |
| 2 | 🍜 蜜汁燉菜 | 蜜糖笑容 + 眼淚 |
| 2 | 🥣 苦辛醒神湯 | 執念 + (雪 OR 死亡) |
| 2 | 🍚 撫慰鹹粥 | 寧靜 + 陪伴 |
| 3 | 🍬 糖霜幻景拼盤 | 系統判定：甜味 > 其他四味 |
| 3 | 🦴 千針冷骨湯 | 系統判定：苦味 > (甜味+鹹味) |
| 3 | 🐟 百味蜜汁炙燒魚 | 系統判定：平衡 |

### 四、Rich Menu 處理函數（V4.8 新增）

| 函數名 | Postback/文字 | 用途 | 攔截機制 |
|--------|---------------|------|----------|
| `handleOpenBio()` | `OPEN_BIO` / `/menu bio` | 人物紀傳 | ✅ 遊戲中攔截 |
| `handleOpenHeirloom()` | `OPEN_HEIRLOOM` / `/menu heirloom` | 遺物圖鑑 | ✅ 遊戲中攔截 |
| `handleOpenStatus()` | `OPEN_STATUS` / `/menu status` | 靈魂狀態 | ❌ 隨時可開 |
| `handleOpenHelp()` | `OPEN_HELP` / `/menu help` | 遊戲說明 | ❌ 隨時可開 |
| `restoreGameScreen()` | `RESUME_GAME` | 回程票 | - |

### 五、輔助函數

| 函數名 | 用途 |
|--------|------|
| `calculateFlavorBalance(memories)` | 計算五味總和 |
| `determineEnding(flavors)` | 判定結局類型 |
| `getHeirloomName(endingType, memories, isFullCollection)` | 生成遺物名稱 |
| `getHeirloomDesc(endingType, memories, isFullCollection)` | 生成遺物描述 |
| `saveHeirloomToLifetime(userId, state, endingType, name, desc)` | 儲存遺物到圖鑑 |
| `showLoadingAnimation(userId, seconds)` | 顯示「正在輸入」動畫 |
| `pushMessages(userId, messages)` | 批量推送訊息（最多 5 則） |
| `getFlavorBar(value, max)` | 生成五味進度條 |
| `getDay2IdleLine(topicsDone)` | 依 topicsDone 回傳老人 idle 台詞（目的二：呼吸點） |

---

## 🎮 遊戲流程對照

### Day 1 流程

```
玩家進入 → NIGHT（觀察）
    ↓
點擊「觀察他」→ 開場劇情 → 進入 DAY
    ↓
DAY（話題選擇）：
  - 「你的手」→ 收集「針」「縫線」
  - 「你從哪裡來」→ 收集「失憶」「迷茫」
  - 「窗外的雨」→ 收集「雨聲」「潮濕」
  - 「沉默陪伴」→ 收集「寧靜」「陪伴」
  
  延伸話題（解鎖後）：
  - 「最驕傲的事」→ 收集「銀座的驕傲」「裁縫手藝」
  - 「後來呢」→ 收集「空蕩的店」
    ↓
點擊「進入廚房」→ COOKING
    ↓
COOKING（料理選擇）：
  - 「做熱茶」→ 收集「溫暖」
  - 「做熱湯」→ 收集「清醒」
    ↓
料理完成 → AFTER → 進入 Day 2
```

### Day 2-3 流程（V4.9-V4.10 更新）

```
Day 2 DAY：更多話題（夢境、尋找、死亡）
    ↓
Day 2 COOKING：進階料理（蜜汁燉菜、苦辛醒神湯、撫慰鹹粥）
    ↓
Day 3 COOKING：最終料理（根據五味傾向動態決定）
  - 🍬 甜味過重 → 糖霜幻景拼盤
  - 🦴 苦味過重 → 千針冷骨湯
  - 🐟 平衡 → 百味蜜汁炙燒魚
    ↓
Day 3 AFTER：結局演出 → 計算五味 → 判定結局 → 獲得遺物 → 解鎖紀傳
```

### 結局與人物紀傳對照（V4.9 更新）

| 結局類型 | 判定條件 | Day 3 料理 | 遺物 | 解鎖紀傳 |
|----------|----------|-----------|------|----------|
| 🍬 **SWEET**（甜味過重） | `sweet > others` | 糖霜幻景拼盤 | 泛黃的照片 | 前篇：針尖工房與雪子 |
| 🦴 **BITTER**（苦味過重） | `bitter > (sweet + salty)` | 千針冷骨湯 | 彎曲的縫紉針 | 中篇：裂痕與遺忘 |
| 🐟 **BALANCED**（回甘平衡） | 其他情況 | 百味蜜汁炙燒魚 | 銀頂針 | 後篇：最後一針 |

**紀傳檔案**：
- `02-劇本設計/田中太郎_人生紀實_前篇.md` - 銀座的驕傲、雪子的愛
- `02-劇本設計/田中太郎_人生紀實_中篇.md` - 缺席的典禮、父女裂痕
- `02-劇本設計/田中太郎_人生紀實_後篇.md` - 最後一針、釋懷

---

## 📱 Rich Menu UX 設計（V4.8）

### 分級管制機制

| 類型 | 按鈕 | 遊戲中行為 | 結局後行為 |
|------|------|-----------|-----------|
| **沉浸破壞型** | 📖 人物紀傳 | 黑貓攔截 | 正常顯示 |
| **沉浸破壞型** | 🎁 遺物圖鑑 | 黑貓攔截 | 正常顯示 |
| **工具輔助型** | 📊 靈魂狀態 | 正常顯示 | 正常顯示 |
| **工具輔助型** | ❓ 遊戲說明 | 正常顯示 | 正常顯示 |

### 回程票系統

```javascript
// 當玩家查看圖鑑後，點擊「回到遊戲」
// restoreGameScreen() 會根據當前 phase 重新發送對應的遊戲畫面
switch (state.phase) {
  case PHASE.DAY:     return getDay1DayShift(state);    // 話題選單
  case PHASE.COOKING: return getDay1CookingScene(state); // 料理介面
  case PHASE.NIGHT:   return "準備好了就去開門吧";        // 提示文字
  case PHASE.AFTER:   return "您可以查看圖鑑...";        // 提示文字
}
```

---

## 🧪 Debug 指令集

### 基本指令

| 指令 | 功能 |
|------|------|
| `重新開始` / `restart` | 重置遊戲（保留遺物） |
| `狀態` / `status` | 查看當前狀態 |

### Rich Menu 測試指令

| 指令 | 功能 |
|------|------|
| `/debug richmenu` | 顯示所有 Rich Menu 測試指令 |
| `/debug bio` | 強制顯示人物紀傳（忽略攔截） |
| `/debug heirloom` | 強制顯示遺物圖鑑（忽略攔截） |
| `/debug status` | 顯示靈魂狀態面板 |
| `/debug help` | 顯示遊戲說明 |
| `/debug restore` | 測試回程票功能 |
| `/debug phase` | 顯示當前階段詳情 |
| `/debug setphase [day] [phase]` | 設定階段（如 `/debug setphase 2 cooking`） |

---

## 🔗 相關文件索引

- [[../../00-核心企劃/當前專案_靈魂食堂/靈魂食堂：最終開發執行企劃書]] - 專案全貌與設計
- [[../../00-核心企劃/開發決策鏈]] - 決策歷史
- [[部署與開發指南]] - 部署與技術文檔
- [[../../02-劇本設計/Guest1_田中太郎_重構版_神秘感優先]] - 完整劇本
- 
---

## 📋 版本歷史

| 版本 | 日期 | 更新內容 |
|------|------|----------|
| V1.0 | 2026-01-15 | 初版建立，多 Sheet 架構設計 |
| V4.8 | 2026-01-28 | 大幅重構：單 Sheet 架構、五味系統、Rich Menu UX |
| V4.9 | 2026-01-29 | Day 3 動態料理系統：三種最終料理、黑貓評論動態化 |
| V4.10 | 2026-01-30 | Day 1-2 料理演出動態化：統一「有啥食材顯示啥」設計 |
| V4.15 | 2026-02-06 | 劇本擴充設計原則與 Skill 建立；對話表常數 DIALOGUE_SHEET_NAME 修正 |
| V4.15 | 2026-02-08 | 劇本擴增收尾：Day 2 After 三分支、Day 2→3 過渡段、老人 idle（getDay2IdleLine）；無新欄位 |

---

**文件狀態**：🟢 Active  
**更新頻率**：每次重大功能更新後  
**維護責任**：技術 Lead + 企劃 Lead 共同維護  
**最後更新**：2026-02-08
